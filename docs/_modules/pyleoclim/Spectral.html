
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyleoclim.Spectral &#8212; Pyleoclim 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyleoclim.Spectral</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Apr 28 14:23:06 2017</span>

<span class="sd">@author: deborahkhider</span>

<span class="sd">Spectral module for pyleoclim</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">mquantiles</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">ScalarFormatter</span>

<span class="kn">from</span> <span class="nn">pathos.multiprocessing</span> <span class="k">import</span> <span class="n">ProcessingPool</span> <span class="k">as</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Timeseries</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Core functions below, focusing on algorithms</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="k">class</span> <span class="nc">WaveletAnalysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Performing wavelet analysis @author: fzhu</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">is_evenly_spaced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Check if a time axis is evenly spaced.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): the time axis of a time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            check (bool): True - evenly spaced; False - unevenly spaced.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">dt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">dt_mean</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)):</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">check</span>

    <span class="k">def</span> <span class="nf">ar1_fit_evenly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the lag-1 autocorrelation from ar1 fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): vector of (flaot) numbers as a time series</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            g (float): lag-1 autocorrelation coefficient</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
        <span class="n">ar1_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">AR</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxlag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_mod</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the processed time series using (detrend and) standardization.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            res (array): the processed time series</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">detrend</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">ys_d</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">detrend</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">ys_d</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ys_d</span> <span class="o">=</span> <span class="n">ys</span>

        <span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">ys_d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">tau_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the estimated persistence of a givenevenly/unevenly spaced time series.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            tau_est (float): the estimated persistence</span>

<span class="sd">        References:</span>
<span class="sd">            Mudelsee, M. TAUEST: A Computer Program for Estimating Persistence in Unevenly Spaced Weather/Climate Time Series.</span>
<span class="sd">                Comput. Geosci. 28, 69–72 (2002).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="c1">#  assert dt &gt; 0, &quot;The time points should be increasing!&quot;</span>

        <span class="k">def</span> <span class="nf">ar1_fun</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pd_ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">pd_ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="n">dt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">a_est</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">ar1_fun</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
        <span class="c1">#  a_est = optimize.minimize_scalar(ar1_fun, method=&#39;brent&#39;).x</span>

        <span class="n">tau_est</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a_est</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tau_est</span>

    <span class="k">def</span> <span class="nf">assertPositiveInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Assert that the args are all positive integers.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">ar1_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a time series with the AR1 process</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            tau (float): the averaged persistence</span>
<span class="sd">            n (int): the length of the AR1 process</span>

<span class="sd">        Returns:</span>
<span class="sd">            r (array): the AR1 time series</span>

<span class="sd">        References:</span>
<span class="sd">            Schulz, M. &amp; Mudelsee, M. REDFIT: estimating red-noise spectra directly from unevenly spaced</span>
<span class="sd">                paleoclimatic time series. Computers &amp; Geosciences 28, 421–426 (2002).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">scaled_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">tau</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">scaled_dt</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span> <span class="o">+</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">wwz_opt2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                    <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">weighted_phi2</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">weighted_phi3</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">ywave_2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">wwz_opt1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                    <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">cos_shift_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">sin_shift_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">weighted_phi2</span><span class="o">-</span><span class="n">weighted_one</span><span class="o">*</span><span class="n">cos_shift_one</span><span class="p">)</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">weighted_phi3</span><span class="o">-</span><span class="n">weighted_one</span><span class="o">*</span><span class="n">sin_shift_one</span><span class="p">)</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">ywave_2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">wwz_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">S_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

                    <span class="n">weighted_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">ywave_2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">wwz_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wwz_nproc() should use nproc &gt;= 2, if want serial run, please use wwz_basic()&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">wwa_1g</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">Neff_loc</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">Neff_loc</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                <span class="n">ywave_2_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">ywave_3_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">S_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

                <span class="n">weighted_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">ywave_2_1g</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                <span class="n">ywave_3_1g</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>

            <span class="k">return</span> <span class="n">Neff_loc</span><span class="p">,</span> <span class="n">ywave_2_1g</span><span class="p">,</span> <span class="n">ywave_3_1g</span>

        <span class="n">tf_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">list_of_grids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">tf_mesh</span><span class="p">)))</span>
        <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_grids</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wwa_1g</span><span class="p">,</span> <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span><span class="p">)</span>
            <span class="n">res_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">Neffs</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">ywave_2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">w_prod</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">sin_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">cos_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">one_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

                    <span class="n">sin_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">cos_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">sin_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>
                    <span class="n">sin_sin</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">sin_basis</span><span class="p">)</span>
                    <span class="n">cos_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>

                    <span class="n">numerator</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sin_cos</span> <span class="o">-</span> <span class="n">sin_one</span> <span class="o">*</span> <span class="n">cos_one</span><span class="p">)</span>
                    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_cos</span> <span class="o">-</span> <span class="n">cos_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sin_sin</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>  <span class="c1"># Eq. (S5)</span>

                    <span class="n">sin_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">cos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">sin_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="n">cos_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

                    <span class="n">ys_cos_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">cos_shift</span><span class="p">)</span>
                    <span class="n">ys_sin_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">sin_shift</span><span class="p">)</span>
                    <span class="n">ys_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">cos_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">sin_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>

                    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_cos_shift</span><span class="o">-</span><span class="n">ys_one</span><span class="o">*</span><span class="n">cos_shift_one</span><span class="p">)</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_sin_shift</span><span class="o">-</span><span class="n">ys_one</span><span class="o">*</span><span class="n">sin_shift_one</span><span class="p">)</span>

                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">-</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S6)</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S7)</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_opt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">w_prod</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">sin_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">cos_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">one_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

                    <span class="n">sin_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">cos_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">sin_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>
                    <span class="n">sin_sin</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">sin_basis</span><span class="p">)</span>
                    <span class="n">cos_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>

                    <span class="n">numerator</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sin_cos</span> <span class="o">-</span> <span class="n">sin_one</span> <span class="o">*</span> <span class="n">cos_one</span><span class="p">)</span>
                    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_cos</span> <span class="o">-</span> <span class="n">cos_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sin_sin</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>  <span class="c1"># Eq. (S5)</span>

                    <span class="n">sin_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">cos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">sin_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="n">cos_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

                    <span class="n">ys_cos_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">cos_shift</span><span class="p">)</span>
                    <span class="n">ys_sin_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">sin_shift</span><span class="p">)</span>

                    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ys_cos_shift</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">ys_sin_shift</span>

                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">-</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S6)</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S7)</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wwz_nproc() should use nproc &gt;= 2, if want serial run, please use wwz_basic()&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">wwa_1g</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">Neff_loc</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Neff_loc</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                <span class="n">a1_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                <span class="n">a2_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">w_prod</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">sin_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">cos_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">one_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

                <span class="n">sin_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">cos_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">sin_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>
                <span class="n">sin_sin</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">sin_basis</span><span class="p">)</span>
                <span class="n">cos_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>

                <span class="n">numerator</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sin_cos</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">*</span><span class="n">cos_one</span><span class="p">)</span>
                <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_cos</span> <span class="o">-</span> <span class="n">cos_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sin_sin</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="p">)</span>  <span class="c1"># Eq. (S5)</span>

                <span class="n">sin_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                <span class="n">cos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                <span class="n">sin_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">))</span>
                <span class="n">cos_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">))</span>

                <span class="n">ys_cos_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">cos_shift</span><span class="p">)</span>
                <span class="n">ys_sin_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">sin_shift</span><span class="p">)</span>
                <span class="n">ys_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">cos_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">sin_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>

                <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_cos_shift</span> <span class="o">-</span> <span class="n">ys_one</span><span class="o">*</span><span class="n">cos_shift_one</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_sin_shift</span> <span class="o">-</span> <span class="n">ys_one</span><span class="o">*</span><span class="n">sin_shift_one</span><span class="p">)</span>

                <span class="n">a1_1g</span> <span class="o">=</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">-</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S6)</span>
                <span class="n">a2_1g</span> <span class="o">=</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S7)</span>

            <span class="k">return</span> <span class="n">Neff_loc</span><span class="p">,</span> <span class="n">a1_1g</span><span class="p">,</span> <span class="n">a2_1g</span>

        <span class="n">tf_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">list_of_grids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">tf_mesh</span><span class="p">)))</span>
        <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_grids</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wwa_1g</span><span class="p">,</span> <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span><span class="p">)</span>
            <span class="n">res_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">Neffs</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_f2py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nproc</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">f2py_wwz</span> <span class="k">as</span> <span class="n">f2py</span>
        <span class="n">Neffs</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">f2py</span><span class="o">.</span><span class="n">f2py_wwz</span><span class="o">.</span><span class="n">wwa</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pd_ys</span><span class="p">,</span> <span class="n">nproc</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span>

        <span class="n">undef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99999.</span>
        <span class="n">a1</span><span class="p">[</span><span class="n">a1</span> <span class="o">==</span> <span class="n">undef</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">a2</span><span class="p">[</span><span class="n">a2</span> <span class="o">==</span> <span class="n">undef</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>

        <span class="n">coeff</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">make_coi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cone of influence.</span>

<span class="sd">        Args:</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            Neff (int): the threshold of the number of effective samples</span>

<span class="sd">        Returns:</span>
<span class="sd">            coi (array): cone of influence</span>

<span class="sd">        References:</span>
<span class="sd">            wave_signif() in http://paos.colorado.edu/research/wavelets/wave_python/waveletFunctions.py</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Neff</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Neff</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>

        <span class="n">fourier_factor</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">Neff</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">Neff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">coi_const</span> <span class="o">=</span> <span class="n">fourier_factor</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">nt_half</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt_half</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">coi</span> <span class="o">=</span> <span class="n">coi_const</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">C</span>

        <span class="k">return</span> <span class="n">coi</span>

    <span class="k">def</span> <span class="nf">wwa2psd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the power spectral density (PSD) using the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">            ts (array): the time points, should be pre-truncated so that the span is exactly what is used for wwz</span>
<span class="sd">            Neffs (array):  the matrix of effective number of points in the time-scale coordinates obtained from wwz from wwz</span>
<span class="sd">            freqs (array): vector of frequency from wwz</span>
<span class="sd">            Neff (int): the threshold of the number of effective samples</span>
<span class="sd">            anti_alias (bool): whether to apply anti-alias filter</span>
<span class="sd">            avgs (int): flag for whether spectrum is derived from instantaneous point measurements (avgs&lt;&gt;1)</span>
<span class="sd">                        OR from measurements averaged over each sampling interval (avgs==1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        References:</span>
<span class="sd">            Kirchner&#39;s C code for weighted psd calculation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">af</span> <span class="o">=</span> <span class="n">AliasFilter</span><span class="p">()</span>

        <span class="c1"># weighted psd calculation start</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>

        <span class="n">power</span> <span class="o">=</span> <span class="n">wwa</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Neffs</span>

        <span class="n">Neff_diff</span> <span class="o">=</span> <span class="n">Neffs</span> <span class="o">-</span> <span class="n">Neff</span>
        <span class="n">Neff_diff</span><span class="p">[</span><span class="n">Neff_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">sum_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">power</span> <span class="o">*</span> <span class="n">Neff_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sum_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Neff_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">sum_power</span> <span class="o">/</span> <span class="n">sum_eff</span>
        <span class="c1"># weighted psd calculation end</span>

        <span class="k">if</span> <span class="n">anti_alias</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;freqs is required for alias filter!&quot;</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="n">f_sampling</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">filtered_pwr</span><span class="p">,</span> <span class="n">model_pwer</span><span class="p">,</span> <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">alias_filter</span><span class="p">(</span>
                <span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">f_sampling</span><span class="p">,</span> <span class="n">f_sampling</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="n">avgs</span><span class="p">)</span>

            <span class="n">psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filtered_pwr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">freq_vector_lomb_scargle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ofac</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hifac</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the frequency vector based on the Lomb-Scargle algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            ofac (float): Oversampling rate that influences the resolution of the frequency axis,</span>
<span class="sd">                         when equals to 1, it means no oversamling (should be &gt;= 1).</span>
<span class="sd">                         The default value 4 is usaually a good value.</span>

<span class="sd">            hifac (float): fhi/fnyq (should be &gt;= 1), where fhi is the highest frequency that</span>
<span class="sd">                          can be analyzed by the Lomb-Scargle algorithm and fnyq is the Nyquist frequency.</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        References:</span>
<span class="sd">            Trauth, M. H. MATLAB® Recipes for Earth Sciences. (Springer, 2015). pp 181.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">ofac</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hifac</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;`ofac` should be &gt;= 1, and `hifac` should be &lt;= 1&quot;</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">flo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">*</span><span class="n">ofac</span><span class="p">)</span>
        <span class="n">fhi</span> <span class="o">=</span> <span class="n">hifac</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">flo</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="p">(</span><span class="n">fhi</span> <span class="o">-</span> <span class="n">flo</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">flo</span><span class="p">,</span> <span class="n">fhi</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">freq_vector_welch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the frequency vector based on the Weltch&#39;s method.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        References:</span>
<span class="sd">            https://github.com/scipy/scipy/blob/v0.14.0/scipy/signal/spectral.py</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="k">if</span> <span class="n">nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_freqs</span> <span class="o">=</span> <span class="n">nt</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_freqs</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="n">nt</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">make_freq_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Make frequency vector</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">freqs_welch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_vector_welch</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs_welch</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># discard the first element 0</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">beta_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Estimate the power slope of a 1/f^beta process.</span>

<span class="sd">        Args:</span>
<span class="sd">            psd (array): the power spectral density</span>
<span class="sd">            freqs (array): the frequency vector</span>
<span class="sd">            fmin, fmax (float): the frequency range for beta estimation</span>

<span class="sd">        Returns:</span>
<span class="sd">            beta (float): the estimated slope</span>
<span class="sd">            f_binned (array): binned frequency vector</span>
<span class="sd">            psd_binned (array): binned power spectral density</span>
<span class="sd">            Y_reg (array): prediction based on linear regression</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># frequency binning start</span>
        <span class="n">fminindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&gt;=</span> <span class="n">fmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fmaxindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&lt;=</span> <span class="n">fmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">logf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">logf_step</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="p">]</span>
        <span class="n">logf_start</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="p">]</span>
        <span class="n">logf_end</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fmaxindx</span><span class="p">]</span>
        <span class="n">logf_binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">logf_start</span><span class="p">,</span> <span class="n">logf_end</span><span class="o">+</span><span class="n">logf_step</span><span class="p">,</span> <span class="n">logf_step</span><span class="p">)</span>

        <span class="n">n_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">logf_binedges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">logpsd_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span>
        <span class="n">logf_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span>

        <span class="n">logpsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">):</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">logf_binedges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">logf_binedges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">logf</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">logf</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">))</span>

            <span class="n">logpsd_binned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">logpsd</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
            <span class="n">logf_binned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub</span> <span class="o">+</span> <span class="n">lb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">f_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logf_binned</span><span class="p">)</span>
        <span class="n">psd_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logpsd_binned</span><span class="p">)</span>
        <span class="c1"># frequency binning end</span>

        <span class="c1"># linear regression below</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">psd_binned</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">f_binned</span><span class="p">)</span>
        <span class="n">X_ex</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ex</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the slope we want</span>

        <span class="n">Y_reg</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># prediction based on linear regression</span>

        <span class="k">return</span> <span class="n">beta</span><span class="p">,</span> <span class="n">f_binned</span><span class="p">,</span> <span class="n">psd_binned</span><span class="p">,</span> <span class="n">Y_reg</span>

    <span class="k">def</span> <span class="nf">beta2HurstIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Translate psd slope to Hurst index</span>

<span class="sd">        Args:</span>
<span class="sd">            beta (float): the estimated slope of a power spectral density curve</span>

<span class="sd">        Returns:</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1)</span>

<span class="sd">        References:</span>
<span class="sd">            Equation 2 in http://www.bearcave.com/misl/misl_tech/wavelets/hurst/</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">H</span>

    <span class="k">def</span> <span class="nf">psd_ar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_noise</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">ar_params</span><span class="p">,</span> <span class="n">f_sampling</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the theoretical power spectral density (PSD) of an autoregressive model</span>

<span class="sd">        Args:</span>
<span class="sd">            var_noise (float): the variance of the noise of the AR process</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            ar_params (array): autoregressive coefficients, not including zero-lag</span>
<span class="sd">            f_sampling (float): sampling frequency</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ar_params</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">freqs</span><span class="o">/</span><span class="n">f_sampling</span><span class="p">)</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">var_noise</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ar_params</span><span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">fBMsim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Simple method to generate fractional Brownian Motion</span>

<span class="sd">        Args:</span>
<span class="sd">            N (int): the length of the simulated time series</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1)</span>

<span class="sd">        References:</span>
<span class="sd">            1. http://cours-physique.lps.ens.fr/index.php/TD11_Correlated_Noise_2011</span>
<span class="sd">            2. https://www.wikiwand.com/en/Fractional_Brownian_motion</span>

<span class="sd">        @authors: jeg</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">H</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">H</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;H should be in (0, 1)!&quot;</span>

        <span class="n">HH</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">H</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span>  <span class="c1"># number of steps</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
                <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">HH</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">HH</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">HH</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">covariance</span><span class="p">)</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">ns</span><span class="p">))</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

        <span class="n">xfBm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">xfBm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">xfBm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfBm</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">eta</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">xfBm</span>

    <span class="k">def</span> <span class="nf">psd_fBM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the theoretical psd of a fBM</span>

<span class="sd">        Args:</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            ts (array): the time axis of the time series</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        References:</span>
<span class="sd">            Flandrin, P. On the spectrum of fractional Brownian motions.</span>
<span class="sd">                IEEE Transactions on Information Theory 35, 197–199 (1989).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nf</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span>
            <span class="n">psd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">/</span><span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">get_wwz_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the wwz function to use.</span>

<span class="sd">        Args:</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                          &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                          &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>
<span class="sd">        Returns:</span>
<span class="sd">            wwz_func (function): the wwz function to use</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">wa</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Foster&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_nproc</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Kirchner&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_nproc</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Kirchner_opt&#39;</span><span class="p">:</span>
            <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_opt</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Foster_opt1&#39;</span><span class="p">:</span>
            <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_opt1</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Foster_opt2&#39;</span><span class="p">:</span>
            <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_opt2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_f2py</span>

        <span class="k">return</span> <span class="n">wwz_func</span>

    <span class="k">def</span> <span class="nf">prepare_wwz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the truncated time series with NaNs deleted</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">            ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        Returns:</span>
<span class="sd">            ys_cut (array): the truncated time series with NaNs deleted</span>
<span class="sd">            ts_cut (array): the truncated time axis of the original time series with NaNs deleted</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># delete NaNs if there is any</span>
        <span class="n">ys_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">med_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">//</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">med_res</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="s2">&quot;tau should be within the time span of the time series.&quot;</span>

        <span class="c1"># truncate the time series when the range of tau is smaller than that of the time series</span>
        <span class="n">ts_cut</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">))]</span>
        <span class="n">ys_cut</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;tau will be adjusted since the boundary of tau is not on any time point.&quot;</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">cross_wt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cross wavelet transform.</span>

<span class="sd">        Args:</span>
<span class="sd">            coeff1, coeff2 (array): the two sets of wavelet transform coefficients</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        Returns:</span>
<span class="sd">            xw_amplitude (array): the cross wavelet amplitude</span>
<span class="sd">            xw_phase (array): the cross wavelet phase</span>

<span class="sd">        References:</span>
<span class="sd">            1.Grinsted, A., Moore, J. C. &amp; Jevrejeva, S. Application of the cross wavelet transform and</span>
<span class="sd">                wavelet coherence to geophysical time series. Nonlin. Processes Geophys. 11, 561–566 (2004).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xwt</span> <span class="o">=</span> <span class="n">coeff1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span>
        <span class="n">xw_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xwt</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xwt</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xwt</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">xwt</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span>

    <span class="k">def</span> <span class="nf">cross_coherence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cross wavelet transform.</span>

<span class="sd">        Args:</span>
<span class="sd">            coeff1, coeff2 (array): the two sets of wavelet transform coefficients</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c1, c2 (float): normalization constants</span>

<span class="sd">        Returns:</span>
<span class="sd">            xw_coherence (array): the cross wavelet coherence</span>

<span class="sd">        References:</span>
<span class="sd">            1.Grinsted, A., Moore, J. C. &amp; Jevrejeva, S. Application of the cross wavelet transform and</span>
<span class="sd">                wavelet coherence to geophysical time series. Nonlin. Processes Geophys. 11, 561–566 (2004).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xwt</span> <span class="o">=</span> <span class="n">coeff1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span>
        <span class="n">power1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">power2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>

        <span class="n">xw_coherence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">Smooth_time</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">Smooth_scale</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">Smoothing</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">Smooth_scale</span><span class="p">(</span><span class="n">Smooth_time</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">c1</span><span class="p">),</span> <span class="n">c2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">S</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="n">xw_coherence</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Smoothing</span><span class="p">(</span><span class="n">xwt</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">omega</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> \
                <span class="n">Smoothing</span><span class="p">(</span><span class="n">power1</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">omega</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="o">/</span> <span class="n">Smoothing</span><span class="p">(</span><span class="n">power2</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">omega</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xw_coherence</span>


<span class="k">class</span> <span class="nc">AliasFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Performing anti-alias filter on a psd @author: fzhu</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">alias_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">f_limit</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args:</span>
<span class="sd">            freq (array): vector of frequencies in power spectrum</span>
<span class="sd">            pwr (array): vector of spectral power corresponding to frequencies &quot;freq&quot;</span>
<span class="sd">            fs (float): sampling frequency</span>
<span class="sd">            fc (float): corner frequency for 1/f^2 steepening of power spectrum</span>
<span class="sd">            f_limit (float): lower frequency limit for estimating misfit of model-plus-alias spectrum vs. measured power</span>
<span class="sd">            avgs (int): flag for whether spectrum is derived from instantaneous point measurements (avgs&lt;&gt;1)</span>
<span class="sd">                        OR from measurements averaged over each sampling interval (avgs==1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            alpha (float): best-fit exponent of power-law model</span>
<span class="sd">            filtered_pwr (array): vector of alias-filtered spectral power</span>
<span class="sd">            model_pwr (array): vector of modeled spectral power</span>
<span class="sd">            aliased_pwr (array): vector of modeled spectral power, plus aliases</span>

<span class="sd">        References:</span>
<span class="sd">            1. Kirchner, J. W. Aliasing in 1/f(alpha) noise spectra: origins, consequences, and remedies.</span>
<span class="sd">                    Phys Rev E Stat Nonlin Soft Matter Phys 71, 66110 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">log_pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pwr</span><span class="p">)</span>
        <span class="n">freq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">f_limit</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>  <span class="c1"># convert True &amp; False to 1 &amp; 0</span>

        <span class="n">alpha_upper_bound</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">alpha_lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.9</span>  <span class="c1"># if measurements are time-averaged</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>  <span class="c1"># if measurements are point samples</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fminbound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misfit</span><span class="p">,</span> <span class="n">alpha_lower_bound</span><span class="p">,</span> <span class="n">alpha_upper_bound</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

        <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="n">filtered_pwr</span> <span class="o">=</span> <span class="n">pwr</span> <span class="o">*</span> <span class="n">model_pwr</span> <span class="o">/</span> <span class="n">aliased_pwr</span>

        <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">filtered_pwr</span><span class="p">,</span> <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span>

    <span class="k">def</span> <span class="nf">misfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RMSE</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">model_pwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">model_pwr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">freq</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
            <span class="n">alias_minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alias_minus</span> <span class="o">=</span> <span class="n">alias_minus</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">alias_minus</span>

            <span class="n">alias_plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>  <span class="c1"># notice the + in (k*fs+freq)</span>
            <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alias_plus</span> <span class="o">=</span> <span class="n">alias_plus</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">alias_plus</span>

        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">beta</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>

        <span class="n">zo_minus</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">dz_minus</span> <span class="o">=</span> <span class="n">zo_minus</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">const</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span><span class="o">*</span><span class="n">dz_minus</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">fc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dz_minus</span>

        <span class="n">zo_plus</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">dz_plus</span> <span class="o">=</span> <span class="n">zo_plus</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">const</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span><span class="o">*</span><span class="n">dz_plus</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">fc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dz_plus</span>

        <span class="n">log_aliased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aliased_pwr</span><span class="p">)</span>

        <span class="n">prefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">log_pwr</span> <span class="o">-</span> <span class="n">log_aliased</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq_mask</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)</span>

        <span class="n">log_aliased</span> <span class="o">=</span> <span class="n">log_aliased</span> <span class="o">+</span> <span class="n">prefactor</span>
        <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prefactor</span><span class="p">)</span>
        <span class="n">model_pwr</span> <span class="o">=</span> <span class="n">model_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prefactor</span><span class="p">)</span>

        <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">log_aliased</span><span class="o">-</span><span class="n">log_pwr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">log_aliased</span><span class="o">-</span><span class="n">log_pwr</span><span class="p">)</span><span class="o">*</span><span class="n">freq_mask</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">spectr</span> <span class="o">=</span> <span class="n">freq</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span><span class="o">/</span><span class="n">fc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spectr</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Interface for the users below, more checks about the input will be performed here</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="ar1_fit"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.ar1_fit">[docs]</a><span class="k">def</span> <span class="nf">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Returns the lag-1 autocorrelation from ar1 fit OR persistence from tauest.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): the time series</span>
<span class="sd">        ts (array): the time axis of that series</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">    Returns:</span>
<span class="sd">        g (float): lag-1 autocorrelation coefficient (for evenly-spaced time series)</span>
<span class="sd">        OR estimated persistence (for unevenly-spaced time series)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_fit_evenly</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="ar1_sim"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.ar1_sim">[docs]</a><span class="k">def</span> <span class="nf">ar1_sim</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Produce p realizations of an AR1 process of length n with lag-1 autocorrelation g calculated from `ys` and `ts`</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">        n, p (int): dimensions as n rows by p columns</span>
<span class="sd">        ts (array): the time axis of that series</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>

<span class="sd">    Returns:</span>
<span class="sd">        red (matrix): n rows by p columns matrix of an AR1 process</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>  <span class="c1"># declare array</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

        <span class="c1"># specify model parameters (statsmodel wants lag0 coefficents as unity)</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="p">]</span>  <span class="c1"># AR model parameter</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>  <span class="c1"># MA model parameters</span>
        <span class="n">sig_n</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># theoretical noise variance for red to achieve the same variance as ys</span>

        <span class="c1"># simulate AR(1) model for each column</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">arma_generate_sample</span><span class="p">(</span><span class="n">ar</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sig_n</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">tau_est</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">tau_est</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">red</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">red</span></div>


<div class="viewcode-block" id="wwz"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.wwz">[docs]</a><span class="k">def</span> <span class="nf">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) with phase, AR1_q, and cone of influence, as well as WT coeeficients</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">        ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        c (float): the decay constant, the default value 1/(8*np.pi**2) is good for most of the cases</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>

<span class="sd">    Returns:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">        coeff (array): the wavelet transform coefficents</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The f2py version is not supported for Linux right now; will use python version instead.&quot;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Kirchner&#39;</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nMC should be larger than or eaqual to 0.&quot;</span>

    <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">get_wwz_func</span><span class="p">(</span><span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

    <span class="c1"># Monte-Carlo simulations of AR1 process</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="n">wwa_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
    <span class="n">AR1_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tauest</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations...&#39;</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">,</span> <span class="n">tauest</span><span class="p">)</span>
            <span class="n">wwa_red</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
                <span class="n">AR1_q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa_red</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">AR1_q</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># calculate the cone of influence</span>
    <span class="n">coi</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span></div>


<div class="viewcode-block" id="wwz_psd"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.wwz_psd">[docs]</a><span class="k">def</span> <span class="nf">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the psd of a timeseires directly using wwz method.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">        ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        c (float): the decay constant, the default value 1e-3 is good for most of the cases</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>

<span class="sd">    Returns:</span>
<span class="sd">        psd (array): power spectral density</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        psd_ar1_q95 (array): the 95% quantile of the psds of AR1 processes</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="c1"># get wwa but AR1_q is not needed here so set nMC=0</span>
    <span class="n">wwa</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="n">psd</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwa2psd</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="n">avgs</span><span class="p">)</span>

    <span class="c1"># Monte-Carlo simulations of AR1 process</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tauest</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations...&#39;</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">,</span> <span class="n">tauest</span><span class="p">)</span>
            <span class="n">wwa_red</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Neffs_red</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                       <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="n">psd_ar1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwa2psd</span><span class="p">(</span><span class="n">wwa_red</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">Neffs_red</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="n">avgs</span><span class="p">)</span>

        <span class="n">psd_ar1_q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">psd_ar1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">psd_ar1_q95</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span></div>


<span class="k">def</span> <span class="nf">xwt</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span>
        <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the crosse wavelet transform of two time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys1, ys2 (array): the two time series</span>
<span class="sd">        ts1, ts2 (array): the time axis of the two time series</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        c (float): the decay constant, the default value 1/(8*np.pi**2) is good for most of the cases</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>

<span class="sd">    Returns:</span>
<span class="sd">        xw_amplitude (array): the cross wavelet amplitude</span>
<span class="sd">        xw_phase (array): the cross wavelet phase</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nMC should be larger than or eaqual to 0.&quot;</span>

    <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">get_wwz_func</span><span class="p">(</span><span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff1</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
    <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff2</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>

    <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">cross_wt</span><span class="p">(</span><span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

    <span class="n">AR1_q</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">coi</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span>


<div class="viewcode-block" id="plot_wwa"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_wwa">[docs]</a><span class="k">def</span> <span class="nf">plot_wwa</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tick_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">clr_map</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span>
             <span class="n">cbar_drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cone_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">plot_signif</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">signif_style</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span>
             <span class="n">plot_cone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Period&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the wavelet amplitude</span>

<span class="sd">    Args:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>
<span class="sd">        levels (array): levels of values to plot</span>
<span class="sd">        tick_range (array): levels of ticks to show on the colorbar</span>
<span class="sd">        yticks (list): ticks on y-axis</span>
<span class="sd">        ylim (list): limitations for y-axis</span>
<span class="sd">        xticks (list): ticks on x-axis</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        clr_map (str): the name of the colormap</span>
<span class="sd">        cbar_drawedges (bool): whether to draw edges on the colorbar or not</span>
<span class="sd">        cone_alpha (float): the alpha value for the area covered by cone of influence</span>
<span class="sd">        plot_signif (bool): plot 95% significant area or not</span>
<span class="sd">        signif_style (str): plot 95% significant area with `contour` or `shade`</span>
<span class="sd">        plot_cone (bool): plot cone of influence or not</span>
<span class="sd">        ax: Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">        xlabel (str): The x-axis label</span>
<span class="sd">        ylabel (str): The y-axis label</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Neff</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Neff</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">wwa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">q95</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There are outliers in the input amplitudes, &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;and the `levels` have been set so that the outpliers will be ignored! &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;One might want to use `Spectral.plot_wwadist(wwa)` to plot the distribution of &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;the amplitudes with the 95% quantile line to check if the levels are appropriate.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">max_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q95</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_level</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_level</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>

    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">wwa</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">clr_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">wwa</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">clr_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">drawedges</span><span class="o">=</span><span class="n">cbar_drawedges</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span>
                 <span class="n">ticks</span><span class="o">=</span><span class="n">tick_range</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xlabels</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_signif</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">AR1_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please set values for `AR1_q`!&quot;</span>
        <span class="n">signif</span> <span class="o">=</span> <span class="n">wwa</span> <span class="o">/</span> <span class="n">AR1_q</span>
        <span class="k">if</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;shade&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># significant if not shaded</span>

    <span class="k">if</span> <span class="n">plot_cone</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please set values for `coi`!&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">cone_alpha</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_wwadist"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_wwadist">[docs]</a><span class="k">def</span> <span class="nf">plot_wwadist</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Plot the distribution of wwa with the 95% quantile line.</span>

<span class="sd">    Args:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        ylim (list): limitations for y-axis</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">wwa</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">q95</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_psd"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_psd">[docs]</a><span class="k">def</span> <span class="nf">plot_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">lmstyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSD&#39;</span><span class="p">,</span> <span class="n">plot_ar1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">psd_ar1_color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s2">&quot;pale red&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Period&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Spectral Density&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the wavelet amplitude</span>

<span class="sd">    Args:</span>
<span class="sd">        psd (array): power spectral density</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        xticks (list): ticks on x-axis</span>
<span class="sd">        xlim (list): limits for x-axis</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        ax: Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">        xlabel (str): The x-axis label</span>
<span class="sd">        ylabel (str): The y-axis label</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lmstyle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">lmstyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_ar1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">psd_ar1_q95</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psd_ar1_q95 is required!&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AR1 95%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">psd_ar1_color</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_ar1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">psd_ar1_q95</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psd_ar1_q95 is required!&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AR1 95%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">psd_ar1_color</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ax</span></div>

<span class="c1"># some alias</span>
<span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
<span class="n">beta_estimation</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">beta_estimation</span>
<span class="n">tau_estimation</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Pyleoclim</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Pyleoclim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Main.html">Main Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Map.html">Mapping Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Plot.html">Plotting Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Stats.html">Statistics Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Timeseries.html">Timeseries Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LipdUtils.html">LiPD Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SummaryPlots.html">Summary Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Spectral.html">Spectral Functions</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pyleoclim.html">pyleoclim</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Deborah Khider, Julien Emile-Geay, Feng Zhu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>