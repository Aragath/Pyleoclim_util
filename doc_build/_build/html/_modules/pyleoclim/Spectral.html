

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyleoclim.Spectral &mdash; Pyleoclim 0.4.10 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Pyleoclim
          

          
          </a>

          
            
            
              <div class="version">
                0.4.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">Pyleoclim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Main.html">Main Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Map.html">Mapping Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Plot.html">Plotting Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Stats.html">Statistics Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Timeseries.html">Timeseries Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LIPDutils.html">LiPD Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SummaryPlots.html">Summary Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Spectral.html">Spectral Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RBchron.html">RBchron</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pyleoclim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../pyleoclim.html">pyleoclim</a> &raquo;</li>
        
      <li>pyleoclim.Spectral</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyleoclim.Spectral</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Apr 28 14:23:06 2017</span>

<span class="sd">@author: deborahkhider, fengzhu</span>

<span class="sd">Spectral module for pyleoclim</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">mquantiles</span>
<span class="kn">import</span> <span class="nn">scipy.fftpack</span> <span class="k">as</span> <span class="nn">fft</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">ScalarFormatter</span><span class="p">,</span> <span class="n">FormatStrFormatter</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">gridspec</span>

<span class="kn">from</span> <span class="nn">pathos.multiprocessing</span> <span class="k">import</span> <span class="n">ProcessingPool</span> <span class="k">as</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Timeseries</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">factorial</span>

<span class="kn">import</span> <span class="nn">spectrum</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;darwin&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">f2py_wwz</span> <span class="k">as</span> <span class="n">f2py</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Core functions below, focusing on algorithms</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">class</span> <span class="nc">SpectralAnalysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">welch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ana_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">prep_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">interp_method</span><span class="o">=</span><span class="s1">&#39;interp&#39;</span><span class="p">,</span> <span class="n">interp_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            ana_args (dict): the arguments for spectral analysis with periodogram, including</span>
<span class="sd">                - window (str): Desired window to use. See get_window for a list of windows and required parameters. If window is an array it will be used directly as the window. Defaults to None; equivalent to ‘boxcar’.</span>
<span class="sd">                - nfft (int): length of the FFT used. If None the length of x will be used.</span>
<span class="sd">                - return_onesided (bool): If True, return a one-sided spectrum for real data. If False return a two-sided spectrum. Note that for complex data, a two-sided spectrum is always returned.</span>
<span class="sd">                - nperseg (int): Length of each segment. Defaults to None, but if window is str or tuple, is set to 256, and if window is array_like, is set to the length of the window.</span>
<span class="sd">                - noverlap (int): Number of points to overlap between segments. If None, noverlap = nperseg // 2. Defaults to None.</span>
<span class="sd">                - scaling (str, {&#39;density&#39;, &#39;spectrum&#39;}): Selects between computing the power spectral density (‘density’) where Pxx has units of V**2/Hz if x is measured in V and computing the power spectrum (‘spectrum’) where Pxx has units of V**2 if x is measured in V. Defaults to ‘density’</span>
<span class="sd">                - axis (int):     Axis along which the periodogram is computed; the default is over the last axis (i.e. axis=-1).</span>
<span class="sd">                - average : { ‘mean’, ‘median’ }, optional</span>
<span class="sd">                see https://docs.scipy.org/doc/scipy-1.2.1/reference/generated/scipy.signal.welch.html for details</span>
<span class="sd">            interp_method (str, {&#39;interp&#39;, &#39;bin&#39;}): perform interpolation or binning</span>
<span class="sd">            interp_args (dict): the arguments for the interpolation or binning methods,</span>
<span class="sd">                                for the details, check Timeseries.interp() and Timeseries.binvalues()</span>
<span class="sd">            prep_args (dict): the arguments for preprocess, including</span>
<span class="sd">                - detrend (str): &#39;none&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                                 &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                                 &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                                 &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                                     filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">                                 &#39;hht&#39; - detrending with Hilbert-Huang Transform</span>
<span class="sd">                - params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                                 corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                                 while the second parameter correspond to the order of the filter</span>
<span class="sd">                                 (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                                 (the default is zero, which means only smoothing.)</span>
<span class="sd">                - gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">                - standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">        Returns:</span>
<span class="sd">            res_dict (dict): the result dictionary, including3</span>
<span class="sd">                - freqs (array): the frequency vector</span>
<span class="sd">                - psd (array): the spectral density vector</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#make default nperseg len(ts)//3</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ana_args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ana_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nperseg&#39;</span><span class="p">):</span>
            <span class="n">ana_args</span><span class="p">[</span><span class="s1">&#39;nperseg&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span>
        
        <span class="c1"># preprocessing</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">prep_args</span><span class="p">)</span>

        <span class="c1"># if data is not evenly spaced, interpolate</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
                <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">binvalues</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">[</span><span class="n">interp_method</span><span class="p">](</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">interp_args</span><span class="p">)</span>

        <span class="c1"># calculate sampling frequency fs</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>

        <span class="c1"># spectral analysis with scipy welch</span>
        <span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="o">**</span><span class="n">ana_args</span><span class="p">)</span>

        <span class="c1"># fix zero frequency point</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># output result</span>
        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s1">&#39;psd&#39;</span> <span class="p">:</span> <span class="n">psd</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">res_dict</span>


    <span class="k">def</span> <span class="nf">mtm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">NW</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">ana_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">prep_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">interp_method</span><span class="o">=</span><span class="s1">&#39;interp&#39;</span><span class="p">,</span> <span class="n">interp_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39; Call MTM from the package [spectrum](https://github.com/cokelaer/spectrum)</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            ana_args (dict): the arguments for spectral analysis with periodogram, including</span>
<span class="sd">                - window (str): Desired window to use. See get_window for a list of windows and required parameters. If window is an array it will be used directly as the window. Defaults to None; equivalent to ‘boxcar’.</span>
<span class="sd">                - nfft (int): length of the FFT used. If None the length of x will be used.</span>
<span class="sd">                - return_onesided (bool): If True, return a one-sided spectrum for real data. If False return a two-sided spectrum. Note that for complex data, a two-sided spectrum is always returned.</span>
<span class="sd">                - scaling (str, {&#39;density&#39;, &#39;spectrum&#39;}): Selects between computing the power spectral density (‘density’) where Pxx has units of V**2/Hz if x is measured in V and computing the power spectrum (‘spectrum’) where Pxx has units of V**2 if x is measured in V. Defaults to ‘density’</span>
<span class="sd">                see https://docs.scipy.org/doc/scipy-0.13.0/reference/generated/scipy.signal.periodogram.html for the details</span>
<span class="sd">            interp_method (str, {&#39;interp&#39;, &#39;bin&#39;}): perform interpolation or binning</span>
<span class="sd">            interp_args (dict): the arguments for the interpolation or binning methods,</span>
<span class="sd">                                for the details, check Timeseries.interp() and Timeseries.binvalues()</span>

<span class="sd">            prep_args (dict): the arguments for preprocess, including</span>
<span class="sd">                - detrend (str): &#39;none&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                                 &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                                 &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                                 &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                                     filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">                                 &#39;hht&#39; - detrending with Hilbert-Huang Transform</span>
<span class="sd">                - params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                                 corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                                 while the second parameter correspond to the order of the filter</span>
<span class="sd">                                 (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                                 (the default is zero, which means only smoothing.)</span>
<span class="sd">                - gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">                - standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            res_dict (dict): the result dictionary, including</span>
<span class="sd">                - freqs (array): the frequency vector</span>
<span class="sd">                - psd (array): the spectral density vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># preprocessing</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">prep_args</span><span class="p">)</span>

        <span class="c1"># interpolate if not evenly-spaced</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
                <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">binvalues</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">[</span><span class="n">interp_method</span><span class="p">](</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">interp_args</span><span class="p">)</span>

        <span class="c1"># calculate sampling frequency</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>

        <span class="c1"># spectral analysis</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">MultiTapering</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">NW</span><span class="o">=</span><span class="n">NW</span><span class="p">,</span> <span class="o">**</span><span class="n">ana_args</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">psd</span>

        <span class="c1"># fix the zero frequency point</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># output result</span>
        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s1">&#39;psd&#39;</span><span class="p">:</span> <span class="n">psd</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">res_dict</span>


    <span class="k">def</span> <span class="nf">lomb_scargle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_freq_method</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">prep_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">ana_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Return the computed periodogram using lomb-scargle algorithm</span>
<span class="sd">        Lombscargle algorithm</span>
<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            make_freq_method (str) : Method to be used to make the time series. Default is nfft</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">            args (dict): Extra argumemnts which may be needed such as</span>
<span class="sd">                precenter (bool): Pre-center amplitudes by subtracting the mean</span>
<span class="sd">                normalize (bool): Compute normalized periodogram</span>
<span class="sd">        Returns:</span>
<span class="sd">            res : the lombscargle periodogram</span>
<span class="sd">            freqs : vector of frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">prep_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">make_freq_method</span><span class="p">)</span>

        <span class="n">freqs_angular</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span>

        <span class="c1"># fix the zero frequency point</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">freqs_copy</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">freqs_angular</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs_copy</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">lombscargle</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">freqs_angular</span><span class="p">,</span> <span class="o">**</span><span class="n">ana_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># output result</span>
        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s1">&#39;psd&#39;</span><span class="p">:</span> <span class="n">psd</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">res_dict</span>


    <span class="k">def</span> <span class="nf">periodogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ana_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">prep_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">interp_method</span><span class="o">=</span><span class="s1">&#39;interp&#39;</span><span class="p">,</span> <span class="n">interp_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39; Call periodogram from scipy</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            ana_args (dict): the arguments for spectral analysis with periodogram, including</span>
<span class="sd">                - window (str): Desired window to use. See get_window for a list of windows and required parameters. If window is an array it will be used directly as the window. Defaults to None; equivalent to ‘boxcar’.</span>
<span class="sd">                - nfft (int): length of the FFT used. If None the length of x will be used.</span>
<span class="sd">                - return_onesided (bool): If True, return a one-sided spectrum for real data. If False return a two-sided spectrum. Note that for complex data, a two-sided spectrum is always returned.</span>
<span class="sd">                - scaling (str, {&#39;density&#39;, &#39;spectrum&#39;}): Selects between computing the power spectral density (‘density’) where Pxx has units of V**2/Hz if x is measured in V and computing the power spectrum (‘spectrum’) where Pxx has units of V**2 if x is measured in V. Defaults to ‘density’</span>
<span class="sd">                see https://docs.scipy.org/doc/scipy-0.13.0/reference/generated/scipy.signal.periodogram.html for the details</span>
<span class="sd">            interp_method (str, {&#39;interp&#39;, &#39;bin&#39;}): perform interpolation or binning</span>
<span class="sd">            interp_args (dict): the arguments for the interpolation or binning methods,</span>
<span class="sd">                                for the details, check Timeseries.interp() and Timeseries.binvalues()</span>

<span class="sd">            prep_args (dict): the arguments for preprocess, including</span>
<span class="sd">                - detrend (str): &#39;none&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                                 &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                                 &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                                 &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                                     filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">                                 &#39;hht&#39; - detrending with Hilbert-Huang Transform</span>
<span class="sd">                - params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                                 corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                                 while the second parameter correspond to the order of the filter</span>
<span class="sd">                                 (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                                 (the default is zero, which means only smoothing.)</span>
<span class="sd">                - gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">                - standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            res_dict (dict): the result dictionary, including</span>
<span class="sd">                - freqs (array): the frequency vector</span>
<span class="sd">                - psd (array): the spectral density vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># preprocessing</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">prep_args</span><span class="p">)</span>

        <span class="c1"># interpolate if not evenly-spaced</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;interp&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">interp</span><span class="p">,</span>
                <span class="s1">&#39;bin&#39;</span><span class="p">:</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">binvalues</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">[</span><span class="n">interp_method</span><span class="p">](</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="o">**</span><span class="n">interp_args</span><span class="p">)</span>

        <span class="c1"># calculate sampling frequency</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>

        <span class="c1"># spectral analysis</span>
        <span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">periodogram</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="o">**</span><span class="n">ana_args</span><span class="p">)</span>

        <span class="c1"># fix the zero frequency point</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># output result</span>
        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="n">freqs</span><span class="p">,</span>
            <span class="s1">&#39;psd&#39;</span><span class="p">:</span> <span class="n">psd</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">res_dict</span>


<span class="k">class</span> <span class="nc">WaveletAnalysis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Performing wavelet analysis @author: fzhu</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">is_evenly_spaced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Check if a time axis is evenly spaced.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): the time axis of a time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            check (bool): True - evenly spaced; False - unevenly spaced.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">dt_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dt</span> <span class="o">==</span> <span class="n">dt_mean</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)):</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">check</span>

    <span class="k">def</span> <span class="nf">ar1_fit_evenly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the lag-1 autocorrelation from ar1 fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): vector of (float) numbers as a time series</span>
<span class="sd">            ts (array): The time axis for the timeseries. Necessary for use with</span>
<span class="sd">                the Savitzky-Golay filters method since the series should be evenly spaced.</span>
<span class="sd">            detrend (str): &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            g (float): lag-1 autocorrelation coefficient</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">)</span>
        <span class="n">ar1_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">AR</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxlag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_mod</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the processed time series using detrend and standardization.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): The time axis for the timeseries. Necessary for use with</span>
<span class="sd">                the Savitzky-Golay filters method since the series should be evenly spaced.</span>
<span class="sd">            detrend (str): &#39;none&#39;/False/None - no detrending will be applied;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            res (array): the processed time series</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">detrend</span> <span class="ow">is</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> <span class="n">detrend</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">detrend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ys_d</span> <span class="o">=</span> <span class="n">ys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ys_d</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">ys_d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ys_d</span>

        <span class="k">if</span> <span class="n">gaussianize</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">gaussianize</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">tau_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the estimated persistence of a givenevenly/unevenly spaced time series.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            detrend (str): &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            tau_est (float): the estimated persistence</span>

<span class="sd">        References:</span>
<span class="sd">            Mudelsee, M. TAUEST: A Computer Program for Estimating Persistence in Unevenly Spaced Weather/Climate Time Series.</span>
<span class="sd">                Comput. Geosci. 28, 69–72 (2002).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="c1">#  assert dt &gt; 0, &quot;The time points should be increasing!&quot;</span>

        <span class="k">def</span> <span class="nf">ar1_fun</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pd_ys</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">pd_ys</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="n">dt</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">a_est</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">ar1_fun</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bounded&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">x</span>
        <span class="c1">#  a_est = optimize.minimize_scalar(ar1_fun, method=&#39;brent&#39;).x</span>

        <span class="n">tau_est</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a_est</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tau_est</span>

    <span class="k">def</span> <span class="nf">assertPositiveInt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Assert that the args are all positive integers.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span> <span class="o">&gt;=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">ar1_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a time series with the AR1 process</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            tau (float): the averaged persistence</span>
<span class="sd">            n (int): the length of the AR1 process</span>

<span class="sd">        Returns:</span>
<span class="sd">            r (array): the AR1 time series</span>

<span class="sd">        References:</span>
<span class="sd">            Schulz, M. &amp; Mudelsee, M. REDFIT: estimating red-noise spectra directly from unevenly spaced</span>
<span class="sd">                paleoclimatic time series. Computers &amp; Geosciences 28, 421–426 (2002).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">scaled_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">tau</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">scaled_dt</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rho</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">rho</span> <span class="o">+</span> <span class="n">err</span>

        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">wwz_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                  <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Original method from Foster. Not multiprocessing.</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients (a0, a1, a2)</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_omega</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">ywave_1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                    <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">S_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

                    <span class="n">weighted_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                    <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">ywave_1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                    <span class="n">ywave_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                    <span class="n">ywave_3</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="c1">#  coeff = ywave_2 + ywave_3*1j</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ywave_1</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">,</span> <span class="n">ywave_3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">wwz_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                  <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA).</span>
<span class="sd">        </span>
<span class="sd">        Original method from Foster. Supports multiprocessing. </span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients (a0, a1, a2)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wwz_nproc() should use nproc &gt;= 2, if want serial run, please use wwz_basic()&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_omega</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">wwa_1g</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">Neff_loc</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">Neff_loc</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                <span class="n">ywave_2_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">ywave_3_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                <span class="n">phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">phi3</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">S_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>

                <span class="n">weighted_phi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">weighted_phi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi2</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>
                <span class="n">weighted_phi3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">phi3</span><span class="o">*</span><span class="n">pd_ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">ywave_1_1g</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                <span class="n">ywave_2_1g</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>
                <span class="n">ywave_3_1g</span> <span class="o">=</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi1</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi2</span> <span class="o">+</span> <span class="n">S_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">weighted_phi3</span>

            <span class="k">return</span> <span class="n">Neff_loc</span><span class="p">,</span> <span class="n">ywave_1_1g</span><span class="p">,</span> <span class="n">ywave_2_1g</span><span class="p">,</span> <span class="n">ywave_3_1g</span>

        <span class="n">tf_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">list_of_grids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">tf_mesh</span><span class="p">)))</span>
        <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_grids</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wwa_1g</span><span class="p">,</span> <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span><span class="p">)</span>
            <span class="n">res_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">Neffs</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ywave_1</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ywave_2</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ywave_3</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ywave_2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ywave_3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ywave_3</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">)</span>
        <span class="c1">#  coeff = ywave_2 + ywave_3*1j</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ywave_1</span><span class="p">,</span> <span class="n">ywave_2</span><span class="p">,</span> <span class="n">ywave_3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Method modified by Kirchner. No multiprocessing.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients (a0, a1, a2)</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. Wavelets for period analysis of unevenly sampled time series. The Astronomical Journal 112, 1709 (1996).</span>
<span class="sd">            Witt, A. &amp; Schumann, A. Y. Holocene climate variability on millennial scales recorded in Greenland ice cores.</span>
<span class="sd">                Nonlinear Processes in Geophysics 12, 345–352 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;wwz_basic() only supports nproc=1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_omega</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
                <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># local number of effective dof</span>

                <span class="k">if</span> <span class="n">Neffs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                    <span class="n">a0</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">w_prod</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                    <span class="n">sin_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">cos_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                    <span class="n">one_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

                    <span class="n">sin_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">cos_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">sin_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>
                    <span class="n">sin_sin</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">sin_basis</span><span class="p">)</span>
                    <span class="n">cos_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>

                    <span class="n">numerator</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sin_cos</span> <span class="o">-</span> <span class="n">sin_one</span> <span class="o">*</span> <span class="n">cos_one</span><span class="p">)</span>
                    <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_cos</span> <span class="o">-</span> <span class="n">cos_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sin_sin</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>  <span class="c1"># Eq. (S5)</span>

                    <span class="n">sin_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">cos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                    <span class="n">sin_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="n">cos_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

                    <span class="n">ys_cos_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">cos_shift</span><span class="p">)</span>
                    <span class="n">ys_sin_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">sin_shift</span><span class="p">)</span>
                    <span class="n">ys_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">cos_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                    <span class="n">sin_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>

                    <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_cos_shift</span><span class="o">-</span><span class="n">ys_one</span><span class="o">*</span><span class="n">cos_shift_one</span><span class="p">)</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_sin_shift</span><span class="o">-</span><span class="n">ys_one</span><span class="o">*</span><span class="n">sin_shift_one</span><span class="p">)</span>

                    <span class="n">a0</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys_one</span>
                    <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">-</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S6)</span>
                    <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S7)</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
        <span class="c1">#  coeff = a1 + a2*1j</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_nproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Method modified by kirchner. Supports multiprocessing. </span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">            &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients (a0, a1, a2)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">nproc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wwz_nproc() should use nproc &gt;= 2, if want serial run, please use wwz_basic()&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_omega</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>

        <span class="n">Neffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">wwa_1g</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">sum_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="n">Neff_loc</span> <span class="o">=</span> <span class="n">sum_w</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Neff_loc</span> <span class="o">&lt;=</span> <span class="n">Neff</span><span class="p">:</span>
                <span class="n">a0_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                <span class="n">a1_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># the coefficients cannot be estimated reliably when Neff_loc &lt;= Neff</span>
                <span class="n">a2_1g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">w_prod</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xs</span><span class="o">*</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_w</span>

                <span class="n">sin_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">cos_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">ts</span><span class="p">)</span>
                <span class="n">one_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nts</span><span class="p">)</span>

                <span class="n">sin_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">cos_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">sin_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>
                <span class="n">sin_sin</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_basis</span><span class="p">,</span> <span class="n">sin_basis</span><span class="p">)</span>
                <span class="n">cos_cos</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_basis</span><span class="p">,</span> <span class="n">cos_basis</span><span class="p">)</span>

                <span class="n">numerator</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sin_cos</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">*</span><span class="n">cos_one</span><span class="p">)</span>
                <span class="n">denominator</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos_cos</span> <span class="o">-</span> <span class="n">cos_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sin_sin</span> <span class="o">-</span> <span class="n">sin_one</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">time_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="p">)</span>  <span class="c1"># Eq. (S5)</span>

                <span class="n">sin_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                <span class="n">cos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">))</span>
                <span class="n">sin_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">))</span>
                <span class="n">cos_tau_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">time_shift</span> <span class="o">-</span> <span class="n">tau</span><span class="p">))</span>

                <span class="n">ys_cos_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">cos_shift</span><span class="p">)</span>
                <span class="n">ys_sin_shift</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">sin_shift</span><span class="p">)</span>
                <span class="n">ys_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">pd_ys</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">cos_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">cos_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>
                <span class="n">sin_shift_one</span> <span class="o">=</span> <span class="n">w_prod</span><span class="p">(</span><span class="n">sin_shift</span><span class="p">,</span> <span class="n">one_v</span><span class="p">)</span>

                <span class="n">A</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_cos_shift</span> <span class="o">-</span> <span class="n">ys_one</span><span class="o">*</span><span class="n">cos_shift_one</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ys_sin_shift</span> <span class="o">-</span> <span class="n">ys_one</span><span class="o">*</span><span class="n">sin_shift_one</span><span class="p">)</span>

                <span class="n">a0_1g</span> <span class="o">=</span> <span class="n">ys_one</span>
                <span class="n">a1_1g</span> <span class="o">=</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">-</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S6)</span>
                <span class="n">a2_1g</span> <span class="o">=</span> <span class="n">sin_tau_center</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span> <span class="n">cos_tau_center</span><span class="o">*</span><span class="n">B</span>  <span class="c1"># Eq. (S7)</span>

            <span class="k">return</span> <span class="n">Neff_loc</span><span class="p">,</span> <span class="n">a0_1g</span><span class="p">,</span> <span class="n">a1_1g</span><span class="p">,</span> <span class="n">a2_1g</span>

        <span class="n">tf_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">list_of_grids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flat</span> <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">tf_mesh</span><span class="p">)))</span>
        <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">list_of_grids</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wwa_1g</span><span class="p">,</span> <span class="n">tau_grids</span><span class="p">,</span> <span class="n">omega_grids</span><span class="p">)</span>
            <span class="n">res_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">Neffs</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">res_array</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
        <span class="c1">#  coeff = a1 + a2*1j</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">kirchner_f2py</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) modified by Kirchner.</span>

<span class="sd">        Fastest method. Calls Fortran libraries.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            c (float): the decay constant</span>
<span class="sd">            Neff (int): the threshold of the number of effective degree of freedom</span>
<span class="sd">            nproc (int): fake argument, just for convenience</span>
<span class="sd">            detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                           &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                           &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                           &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>
<span class="sd">            gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">            standardize (bool): If True, standardizes the timeseries</span>

<span class="sd">        Returns:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude</span>
<span class="sd">            phase (array): the weighted wavelet phase</span>
<span class="sd">            Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">            coeff (array): the wavelet transform coefficients (a0, a1, a2)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nproc</span><span class="p">)</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">nts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">pd_ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_omega</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>

        <span class="n">Neffs</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">f2py</span><span class="o">.</span><span class="n">f2py_wwz</span><span class="o">.</span><span class="n">wwa</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">pd_ys</span><span class="p">,</span> <span class="n">nproc</span><span class="p">,</span> <span class="n">nts</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span>

        <span class="n">undef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99999.</span>
        <span class="n">a0</span><span class="p">[</span><span class="n">a0</span> <span class="o">==</span> <span class="n">undef</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">a1</span><span class="p">[</span><span class="n">a1</span> <span class="o">==</span> <span class="n">undef</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">a2</span><span class="p">[</span><span class="n">a2</span> <span class="o">==</span> <span class="n">undef</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">wwa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>

        <span class="c1">#  coeff = a1 + a2*1j</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span>

    <span class="k">def</span> <span class="nf">make_coi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cone of influence.</span>

<span class="sd">        Args:</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">            Neff (int): the threshold of the number of effective samples</span>

<span class="sd">        Returns:</span>
<span class="sd">            coi (array): cone of influence</span>

<span class="sd">        References:</span>
<span class="sd">            wave_signif() in http://paos.colorado.edu/research/wavelets/wave_python/waveletFunctions.py</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Neff</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Neff</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>

        <span class="n">fourier_factor</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">Neff</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">Neff</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">coi_const</span> <span class="o">=</span> <span class="n">fourier_factor</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">nt_half</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nt_half</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">coi</span> <span class="o">=</span> <span class="n">coi_const</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">C</span>

        <span class="k">return</span> <span class="n">coi</span>

    <span class="k">def</span> <span class="nf">make_omega</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the angular frequency based on the time axis and given frequency vector</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            freqs (array): vector of frequency</span>

<span class="sd">        Returns:</span>
<span class="sd">            omega (array): the angular frequency vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># for the frequency band larger than f_Nyquist, the wwa will be marked as NaNs</span>
        <span class="n">f_Nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">freqs_with_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">freqs_with_nan</span><span class="p">[</span><span class="n">freqs</span> <span class="o">&gt;</span> <span class="n">f_Nyquist</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs_with_nan</span>

        <span class="k">return</span> <span class="n">omega</span>

    <span class="k">def</span> <span class="nf">wwa2psd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wwa</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the power spectral density (PSD) using the weighted wavelet amplitude (WWA).</span>

<span class="sd">        Args:</span>
<span class="sd">            wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">            ts (array): the time points, should be pre-truncated so that the span is exactly what is used for wwz</span>
<span class="sd">            Neffs (array):  the matrix of effective number of points in the time-scale coordinates obtained from wwz from wwz</span>
<span class="sd">            freqs (array): vector of frequency from wwz</span>
<span class="sd">            Neff (int): the threshold of the number of effective samples</span>
<span class="sd">            anti_alias (bool): whether to apply anti-alias filter</span>
<span class="sd">            avgs (int): flag for whether spectrum is derived from instantaneous point measurements (avgs&lt;&gt;1)</span>
<span class="sd">                        OR from measurements averaged over each sampling interval (avgs==1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        References:</span>
<span class="sd">            Kirchner&#39;s C code for weighted psd calculation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">af</span> <span class="o">=</span> <span class="n">AliasFilter</span><span class="p">()</span>

        <span class="c1"># weighted psd calculation start</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">wwa</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">*</span> <span class="n">Neffs</span>

        <span class="n">Neff_diff</span> <span class="o">=</span> <span class="n">Neffs</span> <span class="o">-</span> <span class="n">Neff</span>
        <span class="n">Neff_diff</span><span class="p">[</span><span class="n">Neff_diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">sum_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">power</span> <span class="o">*</span> <span class="n">Neff_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sum_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">Neff_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">sum_power</span> <span class="o">/</span> <span class="n">sum_eff</span>
        <span class="c1"># weighted psd calculation end</span>

        <span class="k">if</span> <span class="n">anti_alias</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;freqs is required for alias filter!&quot;</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="n">f_sampling</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span>
            <span class="n">psd_copy</span> <span class="o">=</span> <span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">freqs_copy</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">alpha</span><span class="p">,</span> <span class="n">filtered_pwr</span><span class="p">,</span> <span class="n">model_pwer</span><span class="p">,</span> <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">alias_filter</span><span class="p">(</span>
                <span class="n">freqs_copy</span><span class="p">,</span> <span class="n">psd_copy</span><span class="p">,</span> <span class="n">f_sampling</span><span class="p">,</span> <span class="n">f_sampling</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="n">avgs</span><span class="p">)</span>

            <span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filtered_pwr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">freq_vector_lomb_scargle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ofac</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">hifac</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the frequency vector based on the Lomb-Scargle algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            ofac (float): Oversampling rate that influences the resolution of the frequency axis,</span>
<span class="sd">                         when equals to 1, it means no oversamling (should be &gt;= 1).</span>
<span class="sd">                         The default value 4 is usaually a good value.</span>

<span class="sd">            hifac (float): fhi/fnyq (should be &gt;= 1), where fhi is the highest frequency that</span>
<span class="sd">                          can be analyzed by the Lomb-Scargle algorithm and fnyq is the Nyquist frequency.</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        References:</span>
<span class="sd">            Trauth, M. H. MATLAB® Recipes for Earth Sciences. (Springer, 2015). pp 181.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">ofac</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">hifac</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;`ofac` should be &gt;= 1, and `hifac` should be &lt;= 1&quot;</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">flo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">*</span><span class="n">ofac</span><span class="p">)</span>
        <span class="n">fhi</span> <span class="o">=</span> <span class="n">hifac</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">flo</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="p">(</span><span class="n">fhi</span> <span class="o">-</span> <span class="n">flo</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">flo</span><span class="p">,</span> <span class="n">fhi</span><span class="p">,</span> <span class="n">nf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">freq_vector_welch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the frequency vector based on the Welch&#39;s method.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        References:</span>
<span class="sd">            https://github.com/scipy/scipy/blob/v0.14.0/scipy/signal/spectral.py</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="k">if</span> <span class="n">nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_freqs</span> <span class="o">=</span> <span class="n">nt</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">nt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_freqs</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs</span> <span class="o">/</span> <span class="n">nt</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">freq_vector_nfft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the frequency vector based on NFFT</span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>

<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="n">n_freqs</span> <span class="o">=</span> <span class="n">nt</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fs</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_freqs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">make_freq_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Make frequency vector- Selector function.</span>
<span class="sd">        </span>
<span class="sd">        This function selects among various methods to obtain the frequency </span>
<span class="sd">        vector. </span>

<span class="sd">        Args:</span>
<span class="sd">            ts (array): time axis of the time series</span>
<span class="sd">            method (str): The method to use. Options are &#39;nfft&#39; (default), &#39;Lomb-Scargle&#39;, &#39;Welch&#39;</span>
<span class="sd">                For Lomb_Scargle, additional parameters may be passed:</span>
<span class="sd">                    nf (int): number of frequency points</span>
<span class="sd">                    ofac (float): Oversampling rate that influences the resolution of the frequency axis,</span>
<span class="sd">                         when equals to 1, it means no oversamling (should be &gt;= 1).</span>
<span class="sd">                         The default value 4 is usaually a good value.</span>
<span class="sd">                    hifac (float): fhi/fnyq (should be &gt;= 1), where fhi is the highest frequency that</span>
<span class="sd">                          can be analyzed by the Lomb-Scargle algorithm and fnyq is the Nyquist frequency.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            freqs (array): the frequency vector</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="s1">&#39;Lomb-Scargle&#39;</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_vector_lomb_scargle</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="ow">is</span> <span class="s1">&#39;Welch&#39;</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_vector_welch</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_vector_nfft</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
        <span class="c1">#  freqs = freqs[1:]  # discard the first element 0</span>

        <span class="k">return</span> <span class="n">freqs</span>

    <span class="k">def</span> <span class="nf">beta_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Estimate the power slope of a 1/f^beta process.</span>

<span class="sd">        Args:</span>
<span class="sd">            psd (array): the power spectral density</span>
<span class="sd">            freqs (array): the frequency vector</span>
<span class="sd">            fmin, fmax (float): the frequency range for beta estimation</span>

<span class="sd">        Returns:</span>
<span class="sd">            beta (float): the estimated slope</span>
<span class="sd">            f_binned (array): binned frequency vector</span>
<span class="sd">            psd_binned (array): binned power spectral density</span>
<span class="sd">            Y_reg (array): prediction based on linear regression</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># drop the PSD at frequency zero</span>
        <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psd</span> <span class="o">=</span> <span class="n">psd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">fmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">Results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;f_binned&#39;</span><span class="p">,</span> <span class="s1">&#39;psd_binned&#39;</span><span class="p">,</span> <span class="s1">&#39;Y_reg&#39;</span><span class="p">,</span> <span class="s1">&#39;std_err&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fmax</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fmin</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WRONG&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">f_binned</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">psd_binned</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">Y_reg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">std_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># frequency binning start</span>
        <span class="n">fminindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&gt;=</span> <span class="n">fmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fmaxindx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freqs</span> <span class="o">&lt;=</span> <span class="n">fmax</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fminindx</span> <span class="o">&gt;=</span> <span class="n">fmaxindx</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">f_binned</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">psd_binned</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">Y_reg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">std_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">logf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">logf_step</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="p">]</span>
        <span class="n">logf_start</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fminindx</span><span class="p">]</span>
        <span class="n">logf_end</span> <span class="o">=</span> <span class="n">logf</span><span class="p">[</span><span class="n">fmaxindx</span><span class="p">]</span>
        <span class="n">logf_binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">logf_start</span><span class="p">,</span> <span class="n">logf_end</span><span class="o">+</span><span class="n">logf_step</span><span class="p">,</span> <span class="n">logf_step</span><span class="p">)</span>

        <span class="n">n_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">logf_binedges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">logpsd_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span>
        <span class="n">logf_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">)</span>

        <span class="n">logpsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_intervals</span><span class="p">):</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">logf_binedges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">logf_binedges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">logf</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">logf</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">))</span>

            <span class="n">logpsd_binned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">logpsd</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
            <span class="n">logf_binned</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub</span> <span class="o">+</span> <span class="n">lb</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">f_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logf_binned</span><span class="p">)</span>
        <span class="n">psd_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logpsd_binned</span><span class="p">)</span>
        <span class="c1"># frequency binning end</span>

        <span class="c1"># linear regression below</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">psd_binned</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">f_binned</span><span class="p">)</span>
        <span class="n">X_ex</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">X_ex</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">Y_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">std_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the slope we want</span>
            <span class="n">Y_reg</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># prediction based on linear regression</span>
            <span class="n">std_err</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">f_binned</span><span class="o">=</span><span class="n">f_binned</span><span class="p">,</span> <span class="n">psd_binned</span><span class="o">=</span><span class="n">psd_binned</span><span class="p">,</span> <span class="n">Y_reg</span><span class="o">=</span><span class="n">Y_reg</span><span class="p">,</span> <span class="n">std_err</span><span class="o">=</span><span class="n">std_err</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">beta2HurstIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Translate psd slope to Hurst index</span>

<span class="sd">        Args:</span>
<span class="sd">            beta (float): the estimated slope of a power spectral density curve</span>

<span class="sd">        Returns:</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1)</span>

<span class="sd">        References:</span>
<span class="sd">            Equation 2 in http://www.bearcave.com/misl/misl_tech/wavelets/hurst/</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">H</span>

    <span class="k">def</span> <span class="nf">psd_ar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_noise</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">ar_params</span><span class="p">,</span> <span class="n">f_sampling</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the theoretical power spectral density (PSD) of an autoregressive model</span>

<span class="sd">        Args:</span>
<span class="sd">            var_noise (float): the variance of the noise of the AR process</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            ar_params (array): autoregressive coefficients, not including zero-lag</span>
<span class="sd">            f_sampling (float): sampling frequency</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ar_params</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">tmp</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">freqs</span><span class="o">/</span><span class="n">f_sampling</span><span class="p">)</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">var_noise</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ar_params</span><span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">fBMsim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Simple method to generate fractional Brownian Motion</span>

<span class="sd">        Args:</span>
<span class="sd">            N (int): the length of the simulated time series</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1). The relationship between H and the scaling exponent beta is</span>
<span class="sd">                H = (beta-1) / 2</span>

<span class="sd">        Returns:</span>
<span class="sd">            xfBm (array): the simulated fractional Brownian Motion time series</span>

<span class="sd">        References:</span>
<span class="sd">            1. http://cours-physique.lps.ens.fr/index.php/TD11_Correlated_Noise_2011</span>
<span class="sd">            2. https://www.wikiwand.com/en/Fractional_Brownian_motion</span>

<span class="sd">        @authors: jeg, fzhu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">H</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">H</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;H should be in (0, 1)!&quot;</span>

        <span class="n">HH</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">H</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span>  <span class="c1"># number of steps</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
                <span class="n">covariance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">covariance</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">HH</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">HH</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">HH</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">covariance</span><span class="p">)</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="n">ns</span><span class="p">))</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

        <span class="n">xfBm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">xfBm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
            <span class="n">xfBm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfBm</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">eta</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">xfBm</span>

    <span class="k">def</span> <span class="nf">psd_fBM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the theoretical psd of a fBM</span>

<span class="sd">        Args:</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            ts (array): the time axis of the time series</span>
<span class="sd">            H (float): Hurst index, should be in (0, 1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            psd (array): power spectral density</span>

<span class="sd">        References:</span>
<span class="sd">            Flandrin, P. On the spectrum of fractional Brownian motions.</span>
<span class="sd">                IEEE Transactions on Information Theory 35, 197–199 (1989).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">psd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nf</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freqs</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span>
            <span class="n">psd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">/</span><span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">H</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">get_wwz_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the wwz function to use.</span>

<span class="sd">        Args:</span>
<span class="sd">            nproc (int): the number of processes for multiprocessing</span>
<span class="sd">            method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                          &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                          &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py (default)</span>
<span class="sd">        Returns:</span>
<span class="sd">            wwz_func (function): the wwz function to use</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
        <span class="n">wa</span><span class="o">.</span><span class="n">assertPositiveInt</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Foster&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwz_nproc</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Kirchner&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nproc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_basic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_nproc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">kirchner_f2py</span>

        <span class="k">return</span> <span class="n">wwz_func</span>

    <span class="k">def</span> <span class="nf">prepare_wwz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">len_bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bc_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the truncated time series with NaNs deleted and estimate frequency vector and tau</span>

<span class="sd">        Args:</span>
<span class="sd">            ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">            ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">            freqs (array): vector of frequency. If None, use the nfft method.If using Lomb-Scargle, additional parameters</span>
<span class="sd">                may be set. See make_freq_vector</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">                if the boundaries of tau are not exactly on two of the time axis points, then tau will be adjusted to be so</span>
<span class="sd">            len_bd (int): the number of the ghost grids want to create on each boundary</span>
<span class="sd">            bc_mode (str): see np.lib.pad()</span>
<span class="sd">            reflect_type (str): see np.lib.pad()</span>

<span class="sd">        Returns:</span>
<span class="sd">            ys_cut (array): the truncated time series with NaNs deleted</span>
<span class="sd">            ts_cut (array): the truncated time axis of the original time series with NaNs deleted</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ys</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">med_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">//</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">med_res</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The input tau contains some NaNs.&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;It will be regenerated using the boundarys of the time axis of the time series with NaNs deleted,&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;with the length of the size of the input tau.&quot;</span><span class="p">)</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;tau should be within the time span of the time series.&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;Note that sometimes if the leading points of the time series are NaNs,&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;they will be deleted and cause np.min(tau) &lt; np.min(ts).&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;A new tau with the same size of the input tau will be generated.&quot;</span><span class="p">)</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The boundaries of tau are not exactly on two of the time axis points,&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;and it will be adjusted to be so.&quot;</span><span class="p">)</span>
            <span class="n">tau_lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">ts</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)])</span>
            <span class="n">tau_ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">ts</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">)])</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tau_lb</span><span class="p">,</span> <span class="n">tau_ub</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>

        <span class="c1"># boundary condition</span>
        <span class="k">if</span> <span class="n">len_bd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span>
            <span class="n">dtau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
            <span class="n">len_bd_tau</span> <span class="o">=</span> <span class="n">len_bd</span><span class="o">*</span><span class="n">dt</span><span class="o">//</span><span class="n">dtau</span>

            <span class="k">if</span> <span class="n">bc_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetric&#39;</span><span class="p">]:</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="p">(</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">),</span> <span class="n">bc_mode</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="n">reflect_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="p">(</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">),</span> <span class="n">bc_mode</span><span class="p">)</span>

            <span class="n">ts_left_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="o">*</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">)</span>
            <span class="n">ts_right_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">)</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ts_left_bd</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ts_right_bd</span><span class="p">))</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The tau will be regenerated to fit the boundary condition.&quot;</span><span class="p">)</span>
            <span class="n">tau_left_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dtau</span><span class="o">*</span><span class="n">len_bd_tau</span><span class="p">,</span> <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dtau</span><span class="p">,</span> <span class="n">len_bd_tau</span><span class="p">)</span>
            <span class="n">tau_right_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dtau</span><span class="p">,</span> <span class="n">tau</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dtau</span><span class="o">*</span><span class="n">len_bd_tau</span><span class="p">,</span> <span class="n">len_bd_tau</span><span class="p">)</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">tau_left_bd</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">tau_right_bd</span><span class="p">))</span>

        <span class="c1"># truncate the time series when the range of tau is smaller than that of the time series</span>
        <span class="n">ts_cut</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">))]</span>
        <span class="n">ys_cut</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span>

    <span class="k">def</span> <span class="nf">cross_wt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cross wavelet transform.</span>

<span class="sd">        Args:</span>
<span class="sd">            coeff1, coeff2 (array): the two sets of wavelet transform coefficients **in the form of a1 + a2*1j**</span>
<span class="sd">            freqs (array): vector of frequency</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        Returns:</span>
<span class="sd">            xw_amplitude (array): the cross wavelet amplitude</span>
<span class="sd">            xw_phase (array): the cross wavelet phase</span>

<span class="sd">        References:</span>
<span class="sd">            1.Grinsted, A., Moore, J. C. &amp; Jevrejeva, S. Application of the cross wavelet transform and</span>
<span class="sd">                wavelet coherence to geophysical time series. Nonlin. Processes Geophys. 11, 561–566 (2004).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xwt</span> <span class="o">=</span> <span class="n">coeff1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span>
        <span class="n">xw_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xwt</span><span class="o">.</span><span class="n">real</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">xwt</span><span class="o">.</span><span class="n">imag</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">xwt</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">xwt</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xwt</span><span class="p">,</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span>

    <span class="k">def</span> <span class="nf">wavelet_coherence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff1</span><span class="p">,</span> <span class="n">coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the cross wavelet coherence.</span>

<span class="sd">        Args:</span>
<span class="sd">            coeff1, coeff2 (array): the two sets of wavelet transform coefficients **in the form of a1 + a2*1j**</span>
<span class="sd">            freqs (array): vector of frequency.</span>
<span class="sd">            tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>

<span class="sd">        Returns:</span>
<span class="sd">            xw_coherence (array): the cross wavelet coherence</span>

<span class="sd">        References:</span>
<span class="sd">            1. Grinsted, A., Moore, J. C. &amp; Jevrejeva, S. Application of the cross wavelet transform and</span>
<span class="sd">                wavelet coherence to geophysical time series. Nonlin. Processes Geophys. 11, 561–566 (2004).</span>
<span class="sd">            2. Matlab code by Grinsted (https://github.com/grinsted/wavelet-coherence)</span>
<span class="sd">            3. Python code by Sebastian Krieger (https://github.com/regeirk/pycwt)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">rect</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Rectangular function adapted from https://github.com/regeirk/pycwt/blob/master/pycwt/helpers.py</span>

<span class="sd">            Args:</span>
<span class="sd">                length (int): length of the rectangular function</span>
<span class="sd">                normalize (bool): normalize or not</span>

<span class="sd">            Returns:</span>
<span class="sd">                rect (array): the (normalized) rectangular function</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">rect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rect</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">rect</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                <span class="n">rect</span> <span class="o">/=</span> <span class="n">rect</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">rect</span>

        <span class="k">def</span> <span class="nf">Smoothing</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">snorm</span><span class="p">,</span> <span class="n">dj</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="n">smooth_factor</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Soothing function adapted from https://github.com/regeirk/pycwt/blob/master/pycwt/helpers.py</span>

<span class="sd">            Args:</span>
<span class="sd">                coeff (array): the wavelet coefficients get from wavlet transform **in the form of a1 + a2*1j**</span>
<span class="sd">                snorm (array): normalized scales</span>
<span class="sd">                dj (float): it satisfies the equation [ Sj = S0 * 2**(j*dj) ]</span>

<span class="sd">            Returns:</span>
<span class="sd">                rect (array): the (normalized) rectangular function</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">def</span> <span class="nf">fft_kwargs</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">))))}</span>

            <span class="n">W</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

            <span class="c1"># Smooth in time</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">fft_kwargs</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="c1"># Notes by Smoothing by Gaussian window (absolute value of wavelet function)</span>
            <span class="c1"># using the convolution theorem: multiplication by Gaussian curve in</span>
            <span class="c1"># Fourier domain for each scale, outer product of scale and frequency</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">smooth_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">snorm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">k2</span><span class="p">)</span>  <span class="c1"># Outer product</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">F</span> <span class="o">*</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">fft_kwargs</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])),</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Along Fourier frequencies</span>
                              <span class="o">**</span><span class="n">fft_kwargs</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">overwrite_x</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n</span><span class="p">]</span>  <span class="c1"># Remove possibly padded region due to FFT</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">real</span>

            <span class="c1"># Smooth in scale</span>
            <span class="n">wsize</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">/</span> <span class="n">dj</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">win</span> <span class="o">=</span> <span class="n">rect</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">wsize</span><span class="p">)),</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve2d</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">win</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">S</span>

        <span class="n">xwt</span> <span class="o">=</span> <span class="n">coeff1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span>
        <span class="n">power1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">power2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coeff2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">scales</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span>  <span class="c1"># `scales` here is the `Period` axis in the wavelet plot</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tau</span><span class="p">))</span>
        <span class="n">snorm</span> <span class="o">=</span> <span class="n">scales</span> <span class="o">/</span> <span class="n">dt</span>  <span class="c1"># normalized scales</span>

        <span class="c1"># with WWZ method, we don&#39;t have a constant dj, so we will just take the average over the whole scale range</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">scales</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sN</span> <span class="o">=</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">sN</span><span class="o">/</span><span class="n">s0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>

        <span class="n">S12</span> <span class="o">=</span> <span class="n">Smoothing</span><span class="p">(</span><span class="n">xwt</span><span class="o">/</span><span class="n">scales</span><span class="p">,</span> <span class="n">snorm</span><span class="p">,</span> <span class="n">dj</span><span class="p">)</span>
        <span class="n">S1</span> <span class="o">=</span> <span class="n">Smoothing</span><span class="p">(</span><span class="n">power1</span><span class="o">/</span><span class="n">scales</span><span class="p">,</span> <span class="n">snorm</span><span class="p">,</span> <span class="n">dj</span><span class="p">)</span>
        <span class="n">S2</span> <span class="o">=</span> <span class="n">Smoothing</span><span class="p">(</span><span class="n">power2</span><span class="o">/</span><span class="n">scales</span><span class="p">,</span> <span class="n">snorm</span><span class="p">,</span> <span class="n">dj</span><span class="p">)</span>
        <span class="n">xw_coherence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">S12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">S1</span><span class="o">*</span><span class="n">S2</span><span class="p">)</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">S12</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">S2</span><span class="p">))</span>
        <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xw_coherence</span><span class="p">,</span> <span class="n">xw_phase</span>

    <span class="k">def</span> <span class="nf">reconstruct_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">len_bd</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Reconstruct the normalized time series from the wavelet coefficients.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            coeff (array): the coefficients of the corresponding basis functions (a0, a1, a2)</span>
<span class="sd">            freqs (array): vector of frequency of the basis functions</span>
<span class="sd">            tau (array): the evenly-spaced time points of the basis functions</span>
<span class="sd">            t (array): the specified evenly-spaced time points of the reconstructed time series</span>
<span class="sd">            len_bd (int): the number of the ghost grids want to creat on each boundary</span>

<span class="sd">        Returns:</span>
<span class="sd">            rec_ts (array): the reconstructed normalized time series</span>
<span class="sd">            t (array): the evenly-spaced time points of the reconstructed time series</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freqs</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">len_bd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_left_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="o">*</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">)</span>
            <span class="n">t_right_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dt</span><span class="o">*</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">len_bd</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_left_bd</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_right_bd</span><span class="p">))</span>

        <span class="n">ntau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">a_0</span><span class="p">,</span> <span class="n">a_1</span><span class="p">,</span> <span class="n">a_2</span> <span class="o">=</span> <span class="n">coeff</span>

        <span class="n">rec_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntau</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_0</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a_1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dz</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">tau</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">phi_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>
                    <span class="n">phi_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dz</span><span class="p">)</span>

                    <span class="n">rec_ts</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a_0</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">a_1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">phi_1</span> <span class="o">+</span> <span class="n">a_2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">phi_2</span><span class="p">)</span>

        <span class="n">rec_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">rec_ts</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rec_ts</span><span class="p">,</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">wavelet_evenly</span><span class="p">():</span>
        <span class="c1">#TODO</span>
        <span class="k">return</span>


<span class="k">class</span> <span class="nc">AliasFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Performing anti-alias filter on a psd @author: fzhu</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">alias_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">f_limit</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; anti_alias filter</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            freq (array): vector of frequencies in power spectrum</span>
<span class="sd">            pwr (array): vector of spectral power corresponding to frequencies &quot;freq&quot;</span>
<span class="sd">            fs (float): sampling frequency</span>
<span class="sd">            fc (float): corner frequency for 1/f^2 steepening of power spectrum</span>
<span class="sd">            f_limit (float): lower frequency limit for estimating misfit of model-plus-alias spectrum vs. measured power</span>
<span class="sd">            avgs (int): flag for whether spectrum is derived from instantaneous point measurements (avgs&lt;&gt;1)</span>
<span class="sd">                        OR from measurements averaged over each sampling interval (avgs==1)</span>

<span class="sd">        Returns:</span>
<span class="sd">            alpha (float): best-fit exponent of power-law model</span>
<span class="sd">            filtered_pwr (array): vector of alias-filtered spectral power</span>
<span class="sd">            model_pwr (array): vector of modeled spectral power</span>
<span class="sd">            aliased_pwr (array): vector of modeled spectral power, plus aliases</span>

<span class="sd">        References:</span>
<span class="sd">            1. Kirchner, J. W. Aliasing in 1/f(alpha) noise spectra: origins, consequences, and remedies.</span>
<span class="sd">                    Phys Rev E Stat Nonlin Soft Matter Phys 71, 66110 (2005).</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">log_pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pwr</span><span class="p">)</span>
        <span class="n">freq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;</span> <span class="n">f_limit</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span>  <span class="c1"># convert True &amp; False to 1 &amp; 0</span>

        <span class="n">alpha_upper_bound</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">alpha_lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.9</span>  <span class="c1"># if measurements are time-averaged</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>  <span class="c1"># if measurements are point samples</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fminbound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">misfit</span><span class="p">,</span> <span class="n">alpha_lower_bound</span><span class="p">,</span> <span class="n">alpha_upper_bound</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

        <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="n">filtered_pwr</span> <span class="o">=</span> <span class="n">pwr</span> <span class="o">*</span> <span class="n">model_pwr</span> <span class="o">/</span> <span class="n">aliased_pwr</span>

        <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">filtered_pwr</span><span class="p">,</span> <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span>

    <span class="k">def</span> <span class="nf">misfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RMSE</span>

    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_pwr</span><span class="p">,</span> <span class="n">freq_mask</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">model_pwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
        <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">model_pwr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="n">freq</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
            <span class="n">alias_minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alias_minus</span> <span class="o">=</span> <span class="n">alias_minus</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">alias_minus</span>

            <span class="n">alias_plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">)</span>  <span class="c1"># notice the + in (k*fs+freq)</span>
            <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alias_plus</span> <span class="o">=</span> <span class="n">alias_plus</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">((</span><span class="n">k</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">alias_plus</span>

        <span class="k">if</span> <span class="n">avgs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">beta</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>

        <span class="n">zo_minus</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="n">fs</span><span class="o">-</span><span class="n">freq</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">dz_minus</span> <span class="o">=</span> <span class="n">zo_minus</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">const</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span><span class="o">*</span><span class="n">dz_minus</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">fc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dz_minus</span>

        <span class="n">zo_plus</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="o">*</span><span class="n">fs</span><span class="o">+</span><span class="n">freq</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">dz_plus</span> <span class="o">=</span> <span class="n">zo_plus</span> <span class="o">/</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
            <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">+</span> <span class="n">const</span> <span class="o">/</span> <span class="p">((</span><span class="n">j</span><span class="o">*</span><span class="n">dz_plus</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">fc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dz_plus</span>

        <span class="n">log_aliased</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aliased_pwr</span><span class="p">)</span>

        <span class="n">prefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">log_pwr</span> <span class="o">-</span> <span class="n">log_aliased</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq_mask</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)</span>

        <span class="n">log_aliased</span> <span class="o">=</span> <span class="n">log_aliased</span> <span class="o">+</span> <span class="n">prefactor</span>
        <span class="n">aliased_pwr</span> <span class="o">=</span> <span class="n">aliased_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prefactor</span><span class="p">)</span>
        <span class="n">model_pwr</span> <span class="o">=</span> <span class="n">model_pwr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prefactor</span><span class="p">)</span>

        <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">log_aliased</span><span class="o">-</span><span class="n">log_pwr</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">log_aliased</span><span class="o">-</span><span class="n">log_pwr</span><span class="p">)</span><span class="o">*</span><span class="n">freq_mask</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freq_mask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_pwr</span><span class="p">,</span> <span class="n">aliased_pwr</span><span class="p">,</span> <span class="n">RMSE</span>

    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">avgs</span><span class="p">):</span>
        <span class="n">spectr</span> <span class="o">=</span> <span class="n">freq</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">freq</span><span class="o">/</span><span class="n">fc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spectr</span>


<span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Group various Filters under a class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">savitzky_golay</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Smooth (and optionally differentiate) data with a Savitzky-Golay filter.</span>

<span class="sd">        The Savitzky-Golay filter removes high frequency noise from data.</span>
<span class="sd">        It has the advantage of preserving the original shape and</span>
<span class="sd">        features of the signal better than other types of filtering</span>
<span class="sd">        approaches, such as moving averages techniques.</span>

<span class="sd">        The Savitzky-Golay is a type of low-pass filter, particularly</span>
<span class="sd">        suited for smoothing noisy data. The main idea behind this</span>
<span class="sd">        approach is to make for each point a least-square fit with a</span>
<span class="sd">        polynomial of high order over a odd-sized window centered at</span>
<span class="sd">        the point.</span>

<span class="sd">        Args:</span>
<span class="sd">            y (array): the values of the time history of the signal.</span>
<span class="sd">            window_size (int) : the length of the window. Must be an odd integer number.</span>
<span class="sd">            order (int) : the order of the polynomial used in the filtering. Must be less then `window_size` - 1.</span>
<span class="sd">            deriv (int): the order of the derivative to compute (default = 0 means only smoothing)</span>

<span class="sd">        Returns:</span>

<span class="sd">            ys - ndarray of shape (N), the smoothed signal (or it&#39;s n-th derivative).</span>

<span class="sd">        Reference:</span>

<span class="sd">            - A. Savitzky, M. J. E. Golay, Smoothing and Differentiation of</span>
<span class="sd">                Data by Simplified Least Squares Procedures. Analytical</span>
<span class="sd">                Chemistry, 1964, 36 (8), pp 1627-1639.</span>
<span class="sd">            - Numerical Recipes 3rd Edition: The Art of Scientific Computing</span>
<span class="sd">                W.H. Press, S.A. Teukolsky, W.T. Vetterling, B.P. Flannery</span>
<span class="sd">                Cambridge University Press ISBN-13: 9780521880688</span>
<span class="sd">            - SciPy Cookbook: shttps://github.com/scipy/scipy-cookbook/blob/master/ipython/SavitzkyGolay.ipynb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span><span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;window_size should be of type int&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;order should be of type int&quot;</span><span class="p">)</span>
        <span class="c1"># Check window size and order</span>
        <span class="k">if</span> <span class="n">window_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">window_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;window_size size must be a positive odd number&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">window_size</span> <span class="o">&lt;</span> <span class="n">order</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;window_size is too small for the polynomials order&quot;</span><span class="p">)</span>
        <span class="n">order_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">half_window</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># precompute coefficients</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">([[</span><span class="n">k</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order_range</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">half_window</span><span class="p">,</span> <span class="n">half_window</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">deriv</span><span class="p">]</span> <span class="o">*</span> <span class="n">rate</span><span class="o">**</span><span class="n">deriv</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">deriv</span><span class="p">)</span>
        <span class="c1"># pad the signal at the extremes with</span>
        <span class="c1"># values taken from the signal itself</span>
        <span class="n">firstvals</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">half_window</span><span class="o">+</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lastvals</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="n">half_window</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">firstvals</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lastvals</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">m</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tsPad</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">reflect_type</span> <span class="o">=</span> <span class="s1">&#39;odd&#39;</span><span class="p">,</span><span class="n">padFrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; tsPad: pad a timeseries based on timeseries model predictions</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            x (numpy array): Evenly-spaced timeseries</span>
<span class="sd">            t (numpy array): Time axis</span>
<span class="sd">            method (str): The method to use to pad the series</span>
<span class="sd">                - ARIMA: uses a fitted ARIMA model</span>
<span class="sd">                - reflect (default): Reflects the time series</span>
<span class="sd">            params (tuple): ARIMA model order parameters (p,d,q)</span>
<span class="sd">            reflect_type (str): </span>
<span class="sd">            padFrac (float): padding fraction (scalar) such that padLength = padFrac*length(series)</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            yp - padded timeseries</span>
<span class="sd">            tp - augmented axis</span>
<span class="sd">            </span>
<span class="sd">        Author: </span>
<span class="sd">            Julien Emile-Geay, Deborah Khider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">padLength</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">*</span><span class="n">padFrac</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ts needs to be composed of even increments&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># computp time interval</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ARIMA&#39;</span><span class="p">:</span>
            <span class="c1"># fit ARIMA model</span>
            <span class="n">fwd_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># model with time going forward</span>
            <span class="n">bwd_mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">ARIMA</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>  <span class="c1"># model with time going backwards</span>
        
            <span class="c1"># predict forward &amp; backward</span>
            <span class="n">fwd_pred</span>  <span class="o">=</span> <span class="n">fwd_mod</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">padLength</span><span class="p">);</span> <span class="n">yf</span> <span class="o">=</span> <span class="n">fwd_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bwd_pred</span>  <span class="o">=</span> <span class="n">bwd_mod</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">padLength</span><span class="p">);</span> <span class="n">yb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">bwd_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
        
            <span class="c1"># define extra time axes</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">+</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="n">padLength</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">-</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">padLength</span><span class="p">)</span>
        
            <span class="c1"># extend time series</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padLength</span><span class="o">*</span><span class="n">dt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
            <span class="n">yp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">ts</span><span class="p">)]</span> <span class="o">=</span><span class="n">ys</span>
            <span class="n">yp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">tb</span><span class="p">)]</span><span class="o">=</span><span class="n">yb</span>
            <span class="n">yp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">tf</span><span class="p">)]</span><span class="o">=</span><span class="n">yf</span>
       
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reflect&#39;</span><span class="p">:</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">ys</span><span class="p">,(</span><span class="n">padLength</span><span class="p">,</span><span class="n">padLength</span><span class="p">),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span><span class="n">reflect_type</span><span class="o">=</span><span class="n">reflect_type</span><span class="p">)</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">padLength</span><span class="p">,</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">padLength</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a valid argument. Enter &quot;ARIMA&quot; or &quot;reflect&quot;&#39;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">yp</span><span class="p">,</span> <span class="n">tp</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">butterworth</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">fs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">filter_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                    <span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;odd&#39;</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">padFrac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Applies a Butterworth filter with frequency fc, with padding</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            ys (numpy array): Timeseries </span>
<span class="sd">            fc (float or list): cutoff frequency. If scalar, it is interpreted as a low-frequency cutoff (lowpass)</span>
<span class="sd">                     If fc is a list,  it is interpreted as a frequency band (f1, f2), with f1 &lt; f2 (bandpass)</span>
<span class="sd">            fs (float): sampling frequency</span>
<span class="sd">            filter_order (int): order n of Butterworth filter</span>
<span class="sd">            pad (str): Indicates if padding is needed.</span>
<span class="sd">                - &#39;reflect&#39;: Reflects the timeseries</span>
<span class="sd">                - &#39;ARIMA&#39;: Uses an ARIMA model for the padding</span>
<span class="sd">                - None: No padding. </span>
<span class="sd">            params (tuple): model parameters for ARIMA model (if pad = True)</span>
<span class="sd">            padFrac (float): fraction of the series to be padded</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            yf - filtered array</span>
<span class="sd">        </span>
<span class="sd">        Author: </span>
<span class="sd">            Julien Emile-Geay</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fs</span>
    
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">nyq</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">fc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">nyq</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="p">[</span><span class="n">fl</span><span class="p">,</span> <span class="n">fh</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">/</span> <span class="n">nyq</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">filter_order</span><span class="p">,</span> <span class="n">fl</span> <span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;lowpass&#39;</span><span class="p">)</span>
    
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span> <span class="c1"># define time axis</span>
        
        <span class="k">if</span> <span class="n">pad</span><span class="o">==</span><span class="s1">&#39;ARIMA&#39;</span><span class="p">:</span>
            <span class="n">yp</span><span class="p">,</span><span class="n">tp</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">tsPad</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;ARIMA&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">padFrac</span><span class="o">=</span><span class="n">padFrac</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pad</span><span class="o">==</span><span class="s1">&#39;reflect&#39;</span><span class="p">:</span>
            <span class="n">yp</span><span class="p">,</span><span class="n">tp</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">tsPad</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="n">reflect_type</span><span class="p">,</span> <span class="n">padFrac</span><span class="o">=</span><span class="n">padFrac</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">ys</span><span class="p">;</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not a valid argument. Enter &quot;ARIMA&quot;, &quot;reflect&quot; or None&#39;</span><span class="p">)</span> 
    
        <span class="n">ypf</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">yp</span><span class="p">)</span>
        <span class="n">yf</span>  <span class="o">=</span> <span class="n">ypf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="n">ts</span><span class="p">)]</span>
    
        <span class="k">return</span> <span class="n">yf</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Interface for the users below, more checks about the input will be performed here</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="ar1_fit"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.ar1_fit">[docs]</a><span class="k">def</span> <span class="nf">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39; Returns the lag-1 autocorrelation from ar1 fit OR persistence from tauest.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): the time series</span>
<span class="sd">        ts (array): the time axis of that series</span>
<span class="sd">        detrend (str): &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">            params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">                corresponds to the window size (default it set to half of the data)</span>
<span class="sd">                while the second parameter correspond to the order of the filter</span>
<span class="sd">                (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">                (the default is zero, which means only smoothing.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        g (float): lag-1 autocorrelation coefficient (for evenly-spaced time series)</span>
<span class="sd">        OR estimated persistence (for unevenly-spaced time series)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_fit_evenly</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="ar1_sim"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.ar1_sim">[docs]</a><span class="k">def</span> <span class="nf">ar1_sim</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39; Produce p realizations of an AR1 process of length n with lag-1 autocorrelation g calculated from `ys` and `ts`</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">        n, p (int): dimensions as n rows by p columns</span>
<span class="sd">        ts (array): the time axis of that series</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>

<span class="sd">    Returns:</span>
<span class="sd">        red (matrix): n rows by p columns matrix of an AR1 process</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>  <span class="c1"># declare array</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">wa</span><span class="o">.</span><span class="n">is_evenly_spaced</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

        <span class="c1"># specify model parameters (statsmodel wants lag0 coefficents as unity)</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="p">]</span>  <span class="c1"># AR model parameter</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>  <span class="c1"># MA model parameters</span>
        <span class="n">sig_n</span> <span class="o">=</span> <span class="n">sig</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># theoretical noise variance for red to achieve the same variance as ys</span>

        <span class="c1"># simulate AR(1) model for each column</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">arma_generate_sample</span><span class="p">(</span><span class="n">ar</span><span class="o">=</span><span class="n">ar</span><span class="p">,</span> <span class="n">ma</span><span class="o">=</span><span class="n">ma</span><span class="p">,</span> <span class="n">nsample</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sig_n</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">tau_est</span> <span class="o">=</span> <span class="n">ar1_fit</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">red</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">tau_est</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">red</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">red</span></div>


<div class="viewcode-block" id="wwz"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.wwz">[docs]</a><span class="k">def</span> <span class="nf">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">Neff_coi</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>\
        <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>\
        <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">,</span> <span class="n">len_bd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
        <span class="n">bc_mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;odd&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the weighted wavelet amplitude (WWA) with phase, AR1_q, and cone of influence, as well as WT coefficients</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">        ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        c (float): the decay constant, the default value 1/(8*np.pi**2) is good for most of the cases</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>
<span class="sd">        len_bd (int): the number of the ghost grids want to creat on each boundary</span>
<span class="sd">        bc_mode (str): see np.lib.pad()</span>
<span class="sd">        reflect_type (str): see np.lib.pad()</span>

<span class="sd">    Returns:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        Neffs (array): the matrix of effective number of points in the time-scale coordinates</span>
<span class="sd">        coeff (array): the wavelet transform coefficents</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#  if method == &#39;Kirchner_f2py&#39;:</span>
    <span class="c1">#      if not sys.platform.startswith(&#39;darwin&#39;):</span>
    <span class="c1">#          warnings.warn(&quot;WWZ method: the f2py version is only supported on macOS right now; will use python version instead.&quot;)</span>
    <span class="c1">#          method = &#39;Kirchner&#39;</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nMC should be larger than or equal to 0.&quot;</span>

    <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
                                                <span class="n">len_bd</span><span class="o">=</span><span class="n">len_bd</span><span class="p">,</span> <span class="n">bc_mode</span><span class="o">=</span><span class="n">bc_mode</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="n">reflect_type</span><span class="p">)</span>

    <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">get_wwz_func</span><span class="p">(</span><span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span>
                                        <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                        <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

    <span class="c1"># Monte-Carlo simulations of AR1 process</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="n">wwa_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
    <span class="n">AR1_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#  tauest = wa.tau_estimation(ys_cut, ts_cut, detrend=detrend, gaussianize=gaussianize, standardize=standardize)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations&#39;</span><span class="p">):</span>
            <span class="c1">#  r = wa.ar1_model(ts_cut, tauest)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts_cut</span><span class="p">)</span>
            <span class="n">wwa_red</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span>
                                                 <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                 <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
                <span class="n">AR1_q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa_red</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">AR1_q</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># calculate the cone of influence</span>
    <span class="n">coi</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff_coi</span><span class="p">)</span>

    <span class="n">Results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;wwa&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="s1">&#39;AR1_q&#39;</span><span class="p">,</span> <span class="s1">&#39;coi&#39;</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="s1">&#39;Neffs&#39;</span><span class="p">,</span> <span class="s1">&#39;coeff&#39;</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">wwa</span><span class="o">=</span><span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="o">=</span><span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="n">coeff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>

<span class="k">def</span> <span class="nf">lomb_scargle</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;precenter&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;normalize&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;make_freq_method&quot;</span> <span class="p">:</span> <span class="s2">&quot;nfft&quot;</span><span class="p">}):</span>
    <span class="k">return</span> <span class="n">SpectralAnalysis</span><span class="o">.</span><span class="n">lombs_cargle</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="wwz_psd"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.wwz_psd">[docs]</a><span class="k">def</span> <span class="nf">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the psd of a timeseries directly using wwz method.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series, NaNs will be deleted automatically</span>
<span class="sd">        ts (array): the time points, if `ys` contains any NaNs, some of the time points will be deleted accordingly</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        c (float): the decay constant, the default value 1e-3 is good for most of the cases</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>
<span class="sd">        gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">        standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>
<span class="sd">        Neff (int):</span>
<span class="sd">        anti_alias (bool): If True, uses anti-aliasing</span>
<span class="sd">        avgs (int): </span>

<span class="sd">    Returns:</span>
<span class="sd">        psd (array): power spectral density</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        psd_ar1_q95 (array): the 95% quantile of the psds of AR1 processes</span>
<span class="sd">        psd_ar1 (array): the psds of AR1 processes</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="c1"># get wwa but AR1_q is not needed here so set nMC=0</span>
    <span class="c1">#  wwa, _, _, coi, freqs, _, Neffs, _ = wwz(ys_cut, ts_cut, freqs=freqs, tau=tau, c=c, nproc=nproc, nMC=0,</span>
    <span class="n">res_wwz</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
              <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="n">psd</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwa2psd</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">wwa</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">res_wwz</span><span class="o">.</span><span class="n">Neffs</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="n">avgs</span><span class="p">)</span>
    <span class="c1">#  psd[1/freqs &gt; np.max(coi)] = np.nan  # cut off the unreliable part out of the coi</span>
    <span class="c1">#  psd = psd[1/freqs &lt;= np.max(coi)] # cut off the unreliable part out of the coi</span>
    <span class="c1">#  freqs = freqs[1/freqs &lt;= np.max(coi)]</span>

    <span class="c1"># Monte-Carlo simulations of AR1 process</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#  tauest = wa.tau_estimation(ys_cut, ts_cut, detrend=detrend)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations&#39;</span><span class="p">):</span>
            <span class="c1">#  r = wa.ar1_model(ts_cut, tauest)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">ys_cut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts_cut</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts_cut</span><span class="p">)</span>
            <span class="n">res_red</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                     <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                                     <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span>
                                                                     <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="n">psd_ar1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wwa2psd</span><span class="p">(</span><span class="n">res_red</span><span class="o">.</span><span class="n">wwa</span><span class="p">,</span> <span class="n">ts_cut</span><span class="p">,</span> <span class="n">res_red</span><span class="o">.</span><span class="n">Neffs</span><span class="p">,</span>
                                       <span class="n">freqs</span><span class="o">=</span><span class="n">res_red</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">,</span> <span class="n">avgs</span><span class="o">=</span><span class="n">avgs</span><span class="p">)</span>
            <span class="c1">#  psd_ar1[i, 1/freqs_red &gt; np.max(coi_red)] = np.nan  # cut off the unreliable part out of the coi</span>
            <span class="c1">#  psd_ar1 = psd_ar1[1/freqs_red &lt;= np.max(coi_red)] # cut off the unreliable part out of the coi</span>

        <span class="n">psd_ar1_q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">psd_ar1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">psd_ar1_q95</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">Results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">,</span> <span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">,</span> <span class="s1">&#39;psd_ar1&#39;</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">psd</span><span class="o">=</span><span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="o">=</span><span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span><span class="o">=</span><span class="n">psd_ar1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="xwt"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.xwt">[docs]</a><span class="k">def</span> <span class="nf">xwt</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span>
        <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">Neff_coi</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the cross-wavelet transform of two time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys1, ys2 (array): the two time series</span>
<span class="sd">        ts1, ts2 (array): the time axis of the two time series</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        c (float): the decay constant, the default value 1/(8*np.pi**2) is good for most of the cases</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        detrend (str): None - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>
<span class="sd">        gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">        standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>

<span class="sd">    Returns:</span>
<span class="sd">        xw_amplitude (array): the cross wavelet amplitude</span>
<span class="sd">        xw_phase (array): the cross wavelet phase</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>

    <span class="n">wwz_func</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">get_wwz_func</span><span class="p">(</span><span class="n">nproc</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">coeff1</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span>
                               <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">coeff2</span> <span class="o">=</span> <span class="n">wwz_func</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span>
                               <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

    <span class="n">tauest1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>
    <span class="n">tauest2</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts1_cut</span><span class="p">,</span> <span class="n">tauest1</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">ar1_model</span><span class="p">(</span><span class="n">ts2_cut</span><span class="p">,</span> <span class="n">tauest2</span><span class="p">)</span>
    <span class="c1">#  r1 = ar1_sim(ys1_cut, np.size(ts1_cut), 1, ts=ts1_cut)</span>
    <span class="c1">#  r2 = ar1_sim(ys2_cut, np.size(ts2_cut), 1, ts=ts2_cut)</span>

    <span class="c1">#  wwa_red1, _, Neffs_red1, _ = wwz_func(r1, ts1_cut, freqs, tau, c=c, Neff=Neff, nproc=nproc, detrend=detrend,</span>
    <span class="c1">#                                        gaussianize=gaussianize, standardize=standardize)</span>
    <span class="c1">#  wwa_red2, _, Neffs_red2, _ = wwz_func(r2, ts2_cut, freqs, tau, c=c, Neff=Neff, nproc=nproc, detrend=detrend,</span>
    <span class="c1">#                                        gaussianize=gaussianize, standardize=standardize)</span>
    <span class="c1">#  psd1_ar1 = wa.wwa2psd(wwa_red1, ts1_cut, Neffs_red1, freqs=freqs, Neff=Neff, anti_alias=False, avgs=1)</span>
    <span class="c1">#  psd2_ar1 = wa.wwa2psd(wwa_red2, ts2_cut, Neffs_red2, freqs=freqs, Neff=Neff, anti_alias=False, avgs=1)</span>
    <span class="n">dt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts1</span><span class="p">))</span>
    <span class="n">dt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts2</span><span class="p">))</span>
    <span class="n">f_sampling_1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt1</span>
    <span class="n">f_sampling_2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt2</span>
    <span class="n">psd1_ar1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">psd_ar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tauest1</span><span class="p">,</span> <span class="n">f_sampling_1</span><span class="p">)</span>
    <span class="n">psd2_ar1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">psd_ar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">r2</span><span class="p">),</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tauest2</span><span class="p">,</span> <span class="n">f_sampling_2</span><span class="p">)</span>

    <span class="n">wt_coeff1</span> <span class="o">=</span> <span class="n">coeff1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">wt_coeff2</span> <span class="o">=</span> <span class="n">coeff2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">coeff2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">xwt</span><span class="p">,</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">cross_wt</span><span class="p">(</span><span class="n">wt_coeff1</span><span class="p">,</span> <span class="n">wt_coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

    <span class="n">sigma_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">)</span>
    <span class="n">sigma_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">)</span>
    <span class="n">nu</span><span class="p">,</span> <span class="n">Znu</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.9999</span>  <span class="c1"># according to `xwt.m` from Grinsted&#39;s MATLAB code</span>

    <span class="n">signif</span> <span class="o">=</span> <span class="n">sigma_1</span><span class="o">*</span><span class="n">sigma_2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psd1_ar1</span><span class="o">*</span><span class="n">psd2_ar1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Znu</span><span class="o">/</span><span class="n">nu</span>  <span class="c1"># Eq. (5) of Grinsted et al 2004</span>
    <span class="n">AR1_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">signif</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">coi</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff_coi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xwt</span><span class="p">,</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span></div>


<div class="viewcode-block" id="xwc"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.xwc">[docs]</a><span class="k">def</span> <span class="nf">xwc</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the cross-wavelet coherence of two time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        ys1, ys2 (array): the two time series</span>
<span class="sd">        ts1, ts2 (array): the time axis of the two time series</span>
<span class="sd">        tau (array): the evenly-spaced time points</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        c (float): the decay constant, the default value 1/(8*np.pi**2) is good for most of the cases</span>
<span class="sd">        Neff (int): effective number of points</span>
<span class="sd">        nproc (int): the number of processes for multiprocessing</span>
<span class="sd">        nMC (int): the number of Monte-Carlo simulations</span>
<span class="sd">        detrend (str): &#39;no&#39; - the original time series is assumed to have no trend;</span>
<span class="sd">                       &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>
<span class="sd">        gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">        standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">        method (str): &#39;Foster&#39; - the original WWZ method;</span>
<span class="sd">                      &#39;Kirchner&#39; - the method Kirchner adapted from Foster;</span>
<span class="sd">                      &#39;Kirchner_f2py&#39; - the method Kirchner adapted from Foster with f2py</span>

<span class="sd">    Returns:</span>
<span class="sd">        res (dict): contains the cross wavelet coherence, cross-wavelet phase,</span>
<span class="sd">            vector of frequency, evenly-spaced time points, AR1 sims, cone of influence</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;darwin&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The f2py version of WWZ is only supported on macOS &amp; Linux right now; will use the python version instead.&quot;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Kirchner&#39;</span>

    <span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nMC should be larger than or eaqual to 0.&quot;</span>

    <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb1</span><span class="p">,</span> <span class="n">ub1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts1</span><span class="p">)</span>
        <span class="n">lb2</span><span class="p">,</span> <span class="n">ub2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts2</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">lb1</span><span class="p">,</span> <span class="n">lb2</span><span class="p">])</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ub1</span><span class="p">,</span> <span class="n">ub2</span><span class="p">])</span>

        <span class="n">inside</span> <span class="o">=</span> <span class="n">ts1</span><span class="p">[(</span><span class="n">ts1</span><span class="o">&gt;=</span><span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts1</span><span class="o">&lt;=</span><span class="n">ub</span><span class="p">)]</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">inside</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Setting tau=</span><span class="si">{tau[:3]}</span><span class="s1">...</span><span class="si">{tau[-3:]}</span><span class="s1">, ntau={np.size(tau)}&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts1</span><span class="p">))</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">nv</span><span class="p">)</span>
        <span class="n">noct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts1</span><span class="p">)))</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">s0</span><span class="o">*</span><span class="n">a0</span><span class="o">**</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">noct</span><span class="o">*</span><span class="n">nv</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Setting freqs=</span><span class="si">{freqs[:3]}</span><span class="s1">...</span><span class="si">{freqs[-3:]}</span><span class="s1">, nfreqs={np.size(freqs)}&#39;</span><span class="p">)</span>

    <span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">freqs1</span><span class="p">,</span> <span class="n">tau1</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys1</span><span class="p">,</span> <span class="n">ts1</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">freqs2</span><span class="p">,</span> <span class="n">tau2</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">prepare_wwz</span><span class="p">(</span><span class="n">ys2</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">tau1</span> <span class="o">!=</span> <span class="n">tau2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inconsistent `tau`, recalculating...&#39;</span><span class="p">)</span>
        <span class="n">tau_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tau2</span><span class="p">)])</span>
        <span class="n">tau_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tau2</span><span class="p">)])</span>
        <span class="n">ntau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau2</span><span class="p">)])</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tau_min</span><span class="p">,</span> <span class="n">tau_max</span><span class="p">,</span> <span class="n">ntau</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tau1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">freqs1</span> <span class="o">!=</span> <span class="n">freqs2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inconsistent `freqs`, recalculating...&#39;</span><span class="p">)</span>
        <span class="n">freqs_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs2</span><span class="p">)])</span>
        <span class="n">freqs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs2</span><span class="p">)])</span>
        <span class="n">nfreqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs2</span><span class="p">)])</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">freqs_min</span><span class="p">,</span> <span class="n">freqs_max</span><span class="p">,</span> <span class="n">nfreqs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs1</span>

    <span class="k">if</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># delete 0 frequency if present</span>

    <span class="n">res_wwz1</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                   <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">res_wwz2</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                   <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="n">wt_coeff1</span> <span class="o">=</span> <span class="n">res_wwz1</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_wwz1</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="n">wt_coeff2</span> <span class="o">=</span> <span class="n">res_wwz2</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_wwz2</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>

    <span class="n">xw_coherence</span><span class="p">,</span> <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wavelet_coherence</span><span class="p">(</span><span class="n">wt_coeff1</span><span class="p">,</span> <span class="n">wt_coeff2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="n">smooth_factor</span><span class="p">)</span>
    <span class="n">xwt</span><span class="p">,</span> <span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">cross_wt</span><span class="p">(</span><span class="n">wt_coeff1</span><span class="p">,</span> <span class="n">wt_coeff2</span><span class="p">)</span>

    <span class="c1"># Monte-Carlo simulations of AR1 process</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>

    <span class="n">coherence_red</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
    <span class="n">AR1_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations&#39;</span><span class="p">):</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">ys1_cut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts1_cut</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts1_cut</span><span class="p">)</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">ys2_cut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts2_cut</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts2_cut</span><span class="p">)</span>
            <span class="n">res_wwz_r1</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">ts1_cut</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span>
                                                     <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                     <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>
            <span class="n">res_wwz_r2</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">ts2_cut</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span>
                                                     <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                                                     <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

            <span class="n">wt_coeffr1</span> <span class="o">=</span> <span class="n">res_wwz_r1</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_wwz_r2</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
            <span class="n">wt_coeffr2</span> <span class="o">=</span> <span class="n">res_wwz_r1</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_wwz_r2</span><span class="o">.</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
            <span class="n">coherence_red</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">phase_red</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">wavelet_coherence</span><span class="p">(</span><span class="n">wt_coeffr1</span><span class="p">,</span> <span class="n">wt_coeffr2</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">smooth_factor</span><span class="o">=</span><span class="n">smooth_factor</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
                <span class="n">AR1_q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">coherence_red</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">AR1_q</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">coi</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">)</span>
    <span class="n">Results</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;xw_coherence&#39;</span><span class="p">,</span> <span class="s1">&#39;xw_amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;xw_phase&#39;</span><span class="p">,</span> <span class="s1">&#39;xwt&#39;</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="s1">&#39;AR1_q&#39;</span><span class="p">,</span> <span class="s1">&#39;coi&#39;</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="n">xw_coherence</span><span class="o">=</span><span class="n">xw_coherence</span><span class="p">,</span> <span class="n">xw_amplitude</span><span class="o">=</span><span class="n">xw_amplitude</span><span class="p">,</span> <span class="n">xw_phase</span><span class="o">=</span><span class="n">xw_phase</span><span class="p">,</span> <span class="n">xwt</span><span class="o">=</span><span class="n">xwt</span><span class="p">,</span>
                  <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="n">coi</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="plot_wwa"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_wwa">[docs]</a><span class="k">def</span> <span class="nf">plot_wwa</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tick_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">clr_map</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span><span class="n">cbar_drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cone_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
             <span class="n">plot_signif</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">signif_style</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
             <span class="n">plot_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_cone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year CE&#39;</span><span class="p">,</span> 
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Period (years)&#39;</span><span class="p">,</span> <span class="n">cbar_orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
             <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">cbar_frac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">cbar_labelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the wavelet amplitude</span>

<span class="sd">    Args:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        AR1_q (array): AR1 simulations</span>
<span class="sd">        coi (array): cone of influence</span>
<span class="sd">        levels (array): levels of values to plot</span>
<span class="sd">        tick_range (array): levels of ticks to show on the colorbar</span>
<span class="sd">        yticks (list): ticks on y-axis</span>
<span class="sd">        ylim (list): limitations for y-axis</span>
<span class="sd">        xticks (list): ticks on x-axis</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        clr_map (str): the name of the colormap</span>
<span class="sd">        cbar_drawedges (bool): whether to draw edges on the colorbar or not</span>
<span class="sd">        cone_alpha (float): the alpha value for the area covered by cone of influence</span>
<span class="sd">        plot_signif (bool): plot 95% significant area or not</span>
<span class="sd">        signif_style (str): plot 95% significant area with `contour` or `shade`</span>
<span class="sd">        title (str): Title for the plot</span>
<span class="sd">        plot_cbar (bool): Plot the color scale bar</span>
<span class="sd">        plot_cone (bool): plot cone of influence</span>
<span class="sd">        ax: Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">        xlabel (str): The x-axis label</span>
<span class="sd">        ylabel (str): The y-axis label</span>
<span class="sd">        cbar_pad (float): the pad for the colorbar</span>
<span class="sd">        cbar_frac (float): the frac for the colorbar</span>
<span class="sd">        cbar_labelsize (float): the font size of the colorbar label</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">wwa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">q95</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There are outliers in the input amplitudes, &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;and the `levels` have been set so that the outpliers will be ignored! &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;One might want to use `Spectral.plot_wwadist(wwa)` to plot the distribution of &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;the amplitudes with the 95% quantile line to check if the levels are appropriate.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">max_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">q95</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_level</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_level</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>

    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">wwa</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">clr_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">wwa</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">clr_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_cbar</span><span class="p">:</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">drawedges</span><span class="o">=</span><span class="n">cbar_drawedges</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">cbar_frac</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">cbar_pad</span><span class="p">,</span>
                          <span class="n">ticks</span><span class="o">=</span><span class="n">tick_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cbar_labelsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_labelsize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e3</span><span class="p">:</span>
            <span class="n">yticks_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">yticks</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yticks_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span><span class="p">))</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Period (kyrs)&#39;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">,</span> <span class="n">yticks_label</span><span class="p">)</span>


    <span class="c1">#  xticks = ax.get_xticks()</span>
    <span class="c1">#  if np.abs(np.min(xticks)) &lt; 1e3:</span>
        <span class="c1">#  xticks_label = list(map(str, xticks))</span>
    <span class="c1">#  else:</span>
        <span class="c1">#  xticks_label = list(map(str, xticks/1e3))</span>
    <span class="c1">#  plt.xticks(xticks, xticks_label)</span>

    <span class="k">if</span> <span class="n">yticks_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yticks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yticks</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yticks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coi</span><span class="p">)]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_signif</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">AR1_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please set values for `AR1_q`!&quot;</span>
        <span class="n">signif</span> <span class="o">=</span> <span class="n">wwa</span> <span class="o">/</span> <span class="n">AR1_q</span>
        <span class="k">if</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;shade&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># significant if not shaded</span>

    <span class="k">if</span> <span class="n">plot_cone</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please set values for `coi`!&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">cone_alpha</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_coherence"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_coherence">[docs]</a><span class="k">def</span> <span class="nf">plot_coherence</span><span class="p">(</span><span class="n">res_xwc</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                   <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tick_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basey</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">clr_map</span><span class="o">=</span><span class="s1">&#39;OrRd&#39;</span><span class="p">,</span>
                   <span class="n">skip_x</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">skip_y</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
                   <span class="n">cbar_drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cone_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">plot_signif</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">signif_style</span><span class="o">=</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">plot_cone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Period&#39;</span><span class="p">,</span>
                   <span class="n">cbar_orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                   <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">cbar_frac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">cbar_labelsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot the wavelet coherence</span>

<span class="sd">    Args:</span>
<span class="sd">        res_xwc (dict): contains the cross wavelet coherence, cross-wavelet phase,</span>
<span class="sd">            vector of frequency, evenly-spaced time points, AR1 sims, </span>
<span class="sd">            cone of influence. See xwc</span>
<span class="sd">        pt (float): plot arrows above pt value</span>
<span class="sd">        levels (array): levels of values to plot</span>
<span class="sd">        tick_range (array): levels of ticks to show on the colorbar</span>
<span class="sd">        basey (int): log base for y. Default is 2. </span>
<span class="sd">        yticks (list): ticks on y-axis</span>
<span class="sd">        ylim (list): limitations for y-axis</span>
<span class="sd">        xticks (list): ticks on x-axis</span>
<span class="sd">        xlabels (list): List of labels for the x-axis ticks</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        clr_map (str): the name of the colormap</span>
<span class="sd">        skip_x, skip_y (float): plot every x,y points</span>
<span class="sd">        scale (int): Scale factor for arrows</span>
<span class="sd">        width (float):  Width of the arrows  </span>
<span class="sd">        cbar_drawedges (bool): whether to draw edges on the colorbar or not</span>
<span class="sd">        cone_alpha (float): the alpha value for the area covered by cone of influence</span>
<span class="sd">        plot_signif (bool): plot 95% significant area</span>
<span class="sd">        signif_style (str): plot 95% significant area with `contour` or `shade`</span>
<span class="sd">        title (str): Add a title to the plot</span>
<span class="sd">        plot_cone (bool): plot cone of influence</span>
<span class="sd">        ax: Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">        xlabel (str): The x-axis label</span>
<span class="sd">        ylabel (str): The y-axis label</span>
<span class="sd">        cbar_orientation (str): the orientation of the colorbar. Default is vertical</span>
<span class="sd">        cbar_pad (float): the pad for the colorbar</span>
<span class="sd">        cbar_frac (float): the frac for the colorbar</span>
<span class="sd">        cbar_labelsize (float): the font size of the colorbar label</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xw_coherence</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">xw_coherence</span>
    <span class="n">xw_phase</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">xw_phase</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">freqs</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">tau</span>
    <span class="n">AR1_q</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">AR1_q</span>
    <span class="n">coi</span> <span class="o">=</span> <span class="n">res_xwc</span><span class="o">.</span><span class="n">coi</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># plot coherence with significance test</span>
    <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">xw_coherence</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">clr_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">drawedges</span><span class="o">=</span><span class="n">cbar_drawedges</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">cbar_frac</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">cbar_pad</span><span class="p">,</span>
                      <span class="n">ticks</span><span class="o">=</span><span class="n">tick_range</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cbar_labelsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_labelsize</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">,</span> <span class="n">basey</span><span class="o">=</span><span class="n">basey</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xlabels</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_signif</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">AR1_q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Set values for `AR1_q`!&quot;</span>
        <span class="n">signif</span> <span class="o">=</span> <span class="n">xw_coherence</span> <span class="o">/</span> <span class="n">AR1_q</span>
        <span class="k">if</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">signif_style</span> <span class="o">==</span> <span class="s1">&#39;shade&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">signif</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># significant if not shaded</span>

    <span class="k">if</span> <span class="n">plot_cone</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please set values for `coi`!&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">cone_alpha</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="c1"># plot phase</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">xw_phase</span><span class="p">)</span>
    <span class="n">phase</span><span class="p">[</span><span class="n">xw_coherence</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span>
              <span class="n">U</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span> <span class="n">V</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span>
              <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_wwadist"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_wwadist">[docs]</a><span class="k">def</span> <span class="nf">plot_wwadist</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Plot the distribution of wwa with the 95% quantile line.</span>

<span class="sd">    Args:</span>
<span class="sd">        wwa (array): the weighted wavelet amplitude.</span>
<span class="sd">        ylim (list): limitations for y-axis</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the 2-D plot of wavelet analysis</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">wwa</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">q95</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_psd"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_psd">[docs]</a><span class="k">def</span> <span class="nf">plot_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">lmstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s2">&quot;denim blue&quot;</span><span class="p">],</span> <span class="n">ar1_lmstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
             <span class="n">ar1_linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_tickslabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="n">psd_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSD&#39;</span><span class="p">,</span> <span class="n">plot_ar1</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
             <span class="n">psd_ar1_q95</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
             <span class="n">psd_ar1_color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s2">&quot;pale red&quot;</span><span class="p">],</span> 
             <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_gridlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">period_label</span><span class="o">=</span><span class="s1">&#39;Period (years)&#39;</span><span class="p">,</span> <span class="n">psd_label</span><span class="o">=</span><span class="s1">&#39;Spectral Density&#39;</span><span class="p">,</span> 
             <span class="n">zorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot power spectral density</span>

<span class="sd">    Args</span>
<span class="sd">    ----</span>

<span class="sd">    psd : array</span>
<span class="sd">        power spectral density</span>
<span class="sd">    freqs : array</span>
<span class="sd">        vector of frequency</span>
<span class="sd">    period_ticks : list</span>
<span class="sd">        ticks for period</span>
<span class="sd">    period_tickslabel : list</span>
<span class="sd">        Labels for the period ticks</span>
<span class="sd">    psd_lim : list</span>
<span class="sd">        limits for spectral density axis</span>
<span class="sd">    label : str</span>
<span class="sd">        the label for the PSD</span>
<span class="sd">    plot_ar1 : bool</span>
<span class="sd">        plot the ar1 curve</span>
<span class="sd">    psd_ar1_q95 : array</span>
<span class="sd">        the 95% quantile of the AR1 PSD</span>
<span class="sd">    psd_ar1_color : str</span>
<span class="sd">        the color for the 95% quantile of the AR1 PSD</span>
<span class="sd">    title : str</span>
<span class="sd">        the title for the figure</span>
<span class="sd">    period_lim : list</span>
<span class="sd">        limits for period axis</span>
<span class="sd">    figsize : list</span>
<span class="sd">        the size for the figure</span>
<span class="sd">    ax : axis</span>
<span class="sd">        Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">    vertical : bool</span>
<span class="sd">        plot in vertical layout or not</span>
<span class="sd">    legend : bool</span>
<span class="sd">        plot legend</span>
<span class="sd">    lmstyle : str</span>
<span class="sd">        the line style</span>
<span class="sd">    linewidth : float</span>
<span class="sd">        the line width</span>
<span class="sd">    color : str</span>
<span class="sd">        Color of the line</span>
<span class="sd">    ar1_lmstyle : str</span>
<span class="sd">        line style for the AR1 ensemble</span>
<span class="sd">    ar1_linewidth : int</span>
<span class="sd">        line width for AR1 ensemble</span>
<span class="sd">    period_label : str</span>
<span class="sd">        the label for period</span>
<span class="sd">    psd_label : str</span>
<span class="sd">        the label for psd</span>
<span class="sd">    zorder : int</span>
<span class="sd">        the order of the layer</span>
<span class="sd">    period_tickslabel : str</span>
<span class="sd">        label for the period tick</span>
<span class="sd">    alpha : float</span>
<span class="sd">        set transparency</span>
<span class="sd">    label : str</span>
<span class="sd">        label for the figure</span>
<span class="sd">    plot_gridlines : bool</span>
<span class="sd">        Plot gridlines</span>
<span class="sd">    period_label : str</span>
<span class="sd">        label for the period axis</span>
<span class="sd">    psd_label : str</span>
<span class="sd">        label for the PSD axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    ax : figure</span>
<span class="sd">        the 2-D plot of wavelet analysis</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Perform WWZ and plot the PSD:</span>

<span class="sd">    .. plot::</span>
<span class="sd">        :context: close-figs</span>

<span class="sd">        &gt;&gt;&gt; from pyleoclim import Spectral</span>
<span class="sd">        &gt;&gt;&gt; from pyleoclim import Timeseries</span>
<span class="sd">        &gt;&gt;&gt; from pyleoclim import Examples</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; # make up a sine wave</span>
<span class="sd">        &gt;&gt;&gt; time = np.arange(2001)</span>
<span class="sd">        &gt;&gt;&gt; f = 1/50</span>
<span class="sd">        &gt;&gt;&gt; signal = np.cos(2*np.pi*f*time)</span>
<span class="sd">        &gt;&gt;&gt; # WWZ</span>
<span class="sd">        &gt;&gt;&gt; tau = np.linspace(np.min(time), np.max(time), 51)</span>
<span class="sd">        &gt;&gt;&gt; res_wwz = Spectral.wwz_psd(signal, time, tau=tau, c=1e-3, standardize=False, nMC=0)</span>
<span class="sd">        &gt;&gt;&gt; # plot</span>
<span class="sd">        &gt;&gt;&gt; fig = Spectral.plot_psd(</span>
<span class="sd">        ...           res_wwz.psd,</span>
<span class="sd">        ...           res_wwz.freqs,</span>
<span class="sd">        ...           period_ticks=[2, 5, 10, 20, 50, 100],</span>
<span class="sd">        ...           figsize=[10, 8],</span>
<span class="sd">        ...       )</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="n">psd</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">freqs</span>
        <span class="n">x_data_ar1</span> <span class="o">=</span> <span class="n">psd_ar1_q95</span>
        <span class="n">y_data_ar1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">freqs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">freqs</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">psd</span>
        <span class="n">x_data_ar1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">freqs</span>
        <span class="n">y_data_ar1</span> <span class="o">=</span> <span class="n">psd_ar1_q95</span>

    <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">lmstyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_ar1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">psd_ar1_q95</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psd_ar1_q95 is required!&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data_ar1</span><span class="p">,</span> <span class="n">y_data_ar1</span><span class="p">,</span> <span class="n">ar1_lmstyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">ar1_linewidth</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AR(1) 95%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">psd_ar1_color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">lmstyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_ar1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">psd_ar1_q95</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psd_ar1_q95 is required!&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data_ar1</span><span class="p">,</span> <span class="n">y_data_ar1</span><span class="p">,</span> <span class="n">ar1_lmstyle</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">ar1_linewidth</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AR(1) 95%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">psd_ar1_color</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposx</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vertical</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">period_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">psd_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">period_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">period_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">psd_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">psd_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">period_ticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">period_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">psd_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">period_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">period_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">psd_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">psd_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">period_tickslabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">period_ticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">period_tickslabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">plot_gridlines</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="plot_summary"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.plot_summary">[docs]</a><span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">c2</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> 
                 <span class="n">nMC</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                 <span class="n">gaussianize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">,</span>
                 <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">period_ticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_style</span><span class="o">=</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wwa_xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wwa_ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">psd_lmstyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">psd_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                 <span class="n">period_S_str</span><span class="o">=</span><span class="s1">&#39;beta_I&#39;</span><span class="p">,</span> <span class="n">period_S</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">period_L_str</span><span class="o">=</span><span class="s1">&#39;beta_D&#39;</span><span class="p">,</span> <span class="n">period_L</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">20</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot; Plot the time series with the wavelet analysis and psd</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">        ts (array): time axis of the time series</span>
<span class="sd">        freqs (array): vector of frequency</span>
<span class="sd">        tau (array): the evenly-spaced time points, namely the time shift for wavelet analysis</span>
<span class="sd">        c1 (float): the decay constant (wwz method)</span>
<span class="sd">        c2 (float): the decay constant (wwz_psd method)</span>
<span class="sd">        nMC(int): Number of Monte-Carlo simulations</span>
<span class="sd">        nproc (int): fake argument, just for convenience</span>
<span class="sd">        detrend (str): &#39;linear&#39; - a linear least-squares fit to `ys` is subtracted;</span>
<span class="sd">                       &#39;constant&#39; - the mean of `ys` is subtracted</span>
<span class="sd">                       &#39;savitzy-golay&#39; - ys is filtered using the Savitzky-Golay</span>
<span class="sd">                               filters and the resulting filtered series is subtracted from y.</span>
<span class="sd">        params (list): The paramters for the Savitzky-Golay filters. The first parameter</span>
<span class="sd">            corresponds to the window size (default it set to half of the data)</span>
<span class="sd">            while the second parameter correspond to the order of the filter</span>
<span class="sd">            (default is 4). The third parameter is the order of the derivative</span>
<span class="sd">            (the default is zero, which means only smoothing.)</span>
<span class="sd">        gaussianize (bool): If True, gaussianizes the timeseries</span>
<span class="sd">        standardize (bool): If True, standardizes the timeseries</span>
<span class="sd">        levels (array): levels of values to plot</span>
<span class="sd">        method (str): method for the WWZ transform. Default is Kirchner_f2py</span>
<span class="sd">        anti_alias (bool): If True, uses anti-aliasing</span>
<span class="sd">        period_ticks (list): ticks for period</span>
<span class="sd">        ts_color (str): the color for the time series curve</span>
<span class="sd">        ts_style (str): Style for the line</span>
<span class="sd">        title (str): the title for the time series plot</span>
<span class="sd">        ts_ylabel (str): label for y-axis in the time series plot</span>
<span class="sd">        wwa_xlabel (str): label for x-axis in the wwa plot</span>
<span class="sd">        wwa_ylabel (str): label for y-axis in the wwa plot</span>
<span class="sd">        psd_lmstyle (str): the line style in the psd plot</span>
<span class="sd">        psd_lim (list): the limits for psd</span>
<span class="sd">        font_scale (float): Scaling factor for the font on the plot</span>
<span class="sd">        period_S, period_L (list): the ranges for beta estimation</span>
<span class="sd">        period_S_str, period_L_str (str): String for beta estimation</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the summary plot</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title_font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="s1">&#39;24&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;verticalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;bottom&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">period_ticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">period_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>
        <span class="n">period_tickslabel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">period_ticks</span><span class="p">))</span>

    <span class="n">ylim_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="c1"># plot the time series</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;ticks&quot;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ts_style</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ts_color</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">title_font</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">ts_ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ts_ylabel</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># plot wwa</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1">#  wwa, phase, AR1_q, coi, freqs, tau, Neffs, coeff = \</span>
    <span class="n">res_wwz</span> <span class="o">=</span> <span class="n">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                  <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">wwa_xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wwa_ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_wwa</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">wwa</span><span class="p">,</span> <span class="n">res_wwz</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">res_wwz</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">AR1_q</span><span class="p">,</span>
                 <span class="n">yticks</span><span class="o">=</span><span class="n">period_ticks</span><span class="p">,</span> <span class="n">yticks_label</span><span class="o">=</span><span class="n">period_tickslabel</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="n">ylim_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">)],</span>
                 <span class="n">plot_cone</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_signif</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">wwa_xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">wwa_ylabel</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                 <span class="n">cbar_orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">cbar_labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cbar_frac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                 <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_wwa</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">wwa</span><span class="p">,</span> <span class="n">res_wwz</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">res_wwz</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="n">AR1_q</span><span class="o">=</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">AR1_q</span><span class="p">,</span>
                 <span class="n">yticks</span><span class="o">=</span><span class="n">period_ticks</span><span class="p">,</span> <span class="n">yticks_label</span><span class="o">=</span><span class="n">period_tickslabel</span><span class="p">,</span>
                 <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="n">ylim_min</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">)],</span>
                 <span class="n">plot_cone</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_signif</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span>
                 <span class="n">cbar_orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">cbar_labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">cbar_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cbar_frac</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span>
                 <span class="p">)</span>

    <span class="c1"># plot psd</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">:])</span>
    <span class="n">res_psd</span> <span class="o">=</span> <span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="n">nMC</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                      <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">gaussianize</span><span class="o">=</span><span class="n">gaussianize</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span>
                      <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">)</span>

    <span class="c1"># TODO: deal with period_ticks</span>
    <span class="n">plot_psd</span><span class="p">(</span><span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">plot_ar1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="o">=</span><span class="n">res_psd</span><span class="o">.</span><span class="n">psd_ar1_q95</span><span class="p">,</span>
             <span class="n">period_ticks</span><span class="o">=</span><span class="n">period_ticks</span><span class="p">[</span><span class="n">period_ticks</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">)],</span>
             <span class="n">period_lim</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">res_wwz</span><span class="o">.</span><span class="n">coi</span><span class="p">)],</span> <span class="n">psd_lim</span><span class="o">=</span><span class="n">psd_lim</span><span class="p">,</span>
             <span class="n">lmstyle</span><span class="o">=</span><span class="n">psd_lmstyle</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">period_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Estimated spectrum&#39;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">period_S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res_beta1</span> <span class="o">=</span> <span class="n">beta_estimation</span><span class="p">(</span><span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">period_S</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period_S</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">period_L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res_beta2</span> <span class="o">=</span> <span class="n">beta_estimation</span><span class="p">(</span><span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">period_L</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period_L</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_beta1</span><span class="o">.</span><span class="n">Y_reg</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">res_beta1</span><span class="o">.</span><span class="n">f_binned</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\</span><span class="si">{}</span><span class="s1">$ = </span><span class="si">{:.2f}</span><span class="s1">$\pm$</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period_S_str</span><span class="p">,</span> <span class="n">res_beta1</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">res_beta1</span><span class="o">.</span><span class="n">std_err</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\</span><span class="si">{}</span><span class="s1">$ = </span><span class="si">{:.2f}</span><span class="s1">$\pm$</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period_L_str</span><span class="p">,</span> <span class="n">res_beta2</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">res_beta2</span><span class="o">.</span><span class="n">std_err</span><span class="p">))</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_beta2</span><span class="o">.</span><span class="n">Y_reg</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">res_beta2</span><span class="o">.</span><span class="n">f_binned</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_beta1</span><span class="o">.</span><span class="n">Y_reg</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">res_beta1</span><span class="o">.</span><span class="n">f_binned</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\</span><span class="si">{}</span><span class="s1">$ = </span><span class="si">{:.2f}</span><span class="s1">$\pm$</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">period_S_str</span><span class="p">,</span> <span class="n">res_beta1</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">res_beta1</span><span class="o">.</span><span class="n">std_err</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="calc_plot_psd"><a class="viewcode-back" href="../../Spectral.html#pyleoclim.Spectral.calc_plot_psd">[docs]</a><span class="k">def</span> <span class="nf">calc_plot_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ntau</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">dcon</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">anti_alias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">period_ticks</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSD&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate the PSD and plot the result</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">        ts (array): time axis of the time series</span>
<span class="sd">        natu (int): the length of tau, the evenly-spaced time points, </span>
<span class="sd">            namely the time shift for wavelet analysis</span>
<span class="sd">        dcon (float): the decay constant</span>
<span class="sd">        standardize(bool): perform standardization or not</span>
<span class="sd">        anti_alias(bool): perform anti-alising procedure or not</span>
<span class="sd">        plot_fig (bool): plot the result or not</span>
<span class="sd">        method (str): the WWZ method to use</span>
<span class="sd">        nproc (int): the number of threads</span>
<span class="sd">        period_ticks (list): List of period ticks</span>
<span class="sd">        color (str): set color</span>
<span class="sd">        figsize (list): Size of the figure</span>
<span class="sd">        font_scale(float): Scale of the font</span>
<span class="sd">        lw (float): For plotting purposes</span>
<span class="sd">        label (str): Labeld for the y-axis</span>
<span class="sd">        zorder (int): the order of the layer</span>
<span class="sd">        xlim (list): x-axis limits</span>
<span class="sd">        ylim (list): y-axis limits</span>
<span class="sd">        loc (str): location for the legend</span>
<span class="sd">        bbox_to_anchor (list): gives a great degree of control for manual </span>
<span class="sd">            legend placement. For example, if you want your axes legend</span>
<span class="sd">            located at the figure’s top right-hand corner instead of the axes’</span>
<span class="sd">            corner, simply specify the corner’s location, and the coordinate </span>
<span class="sd">            system of that location</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig (figure): the summary plot</span>
<span class="sd">        psd (array): the spectral density</span>
<span class="sd">        freqs (array): the frequency vector</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s1">&#39;denim blue&#39;</span><span class="p">]</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">ntau</span><span class="p">)</span>
    <span class="n">res_psd</span> <span class="o">=</span> <span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dcon</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="n">standardize</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">anti_alias</span><span class="o">=</span><span class="n">anti_alias</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_fig</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="n">font_scale</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                  <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">period_ticks</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spectral Density&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Period (years)&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bbox_to_anchor</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span> <span class="n">res_psd</span><span class="o">.</span><span class="n">freqs</span></div>


<span class="c1"># some alias</span>
<span class="n">wa</span> <span class="o">=</span> <span class="n">WaveletAnalysis</span><span class="p">()</span>
<span class="n">beta_estimation</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">beta_estimation</span>
<span class="n">tau_estimation</span> <span class="o">=</span> <span class="n">wa</span><span class="o">.</span><span class="n">tau_estimation</span>

<span class="k">def</span> <span class="nf">spectral</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mtm&#39;</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&#39;&#39;&#39; Call periodogram from scipy</span>

<span class="sd">    Args:</span>
<span class="sd">        ys (array): a time series</span>
<span class="sd">        ts (array): time axis of the time series</span>
<span class="sd">        method (str, {&#39;mtm&#39;, &#39;periodogram&#39;, &#39;welch&#39;, &#39;lombscargle&#39;}): the available methods</span>
<span class="sd">        nMC (int): the number of surrogates of AR(1) process for significance test; 0 means no test</span>
<span class="sd">        qs (float): the quantile used for significance test</span>
<span class="sd">        kwargs (dict): the dictionary for arguments, for the details please see the methods under class SpectralAnalysis()</span>

<span class="sd">    Returns:</span>
<span class="sd">        res_dict (dict): the result dictionary, including</span>
<span class="sd">            - freqs (array): the frequency vector</span>
<span class="sd">            - psd (array): the spectral density vector</span>
<span class="sd">            - psd_ar1_q95 (array): the spectral density vector</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># spectral analysis</span>
    <span class="n">sa</span> <span class="o">=</span> <span class="n">SpectralAnalysis</span><span class="p">()</span>
    <span class="n">spec_func</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mtm&#39;</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">mtm</span><span class="p">,</span>
        <span class="s1">&#39;periodogram&#39;</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">periodogram</span><span class="p">,</span>
        <span class="s1">&#39;welch&#39;</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">welch</span><span class="p">,</span>
        <span class="s1">&#39;lombscargle&#39;</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">lombscargle</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">res_dict</span> <span class="o">=</span> <span class="n">spec_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># significance test with AR(1)</span>
    <span class="k">if</span> <span class="n">nMC</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;freqs&#39;</span><span class="p">])</span>
        <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nMC</span><span class="p">,</span> <span class="n">nf</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nMC</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo simulations&#39;</span><span class="p">):</span>
            <span class="n">ar1_noise</span> <span class="o">=</span> <span class="n">ar1_sim</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">res_red</span> <span class="o">=</span> <span class="n">spec_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="n">ar1_noise</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">psd_ar1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">res_red</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span>

        <span class="n">psd_ar1_q95</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">psd_ar1</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psd_ar1_q95</span>

    <span class="k">return</span> <span class="n">res_dict</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Deborah Khider, Feng Zhu, Julien Emile-Geay

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>