

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyleoclim.core.ui &mdash; Pyleoclim 0.5.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Pyleoclim
          

          
          </a>

          
            
            
              <div class="version">
                0.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citation.html">Citing Pyleoclim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core/ui.html">Series (pyleoclim.Series)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils/introduction.html">Pyleoclim Utilities (pyleoclim.utils)</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pyleoclim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyleoclim.core.ui</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyleoclim.core.ui</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39; The application interface for the users</span>

<span class="sd">@author: fengzhu</span>

<span class="sd">Created on Jan 31, 2020</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">tsutils</span><span class="p">,</span> <span class="n">plotting</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">lipdutils</span><span class="p">,</span> <span class="n">tsmodel</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">wavelet</span> <span class="k">as</span> <span class="n">waveutils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">spectral</span> <span class="k">as</span> <span class="n">specutils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">correlation</span> <span class="k">as</span> <span class="n">corrutils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">causality</span> <span class="k">as</span> <span class="n">causalutils</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">decomposition</span>

<span class="c1">#from textwrap import dedent</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#import pandas as pd</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">ScalarFormatter</span><span class="p">,</span> <span class="n">FormatStrFormatter</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="c1">#from matplotlib.colors import BoundaryNorm, Normalize</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="kn">import</span> <span class="n">mquantiles</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">lipd</span> <span class="k">as</span> <span class="nn">lpd</span>


<span class="k">def</span> <span class="nf">dict2namedtuple</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">tupletype</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;tupletype&#39;</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tupletype</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

<div class="viewcode-block" id="Series"><a class="viewcode-back" href="../../../core/ui.html#pyleoclim.core.ui.Series">[docs]</a><span class="k">class</span> <span class="nc">Series</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; Create a pyleoSeries object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    time : list or numpy.array</span>
<span class="sd">        Time values for the time series</span>

<span class="sd">    value : list of numpy.array</span>
<span class="sd">        ordinate values for the time series</span>

<span class="sd">    time_name : string</span>
<span class="sd">        Name of the time vector (e.g., &#39;Age&#39;).</span>
<span class="sd">        Default is None. This is used to label the time axis on plots</span>

<span class="sd">    time_unit : string</span>
<span class="sd">        Units for the time vector (e.g., &#39;yr B.P.&#39;).</span>
<span class="sd">        Default is None</span>

<span class="sd">    value_name : string</span>
<span class="sd">        Name of the value vector (e.g., &#39;temperature&#39;)</span>
<span class="sd">        Default is None</span>

<span class="sd">    value_unit : string</span>
<span class="sd">        Units for the value vector (e.g., &#39;deg C&#39;)</span>

<span class="sd">    label : string</span>
<span class="sd">        Name of the time series (e.g., &#39;Nino 3.4&#39;)</span>

<span class="sd">    clean_ts : bool</span>
<span class="sd">        remove the NaNs and let the time axis to be increasing if True</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    In this example, we import the Southern Oscillation Index (SOI) into a pandas dataframe and create a PyleoSeries object. </span>

<span class="sd">    .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">        import pyleoclim as pyleo</span>
<span class="sd">        import pandas as pd</span>
<span class="sd">        data=pd.read_csv(</span>
<span class="sd">            &#39;https://raw.githubusercontent.com/LinkedEarth/Pyleoclim_util/Development/example_data/soi_data.csv&#39;,</span>
<span class="sd">            skiprows=0, header=1</span>
<span class="sd">        )</span>
<span class="sd">        time=data.iloc[:,1]</span>
<span class="sd">        value=data.iloc[:,2]</span>
<span class="sd">        ts=pyleo.Series(</span>
<span class="sd">            time=time, value=value,</span>
<span class="sd">            time_name=&#39;Year (CE)&#39;, value_name=&#39;SOI&#39;, label=&#39;SOI&#39;</span>
<span class="sd">        )</span>
<span class="sd">        ts</span>
<span class="sd">        ts.__dict__.keys()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">clean_ts</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_name</span> <span class="o">=</span> <span class="n">time_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_name</span> <span class="o">=</span> <span class="n">value_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span> <span class="o">=</span> <span class="n">value_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

    <span class="k">def</span> <span class="nf">make_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialization of labels</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        time_header : str</span>
<span class="sd">            Label for the time axis</span>
<span class="sd">        value_header : str</span>
<span class="sd">            Label for the value axis</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_name_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_name_str</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value_name_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_name_str</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value_name_str</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value_name_str</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_name_str</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="si">}</span><span class="s1">]&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_header</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">time_name_str</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">time_header</span><span class="p">,</span> <span class="n">value_header</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints out the series in a table format and length of the series</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            length of the timeseries.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">time_label</span><span class="p">,</span> <span class="n">value_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_labels</span><span class="p">()</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">time_label</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">value_label</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute basic statistics for the time series</span>
<span class="sd">        </span>
<span class="sd">        Computes the mean, median, min, max, standard deviation, and interquartile range of a numpy array y, ignoring NaNs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        res : dictionary</span>
<span class="sd">            Contains the mean, median, minimum value, maximum value, standard</span>
<span class="sd">            deviation, and interquartile range for the Series.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        Compute basic statistics for the SOI series</span>
<span class="sd">        </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">            import pyleoclim as pyleo</span>
<span class="sd">            import pandas as pd</span>
<span class="sd">            data=pd.read_csv(&#39;https://raw.githubusercontent.com/LinkedEarth/Pyleoclim_util/Development/example_data/soi_data.csv&#39;,skiprows=0,header=1)</span>
<span class="sd">            time=data.iloc[:,1]</span>
<span class="sd">            value=data.iloc[:,2]</span>
<span class="sd">            ts=pyleo.Series(time=time,value=value,time_name=&#39;Year C.E&#39;, value_name=&#39;SOI&#39;, label=&#39;SOI&#39;)</span>
<span class="sd">            ts.stats()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">IQR</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">simple_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">res</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span><span class="n">mean</span><span class="p">,</span>
             <span class="s1">&#39;median&#39;</span><span class="p">:</span><span class="n">median</span><span class="p">,</span>
             <span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="n">min_</span><span class="p">,</span>
             <span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">max_</span><span class="p">,</span>
             <span class="s1">&#39;std&#39;</span><span class="p">:</span><span class="n">std</span><span class="p">,</span>
             <span class="s1">&#39;IQR&#39;</span><span class="p">:</span> <span class="n">IQR</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
             <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the timeseries</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        marker : str</span>
<span class="sd">            e.g., &#39;o&#39; for dots</span>
<span class="sd">            See [matplotlib.markers](https://matplotlib.org/3.1.3/api/markers_api.html) for details</span>

<span class="sd">        markersize : float</span>
<span class="sd">            the size of the marker</span>
<span class="sd">        </span>
<span class="sd">        color : str, list</span>
<span class="sd">            the color for the line plot</span>
<span class="sd">            e.g., &#39;r&#39; for red</span>
<span class="sd">            See [matplotlib colors] (https://matplotlib.org/3.2.1/tutorials/colors/colors.html) for details</span>

<span class="sd">        linestyle : str</span>
<span class="sd">            e.g., &#39;--&#39; for dashed line</span>
<span class="sd">            See [matplotlib.linestyles](https://matplotlib.org/3.1.0/gallery/lines_bars_and_markers/linestyles.html) for details</span>

<span class="sd">        linewidth : float</span>
<span class="sd">            the width of the line</span>

<span class="sd">        label : str</span>
<span class="sd">            the label for the line</span>

<span class="sd">        xlabel : str</span>
<span class="sd">            the label for the x-axis</span>

<span class="sd">        ylabel : str</span>
<span class="sd">            the label for the y-axis</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>
<span class="sd">        </span>
<span class="sd">        zorder : int</span>
<span class="sd">            The default drawing order for all lines on the plot</span>

<span class="sd">        legend : {True, False}</span>
<span class="sd">            plot legend or not</span>

<span class="sd">        plot_kwargs : dict</span>
<span class="sd">            the dictionary of keyword arguments for ax.plot()</span>
<span class="sd">            See [matplotlib.pyplot.plot](https://matplotlib.org/3.1.3/api/_as_gen/matplotlib.pyplot.plot.html) for details</span>

<span class="sd">        lgd_kwargs : dict</span>
<span class="sd">            the dictionary of keyword arguments for ax.legend()</span>
<span class="sd">            See [matplotlib.pyplot.legend](https://matplotlib.org/3.1.3/api/_as_gen/matplotlib.pyplot.legend.html) for details</span>
<span class="sd">            </span>
<span class="sd">        alpha : float</span>
<span class="sd">            Transparency setting</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>

<span class="sd">        ax : matplotlib.axis, optional</span>
<span class="sd">            the axis object from matplotlib</span>
<span class="sd">            See [matplotlib.axes](https://matplotlib.org/api/axes_api.html) for details.</span>
<span class="sd">        </span>
<span class="sd">        mute : {True,False}</span>
<span class="sd">            if True, the plot will not show;</span>
<span class="sd">            recommend to turn on when more modifications are going to be made on ax</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        fig : matplotlib.figure</span>
<span class="sd">            the figure object from matplotlib</span>
<span class="sd">            See [matplotlib.pyplot.figure](https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.pyplot.figure.html) for details.</span>

<span class="sd">        ax : matplotlib.axis</span>
<span class="sd">            the axis object from matplotlib</span>
<span class="sd">            See [matplotlib.axes](https://matplotlib.org/api/axes_api.html) for details.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        When `ax` is passed, the return will be `ax` only; otherwise, both `fig` and `ax` will be returned.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        Plot the SOI record</span>
<span class="sd">        </span>
<span class="sd">            .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">                import pyleoclim as pyleo</span>
<span class="sd">                import pandas as pd</span>
<span class="sd">                data=pd.read_csv(&#39;https://raw.githubusercontent.com/LinkedEarth/Pyleoclim_util/Development/example_data/soi_data.csv&#39;,skiprows=0,header=1)</span>
<span class="sd">                time=data.iloc[:,1]</span>
<span class="sd">                value=data.iloc[:,2]</span>
<span class="sd">                ts=pyleo.Series(time=time,value=value,time_name=&#39;Year C.E&#39;, value_name=&#39;SOI&#39;, label=&#39;SOI&#39;)</span>
<span class="sd">                @savefig ts_plot.png</span>
<span class="sd">                fig,ax = ts.plot()</span>
<span class="sd">        </span>
<span class="sd">        Change the line color</span>
<span class="sd">        </span>
<span class="sd">            .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">                @savefig ts_plot2.png</span>
<span class="sd">                fig, ax = ts.plot(color=&#39;r&#39;)</span>
<span class="sd">        </span>
<span class="sd">        Save the figure. Two options available:</span>
<span class="sd">            * Within the plotting command</span>
<span class="sd">            * After the figure has been generated</span>
<span class="sd">        </span>
<span class="sd">            .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">                #@savefig ts_plot3.png </span>
<span class="sd">                fig,ax = ts.plot(color=&#39;k&#39;,savefig_settings={&#39;path&#39;:&#39;ts_plot3.png&#39;})</span>
<span class="sd">                pyleo.savefig(fig,path=&#39;ts_plot3.png&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># generate default axis labels</span>
        <span class="n">time_label</span><span class="p">,</span> <span class="n">value_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="n">time_label</span>

        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">value_label</span>

        <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">marker</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">markersize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="n">markersize</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">linestyle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;linestyle&#39;</span><span class="p">:</span> <span class="n">linestyle</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">linewidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;zorder&#39;</span><span class="p">:</span> <span class="n">zorder</span><span class="p">})</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">plot_xy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span>
            <span class="n">plot_kwargs</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span>
            <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">ssa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Singular Spectrum Analysis</span>
<span class="sd">        </span>
<span class="sd">        Nonparametric, orthogonal decomposition of timeseries into constituent oscillations.</span>
<span class="sd">        This implementation  uses the method of [1], with applications presented in [2]</span>
<span class="sd">        Optionally (MC&gt;0), the significance of eigenvalues is assessed by Monte-Carlo simulations of an AR(1) model fit to X, using [3].</span>
<span class="sd">        The method expects regular spacing, but is tolerant to missing values, up to a fraction 0&lt;f&lt;1 (see [4]).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        M : int, optional</span>
<span class="sd">            window size. The default is None (10% of the length of the series).</span>
<span class="sd">        MC : int, optional</span>
<span class="sd">            Number of iteration in the Monte-Carlo process. The default is 0.</span>
<span class="sd">        f : float, optional</span>
<span class="sd">            maximum allowable fraction of missing values. The default is 0.5.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : dict</span>
<span class="sd">            Containing:</span>

<span class="sd">            - eig_val : (M, 1) array of eigenvalue spectrum of length r, the number of SSA modes. As in Principal Component Analysis, eigenvaluesare closely related to the fraction of variance accounted for (&quot;explained&quot;, a common but not-so-helpful term) by each mode.</span>
<span class="sd">            </span>
<span class="sd">            - eig_vec : is a matrix of the temporal eigenvectors (T-EOFs), i.e. the temporal patterns that explain most of the variations in the original series.</span>
<span class="sd">                </span>
<span class="sd">            - PC : (N - M + 1, M) array of principal components, i.e. the loadings that, convolved with the T-EOFs, produce the reconstructed components, or RCs</span>

<span class="sd">            - RC : (N,  M) array of reconstructed components, One can think of each RC as the contribution of each mode to the timeseries, weighted by their eigenvalue (loosely speaking, their &quot;amplitude&quot;). Summing over all columns of RC recovers the original series. (synthesis, the reciprocal operation of analysis).</span>

<span class="sd">            - eig_val_q : (M, 2) array containing the 5% and 95% quantiles of the Monte-Carlo eigenvalue spectrum [ if MC &gt;0 ]</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        SSA with SOI</span>
<span class="sd">        </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">            import pyleoclim as pyleo</span>
<span class="sd">            import pandas as pd</span>
<span class="sd">            data=pd.read_csv(&#39;https://raw.githubusercontent.com/LinkedEarth/Pyleoclim_util/Development/example_data/soi_data.csv&#39;,skiprows=0,header=1)</span>
<span class="sd">            time=data.iloc[:,1]</span>
<span class="sd">            value=data.iloc[:,2]</span>
<span class="sd">            ts=pyleo.Series(time=time,value=value,time_name=&#39;Year C.E&#39;, value_name=&#39;SOI&#39;, label=&#39;SOI&#39;)</span>
<span class="sd">            #plot</span>
<span class="sd">            @savefig ts_plot.png</span>
<span class="sd">            fig,ax = ts.plot()</span>
<span class="sd">            #SSA</span>
<span class="sd">            nino_ssa = ts.ssa(M=60)</span>
<span class="sd">        </span>
<span class="sd">        Let us now see how to make use of all these arrays. The first step is too inspect the eigenvalue spectrum (&quot;scree plot&quot;) to identify remarkable modes. Let us restrict ourselves to the first 40, so we can see something:</span>
<span class="sd">            </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">            import matplotlib.pyplot as plt</span>
<span class="sd">            import matplotlib.gridspec as gridspec</span>
<span class="sd">            import numpy as np</span>
<span class="sd">            </span>
<span class="sd">            d  = nino_ssa[&#39;eig_val&#39;] # extract eigenvalue vector</span>
<span class="sd">            M  = len(d)  # infer window size</span>
<span class="sd">            de = d*np.sqrt(2/(M-1))</span>
<span class="sd">            var_pct = d**2/np.sum(d**2)*100  # extract the fraction of variance attributable to each mode</span>

<span class="sd">            # plot eigenvalues</span>
<span class="sd">            r = 20</span>
<span class="sd">            rk = np.arange(0,r)+1</span>
<span class="sd">            fig,ax = plt.subplots()</span>
<span class="sd">            ax.errorbar(rk,d[:r],yerr=de[:r],label=&#39;SSA eigenvalues w/ 95% CI&#39;)</span>
<span class="sd">            ax.set_title(&#39;Scree plot of SSA eigenvalues&#39;)</span>
<span class="sd">            ax.set_xlabel(&#39;Rank $i$&#39;); plt.ylabel(r&#39;$\lambda_i$&#39;)</span>
<span class="sd">            ax.legend(loc=&#39;upper right&#39;)   </span>
<span class="sd">            @savefig scree_plot.png</span>
<span class="sd">            pyleo.showfig(fig)</span>
<span class="sd">        </span>
<span class="sd">        This highlights a few common phenomena with SSA:</span>
<span class="sd">            * the eigenvalues are in descending order</span>
<span class="sd">            * their uncertainties are proportional to the eigenvalues themselves</span>
<span class="sd">            * the eigenvalues tend to come in pairs : (1,2) (3,4), are all clustered within uncertainties . (5,6) looks like another doublet </span>
<span class="sd">            * around i=15, the eigenvalues appear to reach a floor, and all subsequent eigenvalues explain a very small amount of variance.</span>
<span class="sd">        </span>
<span class="sd">        So, summing the variance of all modes higher than 19, we get:</span>
<span class="sd">            </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">            print(var_pct[15:].sum()*100)</span>
<span class="sd">        </span>
<span class="sd">        That is, over 95% of the variance is in the first 15 modes. That is a typical result for a &quot;warm-colored&quot; timeseries, which is most geophysical timeseries; a few modes do the vast majority of the work. That means we can focus our attention on these modes and capture most of the interesting behavior. To see this, let&#39;s use the reconstructed components (RCs), and sum the RC matrix over the first 15 columns:</span>
<span class="sd">        </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">            RCk = nino_ssa[&#39;RC&#39;][:,:14].sum(axis=1)</span>
<span class="sd">            fig, ax = ts.plot(title=&#39;ONI&#39;,mute=True) # we mute the first call to only get the plot with 2 lines</span>
<span class="sd">            ax.plot(time,RCk,label=&#39;SSA reconstruction, 14 modes&#39;,color=&#39;orange&#39;)</span>
<span class="sd">            ax.legend()</span>
<span class="sd">            @savefig ssa_recon.png</span>
<span class="sd">            pyleo.showfig(fig) </span>
<span class="sd">        </span>
<span class="sd">        Indeed, these first few modes capture the vast majority of the low-frequency behavior, including all the El Niño/La Niña events. What is left (the blue wiggles not captured in the orange curve) are high-frequency oscillations that might be considered &quot;noise&quot; from the standpoint of ENSO dynamics. This illustrates how SSA might be used for filtering a timeseries. One must be careful however:</span>
<span class="sd">            * there was not much rhyme or reason for picking 15 modes. Why not 5, or 39? All we have seen so far is that they gather &gt;95% of the variance, which is by no means a magic number.</span>
<span class="sd">            * there is no guarantee that the first few modes will filter out high-frequency behavior, or at what frequency cutoff they will do so. If you need to cut out specific frequencies, you are better off doing it with a classical filter, like the butterworth filter implemented in Pyleoclim. However, in many instances the choice of a cutoff frequency is itself rather arbitrary. In such cases, SSA provides a principled alternative for generating a version of a timeseries that preserves features and excludes others (i.e, a filter).</span>
<span class="sd">            * as with all orthgonal decompositions, summing over all RCs will recover the original signal within numerical precision.</span>
<span class="sd">        </span>
<span class="sd">        Monte-Carlo SSA</span>
<span class="sd">        </span>
<span class="sd">        Selecting meaningful modes in eigenproblems (e.g. EOF analysis) is more art than science. However, one technique stands out: Monte Carlo SSA, introduced by Allen &amp; Smith, (1996) to identiy SSA modes that rise above what one would expect from &quot;red noise&quot;, specifically an AR(1) process_process). To run it, simply provide the parameter MC, ideally with a number of iterations sufficient to get decent statistics. Here&#39;s let&#39;s use MC = 1000. The result will be stored in the eig_val_q array, which has the same length as eig_val, and its two columns contain the 5% and 95% quantiles of the ensemble of MC-SSA eigenvalues.</span>
<span class="sd">        </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">           nino_mcssa = ts.ssa(M = 60, nMC=1000)</span>
<span class="sd">        </span>
<span class="sd">        Now let&#39;s look at the result:</span>
<span class="sd">            </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">        </span>
<span class="sd">            d  = nino_mcssa[&#39;eig_val&#39;] # extract eigenvalue vector</span>
<span class="sd">            de = d*np.sqrt(2/(M-1))</span>
<span class="sd">            du = nino_mcssa[&#39;eig_val_q&#39;][:,0]  # extract upper quantile of MC-SSA eigenvalues</span>
<span class="sd">            dl = nino_mcssa[&#39;eig_val_q&#39;][:,1]  # extract lower quantile of MC-SSA eigenvalues</span>

<span class="sd">            # plot eigenvalues</span>
<span class="sd">            rk = np.arange(0,20)+1</span>
<span class="sd">            fig=plt.figure()</span>
<span class="sd">            plt.fill_between(rk,dl[:20],du[:20],color=&#39;silver&#39;,alpha=0.5,label=&#39;MC-SSA 95% CI&#39;)</span>
<span class="sd">            plt.errorbar(rk,d[:20],yerr=de[:20],label=&#39;SSA eigenvalues w/ 95% CI&#39;)</span>
<span class="sd">            plt.title(&#39;Scree plot of SSA eigenvalues, w/ MC-SSA bounds&#39;)</span>
<span class="sd">            plt.xlabel(&#39;Rank $i$&#39;); plt.ylabel(r&#39;$\lambda_i$&#39;)</span>
<span class="sd">            plt.legend(loc=&#39;upper right&#39;)</span>
<span class="sd">            @savefig scree_nmc.png</span>
<span class="sd">            pyleo.showfig(fig)</span>
<span class="sd">    </span>
<span class="sd">        This suggests that modes 1-5 fall above the red noise benchmark.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">ssa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">nMC</span><span class="o">=</span><span class="n">nMC</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">distplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;KDE&#39;</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the distribution of the timeseries values</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        Distribution of the SOI record</span>
<span class="sd">        </span>
<span class="sd">        .. ipython:: python</span>
<span class="sd">            </span>
<span class="sd">            import pyleoclim as pyleo</span>
<span class="sd">            import pandas as pd</span>
<span class="sd">            data=pd.read_csv(&#39;https://raw.githubusercontent.com/LinkedEarth/Pyleoclim_util/Development/example_data/soi_data.csv&#39;,skiprows=0,header=1)</span>
<span class="sd">            time=data.iloc[:,1]</span>
<span class="sd">            value=data.iloc[:,2]</span>
<span class="sd">            ts=pyleo.Series(time=time,value=value,time_name=&#39;Year C.E&#39;, value_name=&#39;SOI&#39;, label=&#39;SOI&#39;)</span>
<span class="sd">            @savefig ts_plot.png</span>
<span class="sd">            fig,ax = ts.plot()</span>
<span class="sd">            @savefig ts_dist.png</span>
<span class="sd">            fig,ax = ts.distplot()</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

        <span class="n">time_label</span><span class="p">,</span> <span class="n">value_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_labels</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">value_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">summary_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scalogram</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">time_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psd_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_signif_test</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">time_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psd_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate summary plot of spectral and wavelet analysis on a timeseries</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        psd : PSD</span>
<span class="sd">            the PSD object of a Series</span>

<span class="sd">        scalogram : Scalogram</span>
<span class="sd">            the Scalogram object of a Series</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>

<span class="sd">        time_lim : list or tuple</span>
<span class="sd">            the limitation of the time axis</span>

<span class="sd">        value_lim : list or tuple</span>
<span class="sd">            the limitation of the value axis of the timeseries</span>

<span class="sd">        period_lim : list or tuple</span>
<span class="sd">            the limitation of the period axis</span>

<span class="sd">        psd_lim : list or tuple</span>
<span class="sd">            the limitation of the psd axis</span>

<span class="sd">        time_label : str</span>
<span class="sd">            the label for the time axis</span>

<span class="sd">        value_label : str</span>
<span class="sd">            the label for the value axis of the timeseries</span>

<span class="sd">        period_label : str</span>
<span class="sd">            the label for the period axis</span>

<span class="sd">        psd_label : str</span>
<span class="sd">            the label for the amplitude axis of PDS</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">time_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">time_lim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">value_lim</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">scalogram</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scalogram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelet</span><span class="p">()</span><span class="o">.</span><span class="n">signif_test</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">n_signif_test</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scalogram</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">],</span> <span class="n">cbar_style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">})</span>

        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:],</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">psd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span><span class="p">()</span><span class="o">.</span><span class="n">signif_test</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">n_signif_test</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">period_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">period_lim</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">psd_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">psd_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">value_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">time_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">time_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">period_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;scal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">period_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">psd_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="s1">&#39;psd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">psd_label</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
            <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Clean up the timeseries by removing NaNs and sort with increasing time points</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_mod</span><span class="p">,</span> <span class="n">t_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">t_mod</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">gaussianize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">gaussianize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gap detection</span>

<span class="sd">        This function segments a timeseries into n number of parts following a gap</span>
<span class="sd">            detection algorithm. The rule of gap detection is very simple:</span>
<span class="sd">            we define the intervals between time points as dts, then if dts[i] is larger than factor * dts[i-1],</span>
<span class="sd">            we think that the change of dts (or the gradient) is too large, and we regard it as a breaking point</span>
<span class="sd">            and divide the time series into two segments here</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        ts : pyleoclim Series</span>

<span class="sd">        factor : float</span>
<span class="sd">            The factor that adjusts the threshold for gap detection</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        res : pyleoclim MultipleSeries Object or pyleoclim Series Object</span>
<span class="sd">            If gaps were detected, returns the segments in a MultipleSeries object,</span>
<span class="sd">            else, returns the original timeseries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seg_y</span><span class="p">,</span> <span class="n">seg_t</span><span class="p">,</span> <span class="n">n_segs</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">ts2segments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_y</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">s_list</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seg_y</span><span class="p">):</span>
                <span class="n">s_tmp</span><span class="o">=</span><span class="n">Series</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">seg_t</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">value</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">time_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_name</span><span class="p">,</span>
                             <span class="n">time_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_name</span><span class="p">,</span>
                             <span class="n">value_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="n">s_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_tmp</span><span class="p">)</span>
            <span class="n">res</span><span class="o">=</span><span class="n">MultipleSeries</span><span class="p">(</span><span class="n">series_list</span><span class="o">=</span><span class="n">s_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_y</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">res</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No timeseries detected&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timespan</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Slicing the timeseries with a timespan (tuple or list)</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        timespan : tuple or list</span>
<span class="sd">            The list of time points for slicing, whose length must be even.</span>
<span class="sd">            When there are n time points, the output Series includes n/2 segments.</span>
<span class="sd">            For example, if timespan = [a, b], then the sliced output includes one segment [a, b];</span>
<span class="sd">            if timespan = [a, b, c, d], then the sliced output includes segment [a, b] and segment [c, d].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        new : Series</span>
<span class="sd">            The sliced Series object.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timespan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_elements</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The number of elements in timespan must be even!&#39;</span><span class="p">)</span>

        <span class="n">n_segments</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_elements</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_segments</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="n">timespan</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">timespan</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">new</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;emd&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">v_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Perform spectral analysis on the timeseries</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        freq_method : str</span>
<span class="sd">            {&#39;scale&#39;, &#39;nfft&#39;, &#39;Lomb-Scargle&#39;, &#39;Welch&#39;}</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spec_func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wwz&#39;</span><span class="p">:</span> <span class="n">specutils</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">,</span>
            <span class="s1">&#39;mtm&#39;</span><span class="p">:</span> <span class="n">specutils</span><span class="o">.</span><span class="n">mtm</span><span class="p">,</span>
            <span class="s1">&#39;lomb_scargle&#39;</span><span class="p">:</span> <span class="n">specutils</span><span class="o">.</span><span class="n">lomb_scargle</span><span class="p">,</span>
            <span class="s1">&#39;welch&#39;</span><span class="p">:</span> <span class="n">specutils</span><span class="o">.</span><span class="n">welch</span><span class="p">,</span>
            <span class="s1">&#39;periodogram&#39;</span><span class="p">:</span> <span class="n">specutils</span><span class="o">.</span><span class="n">periodogram</span>
        <span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">freq_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">freq_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">freq_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span> <span class="o">**</span><span class="n">freq_kwargs</span><span class="p">)</span>

        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;wwz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;mtm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;lomb_scargle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;welch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;periodogram&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">spec_res</span> <span class="o">=</span> <span class="n">spec_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spec_res</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">spec_res</span> <span class="o">=</span> <span class="n">dict2namedtuple</span><span class="p">(</span><span class="n">spec_res</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

        <span class="n">psd</span> <span class="o">=</span> <span class="n">PSD</span><span class="p">(</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">spec_res</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="n">spec_res</span><span class="o">.</span><span class="n">psd</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">timeseries</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">spec_method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">spec_args</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">psd</span>

    <span class="k">def</span> <span class="nf">wavelet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Perform wavelet analysis on the timeseries</span>

<span class="sd">        cwt wavelets documented on https://pywavelets.readthedocs.io/en/latest/ref/cwt.html</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">wave_func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wwz&#39;</span><span class="p">:</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">wwz</span><span class="p">,</span>
            <span class="s1">&#39;cwt&#39;</span><span class="p">:</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">cwt</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">freq_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">freq_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">freq_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span> <span class="o">**</span><span class="n">freq_kwargs</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;wwz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;cwt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wavelet&#39;</span> <span class="p">:</span> <span class="s1">&#39;morl&#39;</span><span class="p">}</span>


        <span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">wave_res</span> <span class="o">=</span> <span class="n">wave_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
        <span class="n">scal</span> <span class="o">=</span> <span class="n">Scalogram</span><span class="p">(</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">wave_res</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">wave_res</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">amplitude</span><span class="o">=</span><span class="n">wave_res</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
            <span class="n">coi</span><span class="o">=</span><span class="n">wave_res</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
            <span class="n">timeseries</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">wave_method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">freq_method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span>
            <span class="n">freq_kwargs</span><span class="o">=</span><span class="n">freq_kwargs</span><span class="p">,</span>
            <span class="n">wave_args</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">scal</span>

    <span class="k">def</span> <span class="nf">wavelet_coherence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_series</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Perform wavelet coherence analysis with the target timeseries</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xwc_func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wwz&#39;</span><span class="p">:</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">xwc</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">freq_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">freq_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">freq_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span> <span class="o">**</span><span class="n">freq_kwargs</span><span class="p">)</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">target_series</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">dt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="n">dt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t2</span><span class="p">))</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">t1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">dt1</span><span class="p">,</span> <span class="n">dt2</span><span class="p">]))</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;wwz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span> <span class="n">freq</span><span class="p">}</span>
        <span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">xwc_res</span> <span class="o">=</span> <span class="n">xwc_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">target_series</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">target_series</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>

        <span class="n">coh</span> <span class="o">=</span> <span class="n">Coherence</span><span class="p">(</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">xwc_res</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span>
            <span class="n">time</span><span class="o">=</span><span class="n">xwc_res</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="n">coherence</span><span class="o">=</span><span class="n">xwc_res</span><span class="o">.</span><span class="n">xw_coherence</span><span class="p">,</span>
            <span class="n">phase</span><span class="o">=</span><span class="n">xwc_res</span><span class="o">.</span><span class="n">xw_phase</span><span class="p">,</span>
            <span class="n">coi</span><span class="o">=</span><span class="n">xwc_res</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span>
            <span class="n">timeseries1</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">timeseries2</span><span class="o">=</span><span class="n">target_series</span><span class="p">,</span>
            <span class="n">freq_method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span>
            <span class="n">freq_kwargs</span><span class="o">=</span><span class="n">freq_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">coh</span>

    <span class="k">def</span> <span class="nf">correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_series</span><span class="p">,</span> <span class="n">timespan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Perform correlation analysis with the target timeseries</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">timespan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
            <span class="n">value2</span> <span class="o">=</span> <span class="n">target_series</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">timespan</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">value2</span> <span class="o">=</span> <span class="n">target_series</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">timespan</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="n">corr_res</span> <span class="o">=</span> <span class="n">corrutils</span><span class="o">.</span><span class="n">corr_sig</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr_res</span>

    <span class="k">def</span> <span class="nf">causality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_series</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;liang&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Perform causality analysis with the target timeseries</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spec_func</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;liang&#39;</span><span class="p">:</span><span class="n">causalutils</span><span class="o">.</span><span class="n">liang_causality</span><span class="p">,</span>
            <span class="s1">&#39;granger&#39;</span><span class="p">:</span><span class="n">causalutils</span><span class="o">.</span><span class="n">granger_causality</span><span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;liang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;granger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">causal_res</span> <span class="o">=</span> <span class="n">spec_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">target_series</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">causal_res</span>

    <span class="k">def</span> <span class="nf">surrogates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Generate surrogates with increasing time axis</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">surrogate_func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ar1&#39;</span><span class="p">:</span> <span class="n">tsmodel</span><span class="o">.</span><span class="n">ar1_sim</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;ar1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">}</span>
        <span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">surr_res</span> <span class="o">=</span> <span class="n">surrogate_func</span><span class="p">[</span><span class="n">method</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">surr_res</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">surr_res</span> <span class="o">=</span> <span class="n">surr_res</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">s_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surr_res</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">s_tmp</span> <span class="o">=</span> <span class="n">Series</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">time_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_name</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_name</span><span class="p">,</span> <span class="n">value_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value_unit</span><span class="p">)</span>
            <span class="n">s_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_tmp</span><span class="p">)</span>

        <span class="n">surr</span> <span class="o">=</span> <span class="n">SurrogateSeries</span><span class="p">(</span><span class="n">series_list</span><span class="o">=</span><span class="n">s_list</span><span class="p">,</span> <span class="n">surrogate_method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">surrogate_args</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">surr</span>

    <span class="k">def</span> <span class="nf">outliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig_outliers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fig_knee</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">plot_outliers_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_knee_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
                 <span class="n">saveknee_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">saveoutliers_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Detects outliers in a timeseries and removes if specified</span>
<span class="sd">        Args</span>
<span class="sd">        ----</span>
<span class="sd">        self : timeseries object</span>
<span class="sd">        auto : boolean</span>
<span class="sd">               True by default, detects knee in the plot automatically</span>
<span class="sd">        remove : boolean</span>
<span class="sd">               True by default, removes all outlier points if detected</span>
<span class="sd">       fig_knee  : boolean</span>
<span class="sd">               True by default, plots knee plot if true</span>
<span class="sd">       fig_outliers : boolean</span>
<span class="sd">                     True by degault, plots outliers if true</span>
<span class="sd">       save_knee : dict</span>
<span class="sd">                  default parameters from matplotlib savefig None by default</span>
<span class="sd">       save_outliers : dict</span>
<span class="sd">                  default parameters from matplotlib savefig None by default</span>
<span class="sd">      plot_knee_kwargs : dict</span>
<span class="sd">      plot_outliers_kwargs : dict</span>
<span class="sd">      figsize : list</span>
<span class="sd">               by default [10,4]</span>
<span class="sd">     Returns</span>
<span class="sd">     -------</span>
<span class="sd">        new : Series</span>
<span class="sd">             Time series with outliers removed if they exist</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1">#outlier_indices,fig1,ax1,fig2,ax2 = tsutils.detect_outliers(self.time, self.value, auto=auto, plot_knee=fig_knee,plot_outliers=fig_outliers,\</span>
        <span class="c1">#                                                   figsize=figsize,save_knee=save_knee,save_outliers=save_outliers,plot_outliers_kwargs=plot_outliers_kwargs,plot_knee_kwargs=plot_knee_kwargs)</span>
        <span class="n">outlier_indices</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">detect_outliers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="n">auto</span><span class="p">,</span> <span class="n">plot_knee</span><span class="o">=</span><span class="n">fig_knee</span><span class="p">,</span><span class="n">plot_outliers</span><span class="o">=</span><span class="n">fig_outliers</span><span class="p">,</span>\
                                                           <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">saveknee_settings</span><span class="o">=</span><span class="n">saveknee_settings</span><span class="p">,</span><span class="n">saveoutliers_settings</span><span class="o">=</span><span class="n">saveoutliers_settings</span><span class="p">,</span><span class="n">plot_outliers_kwargs</span><span class="o">=</span><span class="n">plot_outliers_kwargs</span><span class="p">,</span><span class="n">plot_knee_kwargs</span><span class="o">=</span><span class="n">plot_knee_kwargs</span><span class="p">)</span>
        <span class="n">outlier_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outlier_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">outlier_indices</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">outlier_indices</span><span class="p">)</span>
            <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ys</span>
            <span class="n">new</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">t</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Interpolate a time series onto  a new  time axis</span>

<span class="sd">        Available interpolation scheme includes linear and spline</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_mod</span><span class="p">,</span> <span class="n">v_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">interp_type</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">x_mod</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Bin values in a time series</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_mod</span><span class="p">,</span> <span class="n">v_mod</span> <span class="o">=</span> <span class="n">tsutils</span><span class="o">.</span><span class="n">bin_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">x_mod</span>
        <span class="n">new</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v_mod</span>
        <span class="k">return</span> <span class="n">new</span></div>

<span class="k">class</span> <span class="nc">PSD</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">spec_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spec_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_qs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_method</span> <span class="o">=</span> <span class="n">spec_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_args</span> <span class="o">=</span> <span class="n">spec_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">signif_qs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">signif_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="n">period_unit</span>
        <span class="k">elif</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">timeseries</span><span class="o">.</span><span class="n">time_unit</span><span class="si">}</span><span class="s1">s&#39;</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="s1">&#39;Amplitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Length: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">signif_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">],</span>
                    <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">surr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">surrogates</span><span class="p">(</span>
            <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
        <span class="p">)</span>
        <span class="n">surr_psd</span> <span class="o">=</span> <span class="n">surr</span><span class="o">.</span><span class="n">spectral</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_args</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">surr_psd</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">beta_est</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Estimate the scaling factor beta of the PSD in a log-log space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fmin : float</span>
<span class="sd">            the minimum frequency edge for beta estimation; the default is the minimum of the frequency vector of the PSD obj</span>

<span class="sd">        fmax : float</span>
<span class="sd">            the maximum frequency edge for beta estimation; the default is the maximum of the frequency vector of the PSD obj</span>

<span class="sd">        verbose : bool</span>
<span class="sd">            if True, will print out debug information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        res_dict : dictionary</span>
<span class="sd">            - beta: the scaling factor</span>
<span class="sd">            - std_err: the one standard deviation error of the scaling factor</span>
<span class="sd">            - f_binned: the binned frequency series, used as X for linear regression</span>
<span class="sd">            - psd_binned: the binned PSD series, used as Y for linear regression</span>
<span class="sd">            - Y_reg: the predicted Y from linear regression, used with f_binned for the slope curve plotting</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">beta_estimation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
            <span class="s1">&#39;std_err&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">std_err</span><span class="p">,</span>
            <span class="s1">&#39;f_binned&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">f_binned</span><span class="p">,</span>
            <span class="s1">&#39;psd_binned&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">psd_binned</span><span class="p">,</span>
            <span class="s1">&#39;Y_reg&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">Y_reg</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">res_dict</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_loglog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">plot_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_clr</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">signif_linestyles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">],</span> <span class="n">signif_linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the power sepctral density (PSD)</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lgd_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">lgd_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lgd_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="n">marker</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">markersize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="n">markersize</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">linestyle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;linestyle&#39;</span><span class="p">:</span> <span class="n">linestyle</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">linewidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="n">linewidth</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">zorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;zorder&#39;</span><span class="p">:</span> <span class="n">zorder</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_period</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Period [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Period&#39;</span>

            <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xticks_default</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">xticks_default</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x_axis</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xticks_default</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x_axis</span><span class="p">))</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="n">xticks_default</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xticks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xticks</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Frequency [1/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Frequency&#39;</span>

            <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xlim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xlim</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
            <span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span> <span class="o">=</span> <span class="n">y_axis</span><span class="p">,</span> <span class="n">x_axis</span>
            <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">xlim</span>
            <span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span> <span class="o">=</span> <span class="n">yticks</span><span class="p">,</span> <span class="n">xticks</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xlabel</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="c1"># plot significance levels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signif_method_label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ar1&#39;</span><span class="p">:</span> <span class="s1">&#39;AR(1)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">nqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">frequency</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">signif_x_axis</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">if</span> <span class="n">in_period</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="n">signif_y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
                    <span class="n">signif_x_axis</span><span class="p">,</span> <span class="n">signif_y_axis</span> <span class="o">=</span> <span class="n">signif_y_axis</span><span class="p">,</span> <span class="n">signif_x_axis</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">signif_x_axis</span><span class="p">,</span> <span class="n">signif_y_axis</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">signif_method_label</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">signif_method</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> threshold&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">signif_clr</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="n">signif_linestyles</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">signif_linewidth</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">in_loglog</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonpositive</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonpositive</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_legend</span><span class="p">:</span>
            <span class="n">lgd_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;frameon&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="n">lgd_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lgd_kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">lgd_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

<span class="k">class</span> <span class="nc">Scalogram</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">wave_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wave_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_qs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">period_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Args</span>
<span class="sd">        ----</span>
<span class="sd">            frequency : array</span>
<span class="sd">                the frequency axis</span>
<span class="sd">            time : array</span>
<span class="sd">                the time axis</span>
<span class="sd">            amplitude : array</span>
<span class="sd">                the amplitude at each (frequency, time) point;</span>
<span class="sd">                note the dimension is assumed to be (frequency, time)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coi</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave_method</span> <span class="o">=</span> <span class="n">wave_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave_args</span> <span class="o">=</span> <span class="n">wave_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">signif_qs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">signif_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_method</span> <span class="o">=</span> <span class="n">freq_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_kwargs</span> <span class="o">=</span> <span class="n">freq_kwargs</span>
        <span class="k">if</span> <span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="n">period_unit</span>
        <span class="k">elif</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">time_unit</span>
        <span class="k">if</span> <span class="n">time_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="n">time_label</span>
        <span class="k">elif</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">timeseries</span><span class="o">.</span><span class="n">time_name</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="s1">&#39;Amplitude&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Dimension: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">signif_clr</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">signif_linestyles</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">signif_linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">contourf_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">cbar_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="p">{},</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the scalogram from wavelet analysis</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">contourf_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
        <span class="n">contourf_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">contourf_style</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_period</span><span class="p">:</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Period [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Period&#39;</span>

            <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yticks_default</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">yticks_default</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_axis</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yticks_default</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_axis</span><span class="p">))</span>
                <span class="n">yticks</span> <span class="o">=</span> <span class="n">yticks_default</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Frequency [1/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Frequency&#39;</span>

        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span>

        <span class="n">cont</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">contourf_args</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

        <span class="c1"># plot colorbar</span>
        <span class="n">cbar_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;drawedges&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">}</span>
        <span class="n">cbar_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cbar_style</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_args</span><span class="p">)</span>

        <span class="c1"># plot cone of influence</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_axis</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_axis</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">)])]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># plot significance levels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signif_method_label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ar1&#39;</span><span class="p">:</span> <span class="s1">&#39;AR(1)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">signif_scal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">signif_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">signif_scal</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="n">signif_boundary</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">signif_clr</span><span class="p">,</span>
                <span class="n">linestyles</span><span class="o">=</span><span class="n">signif_linestyles</span><span class="p">,</span>
                <span class="n">linewidths</span><span class="o">=</span><span class="n">signif_linewidths</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">signif_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">],</span>
                    <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">surr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">surrogates</span><span class="p">(</span>
            <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
        <span class="p">)</span>
        <span class="n">surr_scal</span> <span class="o">=</span> <span class="n">surr</span><span class="o">.</span><span class="n">wavelet</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;qs should be a list with size 1!&#39;</span><span class="p">)</span>

        <span class="n">new</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">surr_scal</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="k">return</span> <span class="n">new</span>


<span class="k">class</span> <span class="nc">Coherence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">coherence</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">timeseries1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeseries2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_qs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signif_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">freq_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">period_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coherence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coherence</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coi</span> <span class="o">=</span> <span class="n">waveutils</span><span class="o">.</span><span class="n">make_coi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">Neff</span><span class="o">=</span><span class="n">Neff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries1</span> <span class="o">=</span> <span class="n">timeseries1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries2</span> <span class="o">=</span> <span class="n">timeseries2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">signif_qs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">signif_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_method</span> <span class="o">=</span> <span class="n">freq_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_kwargs</span> <span class="o">=</span> <span class="n">freq_kwargs</span>
        <span class="k">if</span> <span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="n">period_unit</span>
        <span class="k">elif</span> <span class="n">timeseries1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="o">=</span> <span class="n">timeseries1</span><span class="o">.</span><span class="n">time_unit</span>
        <span class="k">if</span> <span class="n">time_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="n">time_label</span>
        <span class="k">elif</span> <span class="n">timeseries1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">timeseries1</span><span class="o">.</span><span class="n">time_name</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
             <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">contourf_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">phase_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">cbar_style</span><span class="o">=</span><span class="p">{},</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="p">{},</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">signif_clr</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">signif_linestyles</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">signif_linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">under_clr</span><span class="o">=</span><span class="s1">&#39;ivory&#39;</span><span class="p">,</span> <span class="n">over_clr</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">bad_clr</span><span class="o">=</span><span class="s1">&#39;dimgray&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Plot the wavelet coherence result</span>

<span class="sd">        Args</span>
<span class="sd">        ----</span>

<span class="sd">        figsize : list</span>
<span class="sd">            a list of two integers indicating the figure size</span>

<span class="sd">        title : str</span>
<span class="sd">            the title for the figure</span>

<span class="sd">        savefig_settings : dict</span>
<span class="sd">            the dictionary of arguments for plt.savefig(); some notes below:</span>
<span class="sd">            - &quot;path&quot; must be specified; it can be any existed or non-existed path,</span>
<span class="sd">              with or without a suffix; if the suffix is not given in &quot;path&quot;, it will follow &quot;format&quot;</span>
<span class="sd">            - &quot;format&quot; can be one of {&quot;pdf&quot;, &quot;eps&quot;, &quot;png&quot;, &quot;ps&quot;}</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">in_period</span><span class="p">:</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Period [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Period&#39;</span>

            <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yticks_default</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">yticks_default</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_axis</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yticks_default</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_axis</span><span class="p">))</span>
                <span class="n">yticks</span> <span class="o">=</span> <span class="n">yticks_default</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Frequency [1/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Frequency&#39;</span>

        <span class="c1"># plot coherence amplitude</span>
        <span class="n">contourf_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;magma&#39;</span><span class="p">,</span>
            <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span>
            <span class="s1">&#39;levels&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">contourf_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">contourf_style</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">contourf_args</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">])</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="n">under_clr</span><span class="p">)</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="n">over_clr</span><span class="p">)</span>
        <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">bad_clr</span><span class="p">)</span>
        <span class="n">contourf_args</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span>

        <span class="n">cont</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherence</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">contourf_args</span><span class="p">)</span>

        <span class="c1"># plot significance levels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signif_method_label</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ar1&#39;</span><span class="p">:</span> <span class="s1">&#39;AR(1)&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">signif_coh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">signif_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coherence</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">signif_coh</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">T</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">,</span> <span class="n">signif_boundary</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">colors</span><span class="o">=</span><span class="n">signif_clr</span><span class="p">,</span>
                <span class="n">linestyles</span><span class="o">=</span><span class="n">signif_linestyles</span><span class="p">,</span>
                <span class="n">linewidths</span><span class="o">=</span><span class="n">signif_linewidths</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># plot colorbar</span>
        <span class="n">cbar_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;drawedges&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fraction&#39;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
            <span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">cbar_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cbar_style</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span> <span class="o">**</span><span class="n">cbar_args</span><span class="p">)</span>

        <span class="c1"># plot cone of influence</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_axis</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_axis</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">)])]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yticks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">())</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

        <span class="c1"># plot phase</span>
        <span class="n">yaxis_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_axis</span><span class="p">)</span>
        <span class="n">xaxis_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">phase_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pt&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;skip_x&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">xaxis_range</span><span class="o">//</span><span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;skip_y&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">yaxis_range</span><span class="o">//</span><span class="mi">50</span><span class="p">),</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="mf">0.004</span><span class="p">}</span>
        <span class="n">phase_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">phase_style</span><span class="p">)</span>

        <span class="n">pt</span> <span class="o">=</span> <span class="n">phase_args</span><span class="p">[</span><span class="s1">&#39;pt&#39;</span><span class="p">]</span>
        <span class="n">skip_x</span> <span class="o">=</span> <span class="n">phase_args</span><span class="p">[</span><span class="s1">&#39;skip_x&#39;</span><span class="p">]</span>
        <span class="n">skip_y</span> <span class="o">=</span> <span class="n">phase_args</span><span class="p">[</span><span class="s1">&#39;skip_y&#39;</span><span class="p">]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">phase_args</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">phase_args</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signif_qs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phase</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coherence</span> <span class="o">&lt;</span> <span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase</span><span class="p">[</span><span class="n">signif_boundary</span><span class="o">.</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">X</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span> <span class="n">Y</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span>
                  <span class="n">U</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span> <span class="n">V</span><span class="p">[::</span><span class="n">skip_y</span><span class="p">,</span> <span class="p">::</span><span class="n">skip_x</span><span class="p">],</span>
                  <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">signif_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">],</span> <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute_pbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">surr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries1</span><span class="o">.</span><span class="n">surrogates</span><span class="p">(</span>
            <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
        <span class="p">)</span>
        <span class="n">surr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries2</span><span class="o">.</span><span class="n">surrogates</span><span class="p">(</span>
            <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span>
        <span class="p">)</span>

        <span class="n">cohs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Performing wavelet coherence on surrogate pairs&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">mute_pbar</span><span class="p">):</span>
            <span class="n">coh_tmp</span> <span class="o">=</span> <span class="n">surr1</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">wavelet_coherence</span><span class="p">(</span><span class="n">surr2</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">freq_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_method</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_kwargs</span><span class="p">)</span>
            <span class="n">cohs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coh_tmp</span><span class="o">.</span><span class="n">coherence</span><span class="p">)</span>

        <span class="n">cohs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cohs</span><span class="p">)</span>

        <span class="n">ne</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cohs</span><span class="p">)</span>

        <span class="n">coh_qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="n">nf</span><span class="p">,</span> <span class="n">nt</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">coh_qs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">cohs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">qs</span><span class="p">)</span>

        <span class="n">scal_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">amp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coh_qs</span><span class="p">):</span>
            <span class="n">scal_tmp</span> <span class="o">=</span> <span class="n">Scalogram</span><span class="p">(</span>
                    <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coi</span><span class="p">,</span>
                    <span class="n">freq_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_method</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">scal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scal_tmp</span><span class="p">)</span>

        <span class="n">new</span><span class="o">.</span><span class="n">signif_qs</span> <span class="o">=</span> <span class="n">MultipleScalogram</span><span class="p">(</span><span class="n">scalogram_list</span><span class="o">=</span><span class="n">scal_list</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">signif_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="k">return</span> <span class="n">new</span>

<span class="k">class</span> <span class="nc">MultipleSeries</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span> <span class="o">=</span> <span class="n">series_list</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">series_list</span><span class="p">):</span>
            <span class="n">s</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">v_mod</span><span class="o">=</span><span class="n">tsutils</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">v_mod</span>
            <span class="n">new</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">s</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">mssa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">MC</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


        <span class="n">res</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">mssa</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">,</span> <span class="n">MC</span><span class="o">=</span><span class="n">MC</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">pca</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="nb">all</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">==</span><span class="n">a</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All Time Series should be of same length&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">detrend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;emd&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">series_list</span><span class="p">):</span>
            <span class="n">s</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">v_mod</span><span class="o">=</span><span class="n">tsutils</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">v_mod</span>
            <span class="n">new</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">s</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{},</span> <span class="n">mute_pbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">freq_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="s1">&#39;lomb_scargle&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">):</span>
                <span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">res</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">time</span>
            <span class="n">freq_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">freq_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">freq_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">waveutils</span><span class="o">.</span><span class="n">make_freq_vector</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">freq_method</span><span class="o">=</span><span class="n">freq_method</span><span class="p">,</span> <span class="o">**</span><span class="n">freq_kwargs</span><span class="p">)</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span><span class="n">freq</span><span class="p">})</span>
        <span class="n">psd_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Performing spectral analysis on surrogates&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">mute_pbar</span><span class="p">):</span>
            <span class="n">psd_tmp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">spectral</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">psd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd_tmp</span><span class="p">)</span>

        <span class="n">psds</span> <span class="o">=</span> <span class="n">MultiplePSD</span><span class="p">(</span><span class="n">psd_list</span><span class="o">=</span><span class="n">psd_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psds</span>

    <span class="k">def</span> <span class="nf">wavelet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;wwz&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{},</span> <span class="n">mute_pbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">scal_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Performing wavelet analysis on surrogates&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="n">mute_pbar</span><span class="p">):</span>
            <span class="n">scal_tmp</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">wavelet</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="n">scal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scal_tmp</span><span class="p">)</span>

        <span class="n">scals</span> <span class="o">=</span> <span class="n">MultipleScalogram</span><span class="p">(</span><span class="n">scalogram_list</span><span class="o">=</span><span class="n">scal_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scals</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
             <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">linestyle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lgd_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">lgd_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lgd_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">stackplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
              <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                                    <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">plot_kwargs</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="p">,</span>
                                    <span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span>

<span class="k">class</span> <span class="nc">SurrogateSeries</span><span class="p">(</span><span class="n">MultipleSeries</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series_list</span><span class="p">,</span> <span class="n">surrogate_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surrogate_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">series_list</span> <span class="o">=</span> <span class="n">series_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_method</span> <span class="o">=</span> <span class="n">surrogate_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surrogate_args</span> <span class="o">=</span> <span class="n">surrogate_args</span>

<span class="k">class</span> <span class="nc">MultiplePSD</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span> <span class="o">=</span> <span class="n">psd_list</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quantiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timeseries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">period_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">time_unit</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">psd</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Frequency axis not consistent across the PSD list!&#39;</span><span class="p">)</span>

            <span class="n">amps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd</span><span class="o">.</span><span class="n">amplitude</span><span class="p">)</span>

        <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span>
        <span class="n">amp_qs</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">amps</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">psd_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">amp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amp_qs</span><span class="p">):</span>
            <span class="n">psd_tmp</span> <span class="o">=</span> <span class="n">PSD</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="n">lw</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span> <span class="n">period_unit</span><span class="o">=</span><span class="n">period_unit</span><span class="p">)</span>
            <span class="n">psd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psd_tmp</span><span class="p">)</span>

        <span class="n">psds</span> <span class="o">=</span> <span class="n">MultiplePSD</span><span class="p">(</span><span class="n">psd_list</span><span class="o">=</span><span class="n">psd_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">psds</span>

    <span class="k">def</span> <span class="nf">beta_est</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Estimate the scaling factor beta of the each PSD from the psd_list in a log-log space</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        fmin : float</span>
<span class="sd">            the minimum frequency edge for beta estimation; the default is the minimum of the frequency vector of the PSD obj</span>

<span class="sd">        fmax : float</span>
<span class="sd">            the maximum frequency edge for beta estimation; the default is the maximum of the frequency vector of the PSD obj</span>

<span class="sd">        verbose : bool</span>
<span class="sd">            if True, will print out debug information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        res_dict : dictionary</span>
<span class="sd">            - beta: list of the scaling factors</span>
<span class="sd">            - std_err: list of one standard deviation errors of the scaling factor</span>
<span class="sd">            - f_binned: list of the binned frequency series, used as X for linear regression</span>
<span class="sd">            - psd_binned: list of the binned PSD series, used as Y for linear regression</span>
<span class="sd">            - Y_reg: list of the predicted Y from linear regression, used with f_binned for the slope curve plotting</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>

<span class="sd">        core.ui.PSD.beta_est : beta estimation for on PSD object</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">res_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;std_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;f_binned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;psd_binned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_dict</span><span class="p">[</span><span class="s1">&#39;Y_reg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psd_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">psd_obj</span><span class="o">.</span><span class="n">beta_est</span><span class="p">(</span><span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">res_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">res_dict</span>


    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">in_loglog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">plot_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lgd_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">lgd_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lgd_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">psd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">:</span>
            <span class="n">tmp_plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">psd</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tmp_plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">psd</span><span class="o">.</span><span class="n">plot_kwargs</span><span class="p">)</span>
            <span class="n">tmp_plot_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_kwargs</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">psd</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">in_loglog</span><span class="o">=</span><span class="n">in_loglog</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="n">in_period</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="n">yticks</span><span class="p">,</span> <span class="n">plot_legend</span><span class="o">=</span><span class="n">plot_legend</span><span class="p">,</span> <span class="n">plot_kwargs</span><span class="o">=</span><span class="n">tmp_plot_kwargs</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">plot_envelope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">],</span>
             <span class="n">in_loglog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">curve_clr</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s1">&#39;pale red&#39;</span><span class="p">],</span> <span class="n">curve_lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shade_clr</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s1">&#39;pale red&#39;</span><span class="p">],</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">shade_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">members_plot_num</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">members_alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">members_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">savefig_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">savefig_settings</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">savefig_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lgd_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">lgd_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lgd_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">members_plot_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

            <span class="n">npsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">)</span>
            <span class="n">random_draw_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">npsd</span><span class="p">,</span> <span class="n">members_plot_num</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">random_draw_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">in_loglog</span><span class="o">=</span><span class="n">in_loglog</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="n">in_period</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
                    <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="n">yticks</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">members_alpha</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">members_lw</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;example members (n=</span><span class="si">{</span><span class="n">members_plot_num</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">psd_qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">qs</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">in_loglog</span><span class="o">=</span><span class="n">in_loglog</span><span class="p">,</span> <span class="n">in_period</span><span class="o">=</span><span class="n">in_period</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">curve_lw</span><span class="p">,</span>
            <span class="n">xlim</span><span class="o">=</span><span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">ylim</span><span class="p">,</span> <span class="n">xticks</span><span class="o">=</span><span class="n">xticks</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="n">yticks</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">curve_clr</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>


        <span class="k">if</span> <span class="n">in_period</span><span class="p">:</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span>

        <span class="k">if</span> <span class="n">shade_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shade_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">x_axis</span><span class="p">,</span> <span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">psd_qs</span><span class="o">.</span><span class="n">psd_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">shade_clr</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">shade_alpha</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">shade_clr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">shade_label</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_legend</span><span class="p">:</span>
            <span class="n">lgd_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;frameon&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="n">lgd_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">lgd_kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">**</span><span class="n">lgd_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fig&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">savefig_settings</span><span class="p">:</span>
                <span class="n">plotting</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
                    <span class="n">plotting</span><span class="o">.</span><span class="n">showfig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ax</span>


<span class="k">class</span> <span class="nc">MultipleScalogram</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scalogram_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalogram_list</span> <span class="o">=</span> <span class="n">scalogram_list</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">quantiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]):</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">coi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coi</span><span class="p">)</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalogram_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">scal</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Frequency axis not consistent across the scalogram list!&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">scal</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Time axis not consistent across the scalogram list!&#39;</span><span class="p">)</span>

            <span class="n">amps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scal</span><span class="o">.</span><span class="n">amplitude</span><span class="p">)</span>

        <span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span>
        <span class="n">ne</span><span class="p">,</span> <span class="n">nf</span><span class="p">,</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">amps</span><span class="p">)</span>
        <span class="n">amp_qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="n">nf</span><span class="p">,</span> <span class="n">nt</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nf</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">amp_qs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">amps</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">qs</span><span class="p">)</span>

        <span class="n">scal_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">amp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">amp_qs</span><span class="p">):</span>
            <span class="n">scal_tmp</span> <span class="o">=</span> <span class="n">Scalogram</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amp</span><span class="p">,</span> <span class="n">coi</span><span class="o">=</span><span class="n">coi</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">g</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="n">scal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scal_tmp</span><span class="p">)</span>

        <span class="n">scals</span> <span class="o">=</span> <span class="n">MultipleScalogram</span><span class="p">(</span><span class="n">scalogram_list</span><span class="o">=</span><span class="n">scal_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scals</span>


<span class="k">class</span> <span class="nc">Lipd</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">query_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">usr_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lipd_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ice/rock&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;coral&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF8B00&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;documents&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">],</span>
                <span class="s1">&#39;glacier ice&#39;</span><span class="p">:[</span><span class="s1">&#39;#86CDFA&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#00BEFF&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;lake sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#4169E0&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;marine sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#8A4513&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sclerosponge&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;speleothem&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF1492&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;wood&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#32CC32&#39;</span><span class="p">,</span><span class="s1">&#39;^&#39;</span><span class="p">],</span>
                <span class="s1">&#39;mollusk shells&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;peat&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#2F4F4F&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;other&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">]}</span>

        <span class="c1">#check that query has matching terms</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">query_args</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;When query is set to true, you must define query terms&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="n">usr_path</span><span class="o">==</span><span class="kc">None</span> <span class="ow">and</span> <span class="n">lipd_dict</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">usr_path</span><span class="o">==</span><span class="s1">&#39;&#39;</span>

        <span class="c1">#deal with the query dictionary</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">query_args</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">archiveType</span><span class="o">=</span><span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">archiveType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_str</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)</span>
                    <span class="n">archiveType</span><span class="o">=</span><span class="p">[</span><span class="n">archiveType</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">archiveType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_list</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)</span>
                <span class="n">availableType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">whatArchives</span><span class="p">(</span><span class="n">print_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">availableTypeP</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_list</span><span class="p">(</span><span class="n">availableType</span><span class="p">)</span>
                <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archiveType</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">availableTypeP</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">item</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">availableType</span><span class="p">)[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">res</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">archiveType</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">archiveType</span><span class="o">=</span><span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">archiveType</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;proxyObsType&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">proxyObsType</span><span class="o">=</span><span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;proxyObsType&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proxyObsType</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">proxyObsType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_str</span><span class="p">(</span><span class="n">proxyObsType</span><span class="p">)</span>
                    <span class="n">proxyObsType</span><span class="o">=</span><span class="p">[</span><span class="n">proxyObsType</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">proxyObsType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_list</span><span class="p">(</span><span class="n">proxyObsType</span><span class="p">)</span>
                <span class="n">availableProxy</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">whatProxyObservations</span><span class="p">(</span><span class="n">print_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">availableProxyP</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">pre_process_list</span><span class="p">(</span><span class="n">availableProxy</span><span class="p">)</span>
                <span class="n">res</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">proxyObsType</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">availableProxyP</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">item</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">availableProxy</span><span class="p">)[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">res</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">proxyObsType</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">proxyObsType</span><span class="o">=</span><span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proxyObsType</span><span class="o">=</span><span class="p">[</span> <span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;infVarType&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">infVarType</span><span class="o">=</span><span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;infVarType&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">infVarType</span><span class="o">=</span><span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;sensorGenus&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sensorGenus</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;sensorGenus&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sensorGenus</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;sensorSpecies&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sensorSpecies</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;sensorSpecies&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sensorSpecies</span><span class="o">=</span><span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;interpName&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">interpName</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;interpName&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interpName</span><span class="o">=</span><span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;interpDetail&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">interpDetail</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;interpDetail&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interpDetail</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ageUnits&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ageUnits</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;ageUnits&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ageUnits</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ageBound&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ageBound</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;ageBound&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ageBound</span><span class="o">=</span><span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ageBoundType&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ageBoundType</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;ageBoundType&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ageBoundType</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;recordLength&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">recordLength</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;recordLength&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recordLength</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;resolution&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;lat&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;lon&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;alt&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">alt</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;alt&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alt</span><span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;download_folder&#39;</span> <span class="ow">in</span> <span class="n">query_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">download_folder</span> <span class="o">=</span> <span class="n">query_args</span><span class="p">[</span><span class="s1">&#39;download_folder&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">download_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>

            <span class="n">lipdutils</span><span class="o">.</span><span class="n">queryLinkedEarth</span><span class="p">(</span><span class="n">archiveType</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span> <span class="n">proxyObsType</span><span class="o">=</span><span class="n">proxyObsType</span><span class="p">,</span> <span class="n">infVarType</span> <span class="o">=</span> <span class="n">infVarType</span><span class="p">,</span> <span class="n">sensorGenus</span><span class="o">=</span><span class="n">sensorGenus</span><span class="p">,</span>
                    <span class="n">sensorSpecies</span><span class="o">=</span><span class="n">sensorSpecies</span><span class="p">,</span> <span class="n">interpName</span> <span class="o">=</span><span class="n">interpName</span><span class="p">,</span> <span class="n">interpDetail</span> <span class="o">=</span><span class="n">interpDetail</span><span class="p">,</span> <span class="n">ageUnits</span> <span class="o">=</span> <span class="n">ageUnits</span><span class="p">,</span>
                    <span class="n">ageBound</span> <span class="o">=</span> <span class="n">ageBound</span><span class="p">,</span> <span class="n">ageBoundType</span> <span class="o">=</span> <span class="n">ageBoundType</span><span class="p">,</span> <span class="n">recordLength</span> <span class="o">=</span> <span class="n">recordLength</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">,</span> <span class="n">print_response</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">download_lipd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">download_folder</span> <span class="o">=</span> <span class="n">download_folder</span><span class="p">)</span>

            <span class="n">D_query</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">readLipd</span><span class="p">(</span><span class="n">download_folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">D_query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">D_query</span><span class="o">=</span><span class="p">{</span><span class="n">D_query</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]:</span><span class="n">D_query</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D_query</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1">#prepare the dictionaries for all possible scenarios</span>
        <span class="k">if</span> <span class="n">usr_path</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="c1"># since readLipd() takes only absolute path and it will change the current working directory (CWD) without turning back,</span>
            <span class="c1"># we need to record CWD manually and turn back after the data loading is finished</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">usr_path</span><span class="p">)</span>
            <span class="n">D_path</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">readLipd</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
            <span class="c1">#make sure that it&#39;s more than one</span>
            <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">D_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">D_path</span><span class="o">=</span><span class="p">{</span><span class="n">D_path</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]:</span><span class="n">D_path</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D_path</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">lipd_dict</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">D_dict</span><span class="o">=</span><span class="n">lipd_dict</span>
            <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">D_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">D_dict</span><span class="o">=</span><span class="p">{</span><span class="n">D_dict</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]:</span><span class="n">D_dict</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D_dict</span><span class="o">=</span><span class="p">{}</span>

        <span class="c1">#assemble</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">D_query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">D_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">D_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_tso</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ts_list</span><span class="o">=</span><span class="n">lpd</span><span class="o">.</span><span class="n">extractTs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;lipd&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ts_list</span>

    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataSetName</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dict_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;lipd&#39;</span><span class="p">][</span><span class="n">dataSetName</span><span class="p">]</span>
            <span class="n">new</span><span class="o">.</span><span class="n">lipd</span><span class="o">=</span><span class="n">dict_out</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">mapAllArchive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;Robinson&#39;</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="n">background</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rivers</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
           <span class="n">figsize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">markersize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scatter_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1">#get the information from the LiPD dict</span>
        <span class="n">lat</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">lon</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">archiveType</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">archiveType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="c1"># make sure criteria is in the plot_default list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archiveType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">archiveType</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>

        <span class="k">if</span> <span class="n">markersize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scatter_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="n">markersize</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">marker</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">marker</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archiveType</span><span class="p">:</span>
                <span class="n">marker</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">color</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">archiveType</span><span class="p">:</span>
                <span class="n">color</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">map_all</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj_default</span><span class="p">,</span>
                              <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span>
                              <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>
                              <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                              <span class="n">scatter_kwargs</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                              <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
                              <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">mapNearRecord</span><span class="p">():</span>

        <span class="n">res</span><span class="o">=</span><span class="p">{}</span>

        <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">LipdSeries</span><span class="p">(</span><span class="n">Series</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tso</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tso</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">tso</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">=</span><span class="n">tso</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ice/rock&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;coral&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF8B00&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;documents&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">],</span>
                <span class="s1">&#39;glacier ice&#39;</span><span class="p">:[</span><span class="s1">&#39;#86CDFA&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#00BEFF&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;lake sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#4169E0&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;marine sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#8A4513&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sclerosponge&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;speleothem&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF1492&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;wood&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#32CC32&#39;</span><span class="p">,</span><span class="s1">&#39;^&#39;</span><span class="p">],</span>
                <span class="s1">&#39;molluskshells&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;peat&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#2F4F4F&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;other&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">]}</span>

        <span class="n">time</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span> <span class="n">lipdutils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;age&#39;</span><span class="p">:</span>
            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Age&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;ageUnits&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">time_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;ageUnits&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_unit</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s1">&#39;year&#39;</span><span class="p">:</span>
            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;yearUnits&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">time_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;yearUnits&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_unit</span><span class="o">=</span><span class="kc">None</span>

        <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="c1">#Remove NaNs</span>
        <span class="n">ys_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
        <span class="n">value_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;paleoData_units&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">value_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_unit</span><span class="o">=</span><span class="kc">None</span>
        <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LipdSeries</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="n">time_name</span><span class="o">=</span><span class="n">time_name</span><span class="p">,</span>
             <span class="n">time_unit</span><span class="o">=</span><span class="n">time_unit</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">value_name</span><span class="p">,</span><span class="n">value_unit</span><span class="o">=</span><span class="n">value_unit</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chronEnsembleToPaleo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">modelNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tableNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#get the corresponding LiPD</span>
        <span class="n">dataSetName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lipd</span><span class="o">=</span><span class="n">D</span><span class="p">[</span><span class="n">dataSetName</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">lipd</span><span class="o">=</span><span class="n">D</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span><span class="o">=</span><span class="n">D</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">dataSetName</span><span class="p">)</span>
            <span class="n">lipd</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;lipd&#39;</span><span class="p">]</span>
        <span class="c1">#Look for the ensemble and get values</span>
        <span class="n">csv_dict</span><span class="o">=</span><span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd</span><span class="p">)</span>
        <span class="n">chron</span><span class="p">,</span><span class="n">paleo</span> <span class="o">=</span> <span class="n">lipdutils</span><span class="o">.</span><span class="n">isEnsemble</span><span class="p">(</span><span class="n">csv_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chron</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No ChronMeasurementTables available&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chron</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">modelNumber</span><span class="o">==</span><span class="kc">None</span> <span class="ow">or</span> <span class="n">tableNumber</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">csvName</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">whichEnsemble</span><span class="p">(</span><span class="n">chron</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">str1</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelNumber</span><span class="p">)</span>
                <span class="n">str2</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tableNumber</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chron</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">str1</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">str2</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">csvName</span><span class="o">=</span><span class="n">item</span>
            <span class="n">depth</span><span class="p">,</span> <span class="n">ensembleValues</span> <span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">getEnsemble</span><span class="p">(</span><span class="n">csv_dict</span><span class="p">,</span><span class="n">csvName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth</span><span class="p">,</span> <span class="n">ensembleValues</span> <span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">getEnsemble</span><span class="p">(</span><span class="n">csv_dict</span><span class="p">,</span><span class="n">chron</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#make sure it&#39;s sorted</span>
        <span class="n">sort_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="n">depth</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth</span><span class="p">)[</span><span class="n">sort_ind</span><span class="p">])</span>
        <span class="n">ensembleValues</span><span class="o">=</span><span class="n">ensembleValues</span><span class="p">[</span><span class="n">sort_ind</span><span class="p">,:]</span>
        <span class="c1">#Map to paleovalues</span>
        <span class="n">key</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s1">&#39;Units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ds</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">ys</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="c1">#Remove NaNs</span>
        <span class="n">ys_tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
        <span class="n">ensembleValuestoPaleo</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">mapAgeEnsembleToPaleoData</span><span class="p">(</span><span class="n">ensembleValues</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
        <span class="c1">#create multipleseries</span>
        <span class="n">s_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ensembleValuestoPaleo</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
            <span class="n">s_tmp</span><span class="o">=</span><span class="n">Series</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">s_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_tmp</span><span class="p">)</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">MultipleSeries</span><span class="p">(</span><span class="n">series_list</span><span class="o">=</span><span class="n">s_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ms</span>

    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;Orthographic&#39;</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="n">background</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rivers</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
           <span class="n">figsize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">markersize</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scatter_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lgd_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1">#get the information from the timeseries</span>
        <span class="n">lat</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]]</span>
        <span class="n">lon</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]]</span>
        <span class="n">archiveType</span><span class="o">=</span><span class="n">lipdutils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lipd_ts</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span>

        <span class="c1"># make sure criteria is in the plot_default list</span>
        <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>

        <span class="k">if</span> <span class="n">markersize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scatter_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;markersize&#39;</span><span class="p">:</span> <span class="n">markersize</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">marker</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">marker</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">color</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">proj_default</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">proj1</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;central_latitude&#39;</span><span class="p">:</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="s1">&#39;central_longitude&#39;</span><span class="p">:</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="n">proj2</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;central_latitude&#39;</span><span class="p">:</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
            <span class="n">proj3</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;central_longitude&#39;</span><span class="p">:</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="n">archiveType</span><span class="o">=</span><span class="p">[</span><span class="n">archiveType</span><span class="p">]</span> <span class="c1">#list so it will work with map_all</span>
        <span class="n">marker</span><span class="o">=</span><span class="p">[</span><span class="n">marker</span><span class="p">]</span>
        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">color</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">proj_default</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">map_all</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj1</span><span class="p">,</span>
                              <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span>
                              <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>
                              <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                              <span class="n">scatter_kwargs</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                              <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
                              <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">map_all</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj3</span><span class="p">,</span>
                              <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span>
                              <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>
                              <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                              <span class="n">scatter_kwargs</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                              <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
                              <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">map_all</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj2</span><span class="p">,</span>
                              <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span>
                              <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>
                              <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                              <span class="n">scatter_kwargs</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                              <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
                              <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">map_all</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">archiveType</span><span class="p">,</span>
                              <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj_default</span><span class="p">,</span>
                              <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span>
                              <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>
                              <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span>
                              <span class="n">scatter_kwargs</span><span class="o">=</span><span class="n">scatter_kwargs</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                              <span class="n">lgd_kwargs</span><span class="o">=</span><span class="n">lgd_kwargs</span><span class="p">,</span><span class="n">savefig_settings</span><span class="o">=</span><span class="n">savefig_settings</span><span class="p">,</span>
                              <span class="n">mute</span><span class="o">=</span><span class="n">mute</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2020, Deborah Khider, Feng Zhu, Julien Emile-Geay

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>