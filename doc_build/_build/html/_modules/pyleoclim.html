

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyleoclim &mdash; Pyleoclim 0.4.10 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Pyleoclim
          

          
          </a>

          
            
            
              <div class="version">
                0.4.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Pyleoclim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Main.html">Main Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Map.html">Mapping Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Plot.html">Plotting Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Stats.html">Statistics Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Timeseries.html">Timeseries Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LIPDutils.html">LiPD Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SummaryPlots.html">Summary Plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Spectral.html">Spectral Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RBchron.html">RBchron</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pyleoclim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>pyleoclim</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyleoclim</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Wed May 11 10:42:34 2016</span>

<span class="sd">@author: deborahkhider</span>

<span class="sd">License agreement - GNU GENERAL PUBLIC LICENSE v3</span>
<span class="sd">https://github.com/LinkedEarth/Pyleoclim_util/blob/master/license</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#Import all the needed packages</span>
<span class="kn">import</span> <span class="nn">lipd</span> <span class="k">as</span> <span class="nn">lpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">gridspec</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">mquantiles</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>


<span class="c1"># Import internal modules to pyleoclim</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Map</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">LipdUtils</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">SummaryPlots</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Spectral</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Stats</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Timeseries</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">RBchron</span>
<span class="kn">from</span> <span class="nn">pyleoclim</span> <span class="k">import</span> <span class="n">Examples</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Open Lipd files and extract timeseries (set them as global variable)</span>

<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="openLipd"><a class="viewcode-back" href="../Main.html#pyleoclim.openLipd">[docs]</a><span class="k">def</span> <span class="nf">openLipd</span><span class="p">(</span><span class="n">usr_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read Lipd files into a dictionary</span>

<span class="sd">    Sets the dictionary as global variable so that it doesn&#39;t have to be provided</span>
<span class="sd">    as an argument for every function.</span>

<span class="sd">    Args:</span>
<span class="sd">        usr_path (str): The path to a directory or a single file. (Optional argument)</span>

<span class="sd">    Returns:</span>
<span class="sd">        lipd_dict - a dictionary containing the LiPD library</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">lipd_dict</span>
    <span class="n">lipd_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">readLipd</span><span class="p">(</span><span class="n">usr_path</span><span class="o">=</span><span class="n">usr_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lipd_dict</span></div>

<div class="viewcode-block" id="fetchTs"><a class="viewcode-back" href="../Main.html#pyleoclim.fetchTs">[docs]</a><span class="k">def</span> <span class="nf">fetchTs</span><span class="p">(</span><span class="n">lipds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract timeseries dictionary</span>

<span class="sd">    This function is based on the function of the same name in the LiPD utilities.</span>
<span class="sd">    Set the dictionary as a global variable so that it doesn&#39;t have to be</span>
<span class="sd">    provided as an argument for every function.</span>

<span class="sd">    Args:</span>
<span class="sd">        lipds (dict): A dictionary of LiPD files obtained through the</span>
<span class="sd">        readLipd function</span>

<span class="sd">    Returns:</span>
<span class="sd">        ts_list - A list of timeseries object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ts_list</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lipds</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;lipd_dict&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">openLipd</span><span class="p">()</span>

        <span class="n">ts_list</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">extractTs</span><span class="p">(</span><span class="n">lipd_dict</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts_list</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">extractTs</span><span class="p">(</span><span class="n">lipds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts_list</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Set a few global variables</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#Set the default palette for plots</span>

<span class="n">plot_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ice/rock&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;coral&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF8B00&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;documents&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">],</span>
                <span class="s1">&#39;glacier ice&#39;</span><span class="p">:[</span><span class="s1">&#39;#86CDFA&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#00BEFF&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;lake sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#4169E0&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;marine sediment&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#8A4513&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sclerosponge&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">],</span>
                <span class="s1">&#39;speleothem&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FF1492&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>
                <span class="s1">&#39;wood&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#32CC32&#39;</span><span class="p">,</span><span class="s1">&#39;^&#39;</span><span class="p">],</span>
                <span class="s1">&#39;molluskshells&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD600&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">],</span>
                <span class="s1">&#39;peat&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#2F4F4F&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                <span class="s1">&#39;other&#39;</span><span class="p">:[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">]}</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Mapping</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="mapAllArchive"><a class="viewcode-back" href="../Main.html#pyleoclim.mapAllArchive">[docs]</a><span class="k">def</span> <span class="nf">mapAllArchive</span><span class="p">(</span><span class="n">lipds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;Robinson&#39;</span><span class="p">,</span>\
                  <span class="n">proj_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                  <span class="n">rivers</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> \
                  <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;eps&#39;</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Map all the available records loaded into the workspace by archiveType.</span>

<span class="sd">    Map of all the records into the workspace by archiveType.</span>
<span class="sd">        Uses the default color palette. Enter pyleoclim.plot_default for detail.</span>

<span class="sd">    Args:</span>
<span class="sd">        lipds (dict): A list of LiPD files. (Optional)</span>
<span class="sd">        markersize (int): The size of the markers. Default is 50</span>
<span class="sd">        projection (string): the map projection. Available projections:</span>
<span class="sd">            &#39;Robinson&#39;, &#39;PlateCarree&#39;, &#39;AlbertsEqualArea&#39;,</span>
<span class="sd">            &#39;AzimuthalEquidistant&#39;,&#39;EquidistantConic&#39;,&#39;LambertConformal&#39;,</span>
<span class="sd">            &#39;LambertCylindrical&#39;,&#39;Mercator&#39;,&#39;Miller&#39;,&#39;Mollweide&#39;,&#39;Orthographic&#39; (Default),</span>
<span class="sd">            &#39;Sinusoidal&#39;,&#39;Stereographic&#39;,&#39;TransverseMercator&#39;,&#39;UTM&#39;,</span>
<span class="sd">            &#39;InterruptedGoodeHomolosine&#39;,&#39;RotatedPole&#39;,&#39;OSGB&#39;,&#39;EuroPP&#39;,</span>
<span class="sd">            &#39;Geostationary&#39;,&#39;NearsidePerspective&#39;,&#39;EckertI&#39;,&#39;EckertII&#39;,</span>
<span class="sd">            &#39;EckertIII&#39;,&#39;EckertIV&#39;,&#39;EckertV&#39;,&#39;EckertVI&#39;,&#39;EqualEarth&#39;,&#39;Gnomonic&#39;,</span>
<span class="sd">            &#39;LambertAzimuthalEqualArea&#39;,&#39;NorthPolarStereo&#39;,&#39;OSNI&#39;,&#39;SouthPolarStereo&#39;</span>
<span class="sd">        proj_default (bool): If True, uses the standard projection attributes, including centering.</span>
<span class="sd">            Enter new attributes in a dictionary to change them. Lists of attributes</span>
<span class="sd">            can be found in the Cartopy documentation: </span>
<span class="sd">                https://scitools.org.uk/cartopy/docs/latest/crs/projections.html#eckertiv</span>
<span class="sd">        background (bool): If True, uses a shaded relief background (only one </span>
<span class="sd">            available in Cartopy)</span>
<span class="sd">        borders (bool): Draws the countries border. Defaults is off (False). </span>
<span class="sd">        rivers (bool): Draws major rivers. Default is off (False).</span>
<span class="sd">        lakes (bool): Draws major lakes. </span>
<span class="sd">            Default is off (False).</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        saveFig (bool): Default is to not save the figure</span>
<span class="sd">        dir (str): The absolute path of the directory in which to save the</span>
<span class="sd">            figure. If not provided, creates a default folder called &#39;figures&#39;</span>
<span class="sd">            in the LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The figure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the dictionary of LiPD files</span>
    <span class="k">if</span> <span class="n">lipds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;lipd_dict&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">openLipd</span><span class="p">()</span>
        <span class="n">lipds</span> <span class="o">=</span> <span class="n">lipd_dict</span>

    <span class="c1"># Initialize the various lists</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">archiveType</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop ang grab the metadata</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lipds</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">lipds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">archiveType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>


    <span class="c1"># make sure criteria is in the plot_default list</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archiveType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>


    <span class="c1"># Make the map</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">mapAll</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">archiveType</span><span class="p">,</span><span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> \
                     <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj_default</span><span class="p">,</span><span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span>\
                     <span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span> <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>\
                     <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">plot_default</span><span class="p">,</span>\
                     <span class="n">markersize</span> <span class="o">=</span> <span class="n">markersize</span><span class="p">)</span>

    <span class="c1"># Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="s1">&#39;mapLipds_archive&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="mapLipd"><a class="viewcode-back" href="../Main.html#pyleoclim.mapLipd">[docs]</a><span class="k">def</span> <span class="nf">mapLipd</span><span class="p">(</span><span class="n">timeseries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;Orthographic&#39;</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>\
           <span class="n">background</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> \
           <span class="n">rivers</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
           <span class="n">markersize</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> \
           <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Create a Map for a single record</span>

<span class="sd">    Orthographic projection map of a single record.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries: a LiPD timeseries object. Will prompt for one if not given</span>
<span class="sd">        projection (string): the map projection. Available projections:</span>
<span class="sd">            &#39;Robinson&#39;, &#39;PlateCarree&#39;, &#39;AlbertsEqualArea&#39;,</span>
<span class="sd">            &#39;AzimuthalEquidistant&#39;,&#39;EquidistantConic&#39;,&#39;LambertConformal&#39;,</span>
<span class="sd">            &#39;LambertCylindrical&#39;,&#39;Mercator&#39;,&#39;Miller&#39;,&#39;Mollweide&#39;,&#39;Orthographic&#39; (Default),</span>
<span class="sd">            &#39;Sinusoidal&#39;,&#39;Stereographic&#39;,&#39;TransverseMercator&#39;,&#39;UTM&#39;,</span>
<span class="sd">            &#39;InterruptedGoodeHomolosine&#39;,&#39;RotatedPole&#39;,&#39;OSGB&#39;,&#39;EuroPP&#39;,</span>
<span class="sd">            &#39;Geostationary&#39;,&#39;NearsidePerspective&#39;,&#39;EckertI&#39;,&#39;EckertII&#39;,</span>
<span class="sd">            &#39;EckertIII&#39;,&#39;EckertIV&#39;,&#39;EckertV&#39;,&#39;EckertVI&#39;,&#39;EqualEarth&#39;,&#39;Gnomonic&#39;,</span>
<span class="sd">            &#39;LambertAzimuthalEqualArea&#39;,&#39;NorthPolarStereo&#39;,&#39;OSNI&#39;,&#39;SouthPolarStereo&#39;</span>
<span class="sd">        proj_default (bool): If True, uses the standard projection attributes, including centering.</span>
<span class="sd">            Enter new attributes in a dictionary to change them. Lists of attributes</span>
<span class="sd">            can be found in the Cartopy documentation: </span>
<span class="sd">                https://scitools.org.uk/cartopy/docs/latest/crs/projections.html#eckertiv</span>
<span class="sd">        background (bool): If True, uses a shaded relief background (only one </span>
<span class="sd">            available in Cartopy)</span>
<span class="sd">        label (str): label for archive marker. Default is to use the name of the </span>
<span class="sd">            physical sample. If no archive name is available, default to</span>
<span class="sd">            None. None returns no label. </span>
<span class="sd">        borders (bool): Draws the countries border. Defaults is off (False). </span>
<span class="sd">        rivers (bool): Draws major rivers. Default is off (False).</span>
<span class="sd">        lakes (bool): Draws major lakes. </span>
<span class="sd">            Default is off (False).</span>
<span class="sd">        markersize (int): The size of the marker.</span>
<span class="sd">        marker (str or list): color and type of marker. Default will use the</span>
<span class="sd">        default color palette for archives</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The figure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure there are LiPD files to plot</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get latitude/longitude</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span>

    <span class="c1"># Make sure it&#39;s in the palette</span>
    <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">]</span>

    <span class="c1"># Get the label</span>
    <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;physicalSample_name&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;measuredOn_name&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;the argument label should be of type str&#39;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">mapOne</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span> <span class="o">=</span> <span class="n">proj_default</span><span class="p">,</span>\
           <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="n">borders</span> <span class="o">=</span> <span class="n">borders</span><span class="p">,</span> \
           <span class="n">rivers</span> <span class="o">=</span> <span class="n">rivers</span><span class="p">,</span> <span class="n">lakes</span> <span class="o">=</span> <span class="n">lakes</span><span class="p">,</span>\
           <span class="n">markersize</span> <span class="o">=</span> <span class="n">markersize</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">marker</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> \
           <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_map&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

<span class="k">class</span> <span class="nc">MapFilters</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Create the various filters for mapping purposes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lipd_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the object and store the information into lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dataSetName</span> <span class="o">=</span><span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lipd_dict</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">lipd_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">lat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">lon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">archiveType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">]))</span>
            <span class="n">dataSetName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">])</span>

        <span class="c1"># make sure criteria is in the plot_default list</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archiveType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">archiveType</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>

        <span class="k">return</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span>

    <span class="k">def</span> <span class="nf">distSphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span><span class="n">lon1</span><span class="p">,</span><span class="n">lat2</span><span class="p">,</span><span class="n">lon2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses the harversine formula to calculate distance on a sphere</span>

<span class="sd">        Args:</span>
<span class="sd">            lat1: Latitude of the first point, in radians</span>
<span class="sd">            lon1: Longitude of the first point, in radians</span>
<span class="sd">            lat2: Latitude of the second point, in radians</span>
<span class="sd">            lon2: Longitude of the second point, in radians</span>

<span class="sd">        Returns:</span>
<span class="sd">            The distance between the two point in km</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mi">6371</span>  <span class="c1">#km. Earth&#39;s radius</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span><span class="o">-</span><span class="n">lat1</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span><span class="o">-</span><span class="n">lon1</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
        <span class="n">dist</span> <span class="o">=</span><span class="n">R</span><span class="o">*</span><span class="n">c</span>

        <span class="k">return</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">computeDist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_r</span><span class="p">,</span> <span class="n">lon_r</span><span class="p">,</span> <span class="n">lat_c</span><span class="p">,</span> <span class="n">lon_c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes the distance in (km) between a reference point and an array</span>
<span class="sd">        of other coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            lat_r (float): The reference latitude, in deg</span>
<span class="sd">            lon_r (float): The reference longitude, in deg</span>
<span class="sd">            lat_c (list): An list of latitudes for the comparison points, in deg</span>
<span class="sd">            lon_c (list): An list of longitudes for the comparison points, in deg</span>

<span class="sd">        Returns:</span>
<span class="sd">            dist - a list of distances in km.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span> <span class="p">(</span><span class="n">lat_c</span><span class="p">):</span>
            <span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat_r</span><span class="p">)</span>
            <span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon_r</span><span class="p">)</span>
            <span class="n">lat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">lon2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon_c</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distSphere</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">lon1</span><span class="p">,</span><span class="n">lat2</span><span class="p">,</span><span class="n">lon2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">filterByArchive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">archiveType</span><span class="p">,</span><span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the indexes of the records with the matching archiveType</span>

<span class="sd">        Args:</span>
<span class="sd">            archiveType (list): A list of ArchiveType</span>
<span class="sd">            option: the matching string</span>

<span class="sd">        Returns:</span>
<span class="sd">            idx (list): The indices matching the query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span><span class="o">==</span><span class="n">option</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">idx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Your search criteria doesn&#39;t match any record in the database&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">withinDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the index of the records that are within a certain distance</span>

<span class="sd">        Args:</span>
<span class="sd">            distance (list): A list containing the distance</span>
<span class="sd">            radius (float): the radius to be considered</span>

<span class="sd">        Returns:</span>
<span class="sd">            idx (list): a list of index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">idx</span>

    <span class="k">def</span> <span class="nf">filterList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filters the list by the given indexes</span>

<span class="sd">        Args:</span>
<span class="sd">            lat (array): Array of latitudes</span>
<span class="sd">            lon (array): Array of longitudes</span>
<span class="sd">            archiveType (array): Array of ArchiveTypes</span>
<span class="sd">            dist (array): Array of distances</span>
<span class="sd">            dataSetName (array): Array of dataset names</span>
<span class="sd">            idx (array): An array of indices used for the filtering</span>

<span class="sd">        Returns:</span>
<span class="sd">            The previous arrays filtered by indexes</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lat</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">dataSetName</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataSetName</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">dist</span>


<div class="viewcode-block" id="mapNearRecords"><a class="viewcode-back" href="../Main.html#pyleoclim.mapNearRecords">[docs]</a><span class="k">def</span> <span class="nf">mapNearRecords</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lipds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
                   <span class="n">sameArchive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;Orthographic&#39;</span><span class="p">,</span>\
                   <span class="n">proj_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rivers</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> \
                   <span class="n">lakes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>\
                   <span class="n">markersize_adjust</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">marker_r</span> <span class="o">=</span> <span class="s2">&quot;ko&quot;</span><span class="p">,</span> \
                   <span class="n">marker_c</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>\
                   <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Distance in km&quot;</span><span class="p">,</span>
                   <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
                   <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;eps&quot;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Map the nearest records from the record of interest</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries (dict): A timeseries object. If none given, will prompt for one</span>
<span class="sd">        lipds (list): A list of LiPD files. (Optional)</span>
<span class="sd">        n (int): the number of records to match</span>
<span class="sd">        radius (float): The distance (in km) to search for nearby records.</span>
<span class="sd">            Default is to search the entire globe</span>
<span class="sd">        sameArchive (bool): Returns only records with the same archiveType.</span>
<span class="sd">            Default is not to do so.</span>
<span class="sd">        projection (string): the map projection. Available projections:</span>
<span class="sd">            &#39;Robinson&#39;, &#39;PlateCarree&#39;, &#39;AlbertsEqualArea&#39;,</span>
<span class="sd">            &#39;AzimuthalEquidistant&#39;,&#39;EquidistantConic&#39;,&#39;LambertConformal&#39;,</span>
<span class="sd">            &#39;LambertCylindrical&#39;,&#39;Mercator&#39;,&#39;Miller&#39;,&#39;Mollweide&#39;,&#39;Orthographic&#39; (Default),</span>
<span class="sd">            &#39;Sinusoidal&#39;,&#39;Stereographic&#39;,&#39;TransverseMercator&#39;,&#39;UTM&#39;,</span>
<span class="sd">            &#39;InterruptedGoodeHomolosine&#39;,&#39;RotatedPole&#39;,&#39;OSGB&#39;,&#39;EuroPP&#39;,</span>
<span class="sd">            &#39;Geostationary&#39;,&#39;NearsidePerspective&#39;,&#39;EckertI&#39;,&#39;EckertII&#39;,</span>
<span class="sd">            &#39;EckertIII&#39;,&#39;EckertIV&#39;,&#39;EckertV&#39;,&#39;EckertVI&#39;,&#39;EqualEarth&#39;,&#39;Gnomonic&#39;,</span>
<span class="sd">            &#39;LambertAzimuthalEqualArea&#39;,&#39;NorthPolarStereo&#39;,&#39;OSNI&#39;,&#39;SouthPolarStereo&#39;</span>
<span class="sd">        proj_default (bool): If True, uses the standard projection attributes, including centering.</span>
<span class="sd">            Enter new attributes in a dictionary to change them. Lists of attributes</span>
<span class="sd">            can be found in the Cartopy documentation: </span>
<span class="sd">                https://scitools.org.uk/cartopy/docs/latest/crs/projections.html#eckertiv</span>
<span class="sd">        background (bool): If True, uses a shaded relief background (only one </span>
<span class="sd">            available in Cartopy)</span>
<span class="sd">        borders (bool): Draws the countries border. Defaults is off (False). </span>
<span class="sd">        rivers (bool): Draws major rivers. Default is off (False).</span>
<span class="sd">        lakes (bool): Draws major lakes. </span>
<span class="sd">            Default is off (False).</span>
<span class="sd">        markersize (int): the size of the marker</span>
<span class="sd">        markersize_adjust (bool): If True, will proportionaly adjust the size of</span>
<span class="sd">            the marker according to distance.</span>
<span class="sd">        marker_r (list or str): The color and shape of the marker for the</span>
<span class="sd">            reference record.</span>
<span class="sd">        marker_c (list or str): The color and shape of the marker for the other</span>
<span class="sd">            records. Default is to use the color palette by archiveType. If set</span>
<span class="sd">            to None then the color of the marker will represent the distance from</span>
<span class="sd">            the reference records.</span>
<span class="sd">        cmap (str): The colormap to use to represent the distance from the</span>
<span class="sd">            reference record if no marker is selected.</span>
<span class="sd">        colorbar (bool): Create a colorbar. Default is True</span>
<span class="sd">        location (str): Location of the colorbar</span>
<span class="sd">        label (str): Label for the colorbar.</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        ax: Return as axis instead of figure (useful to integrate plot into a subplot)</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>


<span class="sd">    Returns:</span>
<span class="sd">        ax - The figure</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the dictionary of LiPD files</span>
    <span class="k">if</span> <span class="n">lipds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;lipd_dict&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">openLipd</span><span class="p">()</span>
        <span class="n">lipds</span> <span class="o">=</span> <span class="n">lipd_dict</span>

    <span class="c1"># Get a timeseries if not given</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get the data</span>
    <span class="n">newfilter</span> <span class="o">=</span> <span class="n">MapFilters</span><span class="p">()</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">lipds</span><span class="p">)</span>
    <span class="c1"># Calculate the distance</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">computeDist</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLat&quot;</span><span class="p">],</span>
                                 <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLon&quot;</span><span class="p">],</span>
                                 <span class="n">lat</span><span class="p">,</span>
                                 <span class="n">lon</span><span class="p">)</span>

    <span class="c1"># Filter to remove the reference record from the list</span>
    <span class="n">idx_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_zero</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No matching records found. Change your search criteria!&quot;</span><span class="p">)</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">filterList</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span>
                                                                    <span class="n">archiveType</span><span class="p">,</span>
                                                                    <span class="n">dist</span><span class="p">,</span>
                                                                    <span class="n">dataSetName</span><span class="p">,</span>
                                                                    <span class="n">idx_zero</span><span class="p">)</span>

    <span class="c1">#Filter to be within the radius</span>
    <span class="k">if</span> <span class="n">radius</span><span class="p">:</span>
       <span class="n">idx_radius</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">withinDistance</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_radius</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
           <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No matching records found. Change your search criteria!&quot;</span><span class="p">)</span>
       <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">filterList</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span>
                                                                    <span class="n">archiveType</span><span class="p">,</span>
                                                                    <span class="n">dist</span><span class="p">,</span>
                                                                    <span class="n">dataSetName</span><span class="p">,</span>
                                                                    <span class="n">idx_radius</span><span class="p">)</span>

    <span class="c1"># Same archive if asked</span>
    <span class="k">if</span> <span class="n">sameArchive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">idx_archive</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">filterByArchive</span><span class="p">(</span><span class="n">archiveType</span><span class="p">,</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;archiveType&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_archive</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No matching records found. Change your search criteria!&quot;</span><span class="p">)</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">filterList</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span>
                                                                    <span class="n">archiveType</span><span class="p">,</span>
                                                                    <span class="n">dist</span><span class="p">,</span>
                                                                    <span class="n">dataSetName</span><span class="p">,</span>
                                                                    <span class="n">idx_archive</span><span class="p">)</span>

    <span class="c1">#Print a warning if plotting less than asked because of the filters</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Number of matching records is less&quot;</span><span class="o">+</span>\
              <span class="s2">&quot; than the number of neighbors chosen. Including all records &quot;</span><span class="o">+</span>\
              <span class="s2">&quot; in the analysis.&quot;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

    <span class="c1"># Sort the distance array</span>
    <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">archiveType</span><span class="p">,</span> <span class="n">dataSetName</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">newfilter</span><span class="o">.</span><span class="n">filterList</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span>
                                                                    <span class="n">archiveType</span><span class="p">,</span>
                                                                    <span class="n">dist</span><span class="p">,</span>
                                                                    <span class="n">dataSetName</span><span class="p">,</span>
                                                                    <span class="n">sort_idx</span><span class="p">)</span>

    <span class="c1"># Grab the right number of records</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">archiveType</span> <span class="o">=</span> <span class="n">archiveType</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">dataSetName</span> <span class="o">=</span> <span class="n">dataSetName</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>

    <span class="c1"># Make the map</span>
    <span class="c1"># get the projection:</span>
    <span class="k">if</span> <span class="n">proj_default</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">proj_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;central_longitude&#39;</span><span class="p">:</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLon&quot;</span><span class="p">]}</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">setProj</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">,</span> <span class="n">proj_default</span><span class="o">=</span><span class="n">proj_default</span><span class="p">)</span>  

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">))</span>     
    <span class="c1"># draw the coastlines    </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    
    <span class="c1"># Background</span>
    <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">stock_img</span><span class="p">()</span>
    
    <span class="c1">#Other extra information</span>
    <span class="k">if</span> <span class="n">borders</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lakes</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rivers</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">RIVERS</span><span class="p">)</span>

    <span class="c1"># Make the scatter plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLon&quot;</span><span class="p">],</span>
               <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLat&quot;</span><span class="p">],</span>
               <span class="n">s</span><span class="o">=</span> <span class="n">markersize</span><span class="p">,</span>
               <span class="n">facecolor</span> <span class="o">=</span> <span class="n">marker_r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">marker</span> <span class="o">=</span> <span class="n">marker_r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
               <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>


    <span class="c1">#Either plot single color or gradient</span>

    <span class="k">if</span> <span class="n">marker_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span>
               <span class="n">s</span><span class="o">=</span> <span class="n">markersize</span><span class="p">,</span>
               <span class="n">c</span> <span class="o">=</span> <span class="n">dist</span><span class="p">,</span>
               <span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
               <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
               <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span>
               <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">colorbar</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
           <span class="n">cb</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span><span class="n">location</span><span class="p">)</span>
           <span class="k">if</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
               <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">marker_c</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
        <span class="n">dist_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">dist_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dist</span><span class="o">*</span><span class="n">markersize</span><span class="o">/</span><span class="n">dist_max</span><span class="p">)</span>
        <span class="c1">#Use the archive specific markers</span>
        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archiveType</span><span class="p">:</span>
           <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">archiveType</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">archive</span><span class="p">]</span>
           <span class="k">if</span> <span class="n">markersize_adjust</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
               <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span>
                       <span class="n">s</span> <span class="o">=</span> <span class="n">dist_adj</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
                       <span class="n">facecolor</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archive</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">marker</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archive</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arry</span><span class="p">(</span><span class="n">lat</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span>
                       <span class="n">s</span> <span class="o">=</span> <span class="n">markersize</span><span class="p">,</span>
                       <span class="n">facecolor</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archive</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">marker</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archive</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
        <span class="n">dist_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dist</span><span class="o">*</span><span class="n">markersize</span><span class="o">/</span><span class="n">dist_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">markersize_adjust</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> 
                    <span class="n">s</span><span class="o">=</span><span class="n">dist_adj</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                    <span class="n">marker</span> <span class="o">=</span> <span class="n">marker_c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">facecolor</span> <span class="o">=</span> <span class="n">marker_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">zorder</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">marker_c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">facecolor</span> <span class="o">=</span> <span class="n">marker_c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1"># Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_map&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plotting</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="plotTs"><a class="viewcode-back" href="../Main.html#pyleoclim.plotTs">[docs]</a><span class="k">def</span> <span class="nf">plotTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>\
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>\
            <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a single time series.</span>

<span class="sd">    Args:</span>
<span class="sd">        A timeseries: By default, will prompt the user for one.</span>
<span class="sd">        x_axis (str): The representation against which to plot the paleo-data.</span>
<span class="sd">            Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;. Default is to let the</span>
<span class="sd">            system choose if only one available or prompt the user.</span>
<span class="sd">        markersize (int): default is 50.</span>
<span class="sd">        marker (str): a string (or list) containing the color and shape of the</span>
<span class="sd">            marker. Default is by archiveType. Type pyleo.plot_default to see</span>
<span class="sd">            the default palette.</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The figure.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkXaxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1"># remove nans and sort time axis</span>
    <span class="n">y</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># get the markers</span>
    <span class="k">if</span> <span class="n">marker</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">]</span>

    <span class="c1"># Get the labels</span>
    <span class="c1"># title</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span>
    <span class="c1"># x_label</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">+</span><span class="s2">&quot;Units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span> <span class="s2">&quot; (&quot;</span><span class="o">+</span><span class="n">timeseries</span><span class="p">[</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;Units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># ylabel</span>
    <span class="k">if</span> <span class="s2">&quot;paleoData_inferredVariableType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#This if loop is needed because some files appear to have two</span>
        <span class="c1">#different inferredVariableType/proxyObservationType, which</span>
        <span class="c1">#should not be possible in the ontology. Just build some checks</span>
        <span class="c1"># in the system</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">elif</span> <span class="s2">&quot;paleoData_proxyObservationType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span>

    <span class="c1"># make the plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span><span class="n">x_label</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span>\
              <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1">#Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;plot_timeseries_&#39;</span><span class="o">+</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span><span class="o">+</span>\
            <span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">y_label</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

<span class="k">def</span> <span class="nf">plotEnsTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lipd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ensTableName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ens</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
              <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> \
              <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> \
              <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
              <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot timeseries on various ensemble ages</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries (dict): LiPD timeseries object. By default, will prompt for one</span>
<span class="sd">        lipd (dict): The LiPD dictionary. MUST be provided if timeseries is set.</span>
<span class="sd">        ensTableName (str): The name of the ensemble table, if known.</span>
<span class="sd">        ens (int): Number of ensembles to plot. By default, will plot either the</span>
<span class="sd">            number of ensembles stored in the chronensembleTable or 500 of them,</span>
<span class="sd">            whichever is lower</span>
<span class="sd">        color (str): The line color. If None, uses the default color palette</span>
<span class="sd">        alpha (float): Transparency setting for each line. Default is 0.005.</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The figure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lipd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;LiPD file should be provided when timeseries is set.&quot;</span><span class="p">)</span>

    <span class="c1"># Get the csv files</span>
    <span class="k">if</span> <span class="n">lipd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">lipd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">[</span><span class="n">lipd_dict</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lipd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Print out warnings</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset name and LiPD file name don&#39;t match!&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select your LiPD file from the list&quot;</span><span class="p">)</span>
                <span class="c1"># Get the name of the LiPD files stored in memory</span>
                <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">lipd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="c1">#Print them out for the users</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                <span class="c1"># Ask the user to pick one</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the number of the LiPD file: &quot;</span><span class="p">))</span>
                <span class="n">lipd_name</span> <span class="o">=</span> <span class="n">keylist</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="c1"># Grab the csv list</span>
                <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd_dict</span><span class="p">[</span><span class="n">lipd_name</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1">#Just grab the csv directly</span>
                <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd_dict</span><span class="p">[</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;archiveType&#39;</span> <span class="ow">in</span> <span class="n">lipd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lipd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Print out warnings</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset name and LiPD file name don&#39;t match!&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select your LiPD file from the list&quot;</span><span class="p">)</span>
                <span class="c1"># Get the name of the LiPD files stored in memory</span>
                <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">lipd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="c1">#Print them out for the users</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keylist</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                <span class="c1"># Ask the user to pick one</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the number of the LiPD file: &quot;</span><span class="p">))</span>
                <span class="n">lipd_name</span> <span class="o">=</span> <span class="n">keylist</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="c1"># Grab the csv list</span>
                <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd</span><span class="p">[</span><span class="n">lipd_name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#Just grab the csv directly</span>
                <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd</span><span class="p">[</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]])</span>

    <span class="c1"># Get the ensemble tables</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ensTableName</span><span class="p">:</span>
        <span class="n">chronEnsembleTables</span><span class="p">,</span> <span class="n">paleoEnsembleTables</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">isEnsemble</span><span class="p">(</span><span class="n">csv_dict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ensTableName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">csv_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The name of the table you entered doesn&#39;t exist, selecting...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chronEnsembleTables</span> <span class="o">=</span> <span class="n">ensTableName</span>

    <span class="c1"># Check the number of Chron Tables</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chronEnsembleTables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No chronEnsembleTable available&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chronEnsembleTables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;More than one ensemble table available.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chronEnsembleTables</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the number of the table you&#39;d like to use: &quot;</span><span class="p">))</span>
        <span class="n">ensemble_dict</span> <span class="o">=</span> <span class="n">csv_dict</span><span class="p">[</span><span class="n">chronEnsembleTables</span><span class="p">[</span><span class="n">sel</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ensemble_dict</span> <span class="o">=</span> <span class="n">csv_dict</span><span class="p">[</span><span class="n">chronEnsembleTables</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Get depth and values</span>
    <span class="n">depth</span><span class="p">,</span> <span class="n">ensembleValues</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getEnsembleValues</span><span class="p">(</span><span class="n">ensemble_dict</span><span class="p">)</span>

    <span class="c1"># Get the paleoData values</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_values&quot;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="c1"># Remove NaNs</span>
    <span class="n">ys_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ys_tmp</span><span class="p">)]</span>

    <span class="c1"># Bring the ensemble values to common depth</span>
    <span class="n">ensembleValuestoPaleo</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">mapAgeEnsembleToPaleoData</span><span class="p">(</span><span class="n">ensembleValues</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>

    <span class="c1"># Get plot information</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span>
    <span class="n">x_label</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
    <span class="c1"># y_label</span>
    <span class="k">if</span> <span class="s2">&quot;paleoData_inferredVariableType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#This if loop is needed because some files appear to have two</span>
        <span class="c1">#different inferredVariableType/proxyObservationType, which</span>
        <span class="c1">#should not be possible in the ontology. Just build some checks</span>
        <span class="c1"># in the system</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">elif</span> <span class="s2">&quot;paleoData_proxyObservationType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span>

    <span class="c1"># Get the color</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Make the plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">plotEns</span><span class="p">(</span><span class="n">ensembleValuestoPaleo</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">ens</span> <span class="o">=</span> <span class="n">ens</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span>\
                       <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_label</span><span class="p">,</span> <span class="n">y_label</span> <span class="o">=</span> <span class="n">y_label</span><span class="p">,</span>\
                       <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;plot_ens_timeseries_&#39;</span><span class="o">+</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span><span class="o">+</span>\
            <span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">y_label</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span>

<div class="viewcode-block" id="histTs"><a class="viewcode-back" href="../Main.html#pyleoclim.histTs">[docs]</a><span class="k">def</span> <span class="nf">histTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> \
             <span class="n">kde</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">rug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hist_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;Histogram&quot;</span><span class="p">},</span>\
             <span class="n">kde_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;KDE fit&quot;</span><span class="p">},</span> <span class="n">rug_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;Rug&quot;</span><span class="p">},</span> \
             <span class="n">fit_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;Fit&quot;</span><span class="p">},</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> \
             <span class="n">norm_hist</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>\
             <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">,</span>\
             <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot a univariate distribution of the PaleoData values</span>

<span class="sd">    This function is based on the seaborn displot function, which is</span>
<span class="sd">    itself a combination of the matplotlib hist function with the</span>
<span class="sd">    seaborn kdeplot() and rugplot() functions. It can also fit</span>
<span class="sd">    scipy.stats distributions and plot the estimated PDF over the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries: A timeseries. By default, will prompt the user for one.</span>
<span class="sd">        bins (int): Specification of hist bins following matplotlib(hist),</span>
<span class="sd">            or None to use Freedman-Diaconis rule</span>
<span class="sd">        hist (bool): Whether to plot a (normed) histogram</span>
<span class="sd">        kde (bool): Whether to plot a gaussian kernel density estimate</span>
<span class="sd">        rug (bool): Whether to draw a rugplot on the support axis</span>
<span class="sd">        fit: Random variable object. An object with fit method, returning</span>
<span class="sd">            a tuple that can be passed to a pdf method of positional</span>
<span class="sd">            arguments following a grid of values to evaluate the pdf on.</span>
<span class="sd">        {hist, kde, rug, fit}_kws: Dictionaries. Keyword arguments for</span>
<span class="sd">            underlying plotting functions. If modifying the dictionary, make</span>
<span class="sd">            sure the labels &quot;hist&quot;, &quot;kde&quot;, &quot;rug&quot; and &quot;fit&quot; are still passed.</span>
<span class="sd">        color (str): matplotlib color. Color to plot everything but the</span>
<span class="sd">            fitted curve in. Default is to use the default paletter for each</span>
<span class="sd">            archive type.</span>
<span class="sd">        vertical (bool): if True, oberved values are on y-axis.</span>
<span class="sd">        norm_hist (bool): If True (default), the histrogram height shows</span>
<span class="sd">            a density rather than a count. This is implied if a KDE or</span>
<span class="sd">            fitted density is plotted</span>
<span class="sd">        figsize (list): the size for the figure</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns</span>
<span class="sd">        fig - The figure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get the values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># Remove NaNs</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># Get the y_label</span>
    <span class="k">if</span> <span class="s2">&quot;paleoData_inferredVariableType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#This if loop is needed because some files appear to have two</span>
        <span class="c1">#different inferredVariableType/proxyObservationType, which</span>
        <span class="c1">#should not be possible in the ontology. Just build some checks</span>
        <span class="c1"># in the system</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_inferredVariableType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">elif</span> <span class="s2">&quot;paleoData_proxyObservationType&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_proxyObservationType&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">var</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;paleoData_units&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;paleoData_variableName&quot;</span><span class="p">]</span>

    <span class="c1"># Grab the color</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Make this histogram</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">plot_hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="p">,</span> \
        <span class="n">kde</span> <span class="o">=</span> <span class="n">kde</span><span class="p">,</span> <span class="n">rug</span> <span class="o">=</span> <span class="n">rug</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">,</span> <span class="n">hist_kws</span> <span class="o">=</span> <span class="n">hist_kws</span><span class="p">,</span>\
        <span class="n">kde_kws</span> <span class="o">=</span> <span class="n">kde_kws</span><span class="p">,</span> <span class="n">rug_kws</span> <span class="o">=</span> <span class="n">rug_kws</span><span class="p">,</span> \
        <span class="n">fit_kws</span> <span class="o">=</span> <span class="n">fit_kws</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="n">vertical</span><span class="p">,</span> \
        <span class="n">norm_hist</span> <span class="o">=</span> <span class="n">norm_hist</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1">#Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;plot_timeseries_&#39;</span><span class="o">+</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span><span class="o">+</span>\
            <span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">y_label</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SummaryPlots</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="summaryTs"><a class="viewcode-back" href="../Main.html#pyleoclim.summaryTs">[docs]</a><span class="k">def</span> <span class="nf">summaryTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="nb">format</span> <span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic summary plot</span>

<span class="sd">    Plots the following information: the time series, a histogram of</span>
<span class="sd">    the PaleoData_values, location map, spectral density using the wwz</span>
<span class="sd">    method, and metadata about the record.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries: a timeseries object. By default, will prompt for one</span>
<span class="sd">        x_axis (str): The representation against which to plot the paleo-data.</span>
<span class="sd">            Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;. Default is to let the</span>
<span class="sd">            system choose if only one available or prompt the user.</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The figure</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># get the necessary metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">SummaryPlots</span><span class="o">.</span><span class="n">getMetadata</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>

    <span class="c1"># get the information about the timeseries</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">archiveType</span><span class="p">,</span><span class="n">x_label</span><span class="p">,</span><span class="n">y_label</span> <span class="o">=</span> <span class="n">SummaryPlots</span><span class="o">.</span><span class="n">TsData</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span>
                                                          <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1"># Clean up</span>
    <span class="n">y</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Make the figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>

    <span class="c1"># Plot the timeseries</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">archiveType</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">LipdToOntology</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">archiveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">archiveType</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">plot_default</span><span class="p">[</span><span class="n">archiveType</span><span class="p">]</span>
    <span class="n">markersize</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">marker</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span>\
              <span class="n">y_label</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="c1"># Plot the histogram and kernel density estimates</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">distplot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">vertical</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">hist_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;Histogram&quot;</span><span class="p">},</span>
                <span class="n">kde_kws</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;KDE fit&quot;</span><span class="p">})</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PDF&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">])</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

    <span class="c1"># Plot the Map</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLat&quot;</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;geo_meanLon&quot;</span><span class="p">]</span>

    
    <span class="n">proj_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;central_longitude&#39;</span><span class="p">:</span><span class="n">lon</span><span class="p">}</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">setProj</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;Orthographic&#39;</span><span class="p">,</span> <span class="n">proj_default</span><span class="o">=</span><span class="n">proj_default</span><span class="p">)</span>
    <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">projection</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span> <span class="c1"># add coastlines</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">stock_img</span><span class="p">()</span> <span class="c1"># add the relief</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span>
               <span class="n">s</span><span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
               <span class="n">facecolor</span> <span class="o">=</span> <span class="n">marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
               <span class="n">marker</span> <span class="o">=</span> <span class="n">marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
               <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    

    <span class="c1"># Spectral analysis</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No age or year information available, skipping spectral analysis&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;depth&#39;</span> <span class="ow">in</span> <span class="n">x_label</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Both age and year information are available.&quot;</span><span class="p">)</span>
                <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Which one would you like to use? &quot;</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">x_axis</span> <span class="o">!=</span> <span class="s2">&quot;year&quot;</span> <span class="ow">and</span> <span class="n">x_axis</span> <span class="o">!=</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span>
                    <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Only enter year or age: &quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">x_axis</span> <span class="o">=</span> <span class="s1">&#39;age&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">x_axis</span> <span class="o">=</span> <span class="s1">&#39;year&#39;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkXaxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>
            <span class="n">y</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># Perform the analysis</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tau&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;freqs&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">,</span>
                           <span class="s1">&#39;nproc&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                           <span class="s1">&#39;nMC&#39;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span>
                           <span class="s1">&#39;detrend&#39;</span><span class="p">:</span><span class="s1">&#39;no&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;params&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                           <span class="s1">&#39;gaussianize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="s1">&#39;standardize&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                           <span class="s1">&#39;Neff&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                           <span class="s1">&#39;anti_alias&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                           <span class="s1">&#39;avgs&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                           <span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="s1">&#39;Kirchner_f2py&#39;</span><span class="p">,</span>
                           <span class="p">}</span>
        <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="o">**</span><span class="n">default</span><span class="p">)</span>

        <span class="c1"># Make the plot</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PSD&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">marker</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;AR1 95%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">xkcd_rgb</span><span class="p">[</span><span class="s2">&quot;pale red&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Spectral Density&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Period (&#39;</span><span class="o">+</span>\
                    <span class="n">x_label</span><span class="p">[</span><span class="n">x_label</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">x_label</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">:</span><span class="n">x_label</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposx</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">nonposy</span><span class="o">=</span><span class="s1">&#39;clip&#39;</span><span class="p">)</span>

        <span class="n">ax4</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_xaxis</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1">#Add the metadata</span>
    <span class="n">textstr</span> <span class="o">=</span> <span class="s2">&quot;archiveType: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;archiveType&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;Authors: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;Year: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;DOI: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;DOI&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;Variable: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;units: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;Climate Interpretation: &quot;</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;    Climate Variable: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Climate_Variable&quot;</span><span class="p">]</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;    Detail: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Detail&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;    Seasonality: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Seasonality&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;    Direction: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Interpretation_Direction&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
              <span class="s2">&quot;Calibration: </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> \
              <span class="s2">&quot;    Equation: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Calibration_equation&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>\
              <span class="s2">&quot;    Notes: &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Calibration_notes&quot;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">textstr</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

    <span class="c1">#Save the figure if asked</span>
    <span class="k">if</span> <span class="n">saveFig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;plot_timeseries_&#39;</span><span class="o">+</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;dataSetName&quot;</span><span class="p">]</span><span class="o">+</span>\
            <span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">y_label</span>
        <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Statistics</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="statsTs"><a class="viewcode-back" href="../Main.html#pyleoclim.statsTs">[docs]</a><span class="k">def</span> <span class="nf">statsTs</span><span class="p">(</span><span class="n">timeseries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate simple statistics of a timeseries</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries: sytem will prompt for one if not given</span>

<span class="sd">    Returns:</span>
<span class="sd">        the mean, median, min, max, standard deviation and the</span>
<span class="sd">        inter-quartile range (IQR) of a timeseries.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; mean, median, min_, max_, std, IQR = pyleo.statsTs(timeseries)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># get the values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">IQR</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">simpleStats</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">IQR</span></div>

<div class="viewcode-block" id="corrSigTs"><a class="viewcode-back" href="../Main.html#pyleoclim.corrSigTs">[docs]</a><span class="k">def</span> <span class="nf">corrSigTs</span><span class="p">(</span><span class="n">timeseries1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeseries2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
                 <span class="n">autocorrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">autocorrect_param</span> <span class="o">=</span> <span class="mi">1950</span><span class="p">,</span> <span class="n">interp_method</span> <span class="o">=</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">,</span>\
                 <span class="n">interp_step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nsim</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> \
                 <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;isospectral&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Estimates the significance of correlations between non IID timeseries.</span>


<span class="sd">        Args:</span>
<span class="sd">            timeseries1, timeseries2: timeseries object. Default is blank.</span>
<span class="sd">            x-axis (str): The representation against which to express the</span>
<span class="sd">                paleo-data. Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;.</span>
<span class="sd">                Default is to let the system choose if only one available</span>
<span class="sd">                or prompt the user.</span>
<span class="sd">            interp_method (str): If the timeseries are not on the same axis, which</span>
<span class="sd">                interpolation method to use. Valid entries are &#39;interpolation&#39;</span>
<span class="sd">                (default) and &#39;bin&#39;. </span>
<span class="sd">            autocorrect (bool): If applicable, convert age to year automatically.</span>
<span class="sd">                If set to False, timeseries objects should have converted time</span>
<span class="sd">                axis and updated units label in the dictionary</span>
<span class="sd">            autocorrect_param (float): Reference for age/year conversion.</span>
<span class="sd">            interp_step (float): the step size. By default, will prompt the user.</span>
<span class="sd">            start (float): Start time/age/depth. Default is the maximum of</span>
<span class="sd">                the minima of the two timeseries</span>
<span class="sd">            end (float): End time/age/depth. Default is the minimum of the</span>
<span class="sd">                maxima of the two timeseries</span>
<span class="sd">            nsim (int): the number of simulations. Default is 1000</span>
<span class="sd">            method (str): method use to estimate the correlation and significance.</span>
<span class="sd">                Available methods include:</span>
<span class="sd">                    - &#39;ttest&#39;: T-test where the degrees of freedom are corrected for</span>
<span class="sd">                    the effect of serial correlation \n</span>
<span class="sd">                    - &#39;isopersistant&#39;: AR(1) modeling of the two timeseries \n</span>
<span class="sd">                    - &#39;isospectral&#39; (default): phase randomization of original</span>
<span class="sd">                    inputs.</span>
<span class="sd">                The T-test is parametric test, hence cheap but usually wrong</span>
<span class="sd">                except in idyllic circumstances.</span>
<span class="sd">                The others are non-parametric, but their computational</span>
<span class="sd">                requirements scales with nsim.</span>
<span class="sd">            alpha (float): significance level for critical value estimation. Default is 0.05</span>

<span class="sd">        Returns:</span>
<span class="sd">            r (float) - correlation between the two timeseries \n</span>
<span class="sd">            sig (bool) -  Returns True if significant, False otherwise \n</span>
<span class="sd">            p (real) - the p-value</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries1</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries2</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries2</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>
        
    
    <span class="c1"># Get the first time and paleoData values</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries1</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="n">timeseries1</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1"># Get the second one</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries2</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="n">timeseries2</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>
    
    <span class="c1">#Make sure that the label is the same</span>
    <span class="k">if</span> <span class="n">label1</span> <span class="o">!=</span> <span class="n">label2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">autocorrect</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting year to age...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">autocorrect_param</span><span class="o">-</span><span class="n">x1</span>
                <span class="n">units1</span> <span class="o">=</span> <span class="s1">&#39;yr BP&#39;</span>
                <span class="n">units2</span> <span class="o">=</span> <span class="n">timeseries2</span><span class="p">[</span><span class="n">label2</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
                <span class="n">label1</span> <span class="o">=</span> <span class="s1">&#39;year B.P.&#39;</span>
            <span class="k">elif</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">autocorrect_param</span><span class="o">-</span><span class="n">x2</span>
                <span class="n">units2</span> <span class="o">=</span> <span class="s1">&#39;yr BP&#39;</span>
                <span class="n">units1</span> <span class="o">=</span> <span class="n">timeseries1</span><span class="p">[</span><span class="n">label1</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;The two timeseries share a different time representation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">units2</span> <span class="o">=</span> <span class="n">timeseries2</span><span class="p">[</span><span class="n">label2</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="n">units1</span> <span class="o">=</span> <span class="n">timeseries1</span><span class="p">[</span><span class="n">label1</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
   
    <span class="c1"># Tranform the units if necessary</span>
    
    <span class="k">if</span> <span class="n">units1</span> <span class="o">!=</span> <span class="n">units2</span><span class="p">:</span>
        <span class="n">units1_group</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">timeUnitsCheck</span><span class="p">(</span><span class="n">units1</span><span class="p">)</span>
        <span class="n">units2_group</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">timeUnitsCheck</span><span class="p">(</span><span class="n">units2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">units1_group</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;Units unknown, manual conversion needed&#39;</span>
        <span class="k">assert</span> <span class="n">units2_group</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;Units unknown, manual conversion needed&#39;</span>
        <span class="k">if</span> <span class="n">units1_group</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">units1_group</span> <span class="o">=</span> <span class="s1">&#39;year_units&#39;</span>
            <span class="k">elif</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;age_units&#39;</span>
        <span class="k">if</span> <span class="n">units2_group</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;year_units&#39;</span>
            <span class="k">elif</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;age_units&#39;</span>
        <span class="c1">#convert kyr to yr if needed</span>
        <span class="k">if</span> <span class="n">units1_group</span> <span class="o">!=</span> <span class="n">units2_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">units1_group</span> <span class="o">==</span> <span class="s1">&#39;kage_units&#39;</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">*</span><span class="mi">1000</span>
            <span class="k">if</span> <span class="n">units2_group</span> <span class="o">==</span> <span class="s1">&#39;kage_units&#39;</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="o">*</span><span class="mi">1000</span>
    
    <span class="c1"># Remove NaNs and ordered</span>
    <span class="n">y1</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">y2</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>

    <span class="c1">#Check that the two timeseries have the same lenght and if not interpolate</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The two series don&#39;t have the same length. Interpolating ...&quot;</span><span class="p">)</span>
        <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">interp_values1</span><span class="p">,</span> <span class="n">interp_values2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">onCommonAxis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span>
                                                                     <span class="n">method</span> <span class="o">=</span> <span class="n">interp_method</span><span class="p">,</span>
                                                                     <span class="n">step</span> <span class="o">=</span> <span class="n">interp_step</span><span class="p">,</span>
                                                                     <span class="n">start</span> <span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                                                     <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The two series don&#39;t have the same length. Interpolating ...&quot;</span><span class="p">)</span>
        <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">interp_values1</span><span class="p">,</span> <span class="n">interp_values2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">onCommonAxis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span>
                                                                     <span class="n">method</span> <span class="o">=</span> <span class="n">interp_method</span><span class="p">,</span>
                                                                     <span class="n">step</span> <span class="o">=</span> <span class="n">interp_step</span><span class="p">,</span>
                                                                     <span class="n">start</span> <span class="o">=</span><span class="n">start</span><span class="p">,</span>
                                                                     <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#xi = x1</span>
        <span class="n">interp_values1</span> <span class="o">=</span> <span class="n">y1</span>
        <span class="n">interp_values2</span> <span class="o">=</span> <span class="n">y2</span>

    <span class="c1">#Make sure that these vectors are not empty, otherwise return an error</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">interp_values1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">interp_values2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No common time period between the two time series.&quot;</span><span class="p">)</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">corrsig</span><span class="p">(</span><span class="n">interp_values1</span><span class="p">,</span><span class="n">interp_values2</span><span class="p">,</span><span class="n">nsim</span><span class="o">=</span><span class="n">nsim</span><span class="p">,</span>
                                 <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">p</span></div>

<span class="c1">#def liang_causalityTS(timeseries1 = None,timeseries2 = None, x_axis = None,\</span>
<span class="c1">#                      interp_step = None, start = None, end = None, p= 1):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Estimate T21, the Liang information transfer from series x2 to series x1</span>
<span class="c1">#    dt is taken to be 1.</span>
<span class="c1">#</span>
<span class="c1">#    Args:</span>
<span class="c1">#        timeseries1, timeseries2: timeseries object. Default is blank</span>
<span class="c1">#        x-axis (str): The representation against which to express the</span>
<span class="c1">#                paleo-data. Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;.</span>
<span class="c1">#                Default is to let the system choose if only one available</span>
<span class="c1">#                or prompt the user.</span>
<span class="c1">#            interp_step (float): the step size. By default, will prompt the user.</span>
<span class="c1">#            start (float): Start time/age/depth. Default is the maximum of</span>
<span class="c1">#                the minima of the two timeseries</span>
<span class="c1">#            end (float): End time/age/depth. Default is the minimum of the</span>
<span class="c1">#                maxima of the two timeseries</span>
<span class="c1">#        p (int &gt;=1 ) -  time advance in performing Euler forward differencing, e.g., 1, 2. Unless the series are generated \</span>
<span class="c1">#                        with a highly chaotic deterministic system, p=1 should be used.</span>
<span class="c1">#</span>
<span class="c1">#    Returns:</span>
<span class="c1">#        T21 - info flow from X2 to X1	(Note: Not X1 -&gt; X2!)</span>
<span class="c1">#        err90(float) - standard error at 90% significance level</span>
<span class="c1">#        err95(float) - standard error at 95% significance level</span>
<span class="c1">#        err99(float) - standard error at 99% significance level</span>
<span class="c1">#</span>
<span class="c1">#    References:</span>
<span class="c1">#        - Liang, X.S. (2013) The Liang-Kleeman Information Flow: Theory and</span>
<span class="c1">#            Applications. Entropy, 15, 327-360, doi:10.3390/e15010327</span>
<span class="c1">#        - Liang, X.S. (2014) Unraveling the cause-efect relation between timeseries.</span>
<span class="c1">#            Physical review, E 90, 052150</span>
<span class="c1">#        - Liang, X.S. (2015) Normalizing the causality between time series.</span>
<span class="c1">#            Physical review, E 92, 022126</span>
<span class="c1">#        - Liang, X.S. (2016) Information flow and causality as rigorous notions ab initio.</span>
<span class="c1">#            Physical review, E 94, 052201</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    if not timeseries1:</span>
<span class="c1">#        if not &#39;ts_list&#39; in globals():</span>
<span class="c1">#            fetchTs()</span>
<span class="c1">#        timeseries1 = LipdUtils.getTs(ts_list)</span>
<span class="c1">#</span>
<span class="c1">#    if not timeseries2:</span>
<span class="c1">#        if not &#39;ts_list&#39; in globals():</span>
<span class="c1">#            fetchTs()</span>
<span class="c1">#        timeseries2 = LipdUtils.getTs(ts_list)</span>
<span class="c1">#</span>
<span class="c1">#    # Get the first time and paleoData values</span>
<span class="c1">#    y1 = np.array(timeseries1[&#39;paleoData_values&#39;], dtype = &#39;float64&#39;)</span>
<span class="c1">#    x1, label1 = LipdUtils.checkXaxis(timeseries1, x_axis=x_axis)</span>
<span class="c1">#</span>
<span class="c1">#    # Get the second one</span>
<span class="c1">#    y2 = np.array(timeseries2[&#39;paleoData_values&#39;], dtype = &#39;float64&#39;)</span>
<span class="c1">#    x2, label2 = LipdUtils.checkXaxis(timeseries2, x_axis=x_axis)</span>
<span class="c1">#</span>
<span class="c1">#    # Remove NaNs and ordered</span>
<span class="c1">#    y1,x1 = Timeseries.clean_ts(y1,x1)</span>
<span class="c1">#    y2,x2 = Timeseries.clean_ts(y2,x2)</span>
<span class="c1">#</span>
<span class="c1">#    # Make sure that the series have the same units:</span>
<span class="c1">#    units1 = timeseries1[label1+&#39;Units&#39;]</span>
<span class="c1">#    units2 = timeseries2[label2+&#39;Units&#39;]</span>
<span class="c1">#</span>
<span class="c1">#    if units2!=units1:</span>
<span class="c1">#        print(&#39;Warning: The two timeseries are on different time units!&#39;)</span>
<span class="c1">#        print(&#39;The units of timeseries1 are &#39;+units1)</span>
<span class="c1">#        print(&#39;The units of timeseries2 are &#39;+units2)</span>
<span class="c1">#        answer = input(&#39;Enter an equation to convert the units of x2 onto x1.&#39;+</span>
<span class="c1">#                       &quot; The equation should be written in Python format&quot;+</span>
<span class="c1">#                       &quot; (e.g., a*x2+b or 1950-a*x2) or press enter to abort: &quot;)</span>
<span class="c1">#</span>
<span class="c1">#        if not answer:</span>
<span class="c1">#            sys.exit(&quot;Aborted by User&quot;)</span>
<span class="c1">#        elif &quot;x2&quot; not in answer:</span>
<span class="c1">#            answer = input(&quot;The form must be a valid python expression and contain x2!&quot;+</span>
<span class="c1">#                           &quot;Enter a valid expression: &quot;)</span>
<span class="c1">#            while &quot;x2&quot; not in answer:</span>
<span class="c1">#                answer = input(&quot;The form must be a valid python expression and contain x2!&quot;+</span>
<span class="c1">#                           &quot;Enter a valid expression: &quot;)</span>
<span class="c1">#        else: x2 = eval(answer)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#    #Check that the two timeseries have the same lenght and if not interpolate</span>
<span class="c1">#    if len(y1) != len(y2):</span>
<span class="c1">#        print(&quot;The two series don&#39;t have the same length. Interpolating ...&quot;)</span>
<span class="c1">#        xi, interp_values1, interp_values2 = Timeseries.onCommonAxis(x1,y1,x2,y2,</span>
<span class="c1">#                                                                     interp_step = interp_step,</span>
<span class="c1">#                                                                     start =start,</span>
<span class="c1">#                                                                     end=end)</span>
<span class="c1">#    elif min(x1) != min(x2) and max(x1) != max(x2):</span>
<span class="c1">#        print(&quot;The two series don&#39;t have the same length. Interpolating ...&quot;)</span>
<span class="c1">#        xi, interp_values1, interp_values2 = Timeseries.onCommonAxis(x1,y1,x2,y2,</span>
<span class="c1">#                                                                     interp_step = interp_step,</span>
<span class="c1">#                                                                     start =start,</span>
<span class="c1">#                                                                     end=end)</span>
<span class="c1">#    else:</span>
<span class="c1">#        #xi = x1</span>
<span class="c1">#        interp_values1 = y1</span>
<span class="c1">#        interp_values2 = y2</span>
<span class="c1">#</span>
<span class="c1">#    #Make sure that these vectors are not empty, otherwise return an error</span>
<span class="c1">#    if np.size(interp_values1) == 0 or np.size(interp_values2) == 0:</span>
<span class="c1">#        sys.exit(&quot;No common time period between the two time series.&quot;)</span>
<span class="c1">#    </span>
<span class="c1">#    # Perform causality</span>
<span class="c1">#    T21, err90, err95, err99 = Timeseries.liang_causality(interp_values1,</span>
<span class="c1">#                                                          interp_values2,</span>
<span class="c1">#                                                          p =p)</span>
<span class="c1">#    </span>
<span class="c1">#    return T21, err90, err95, err99</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Timeseries manipulation</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="binTs"><a class="viewcode-back" href="../Main.html#pyleoclim.binTs">[docs]</a><span class="k">def</span> <span class="nf">binTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
          <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bin the paleoData values of the timeseries</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries. By default, will prompt the user for one.</span>
<span class="sd">        x-axis (str): The representation against which to plot the paleo-data.</span>
<span class="sd">            Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;. Default is to let the</span>
<span class="sd">            system  choose if only one available or prompt the user.</span>
<span class="sd">        bin_size (float): the size of the bins to be used. By default,</span>
<span class="sd">            will prompt for one</span>
<span class="sd">        start (float): Start time/age/depth. Default is the minimum</span>
<span class="sd">        end (float): End time/age/depth. Default is the maximum</span>

<span class="sd">    Returns:</span>
<span class="sd">        binned_values- the binned output,\n</span>
<span class="sd">        bins-  the bins (centered on the median, i.e. the 100-200 bin is 150),\n</span>
<span class="sd">        n-  number of data points in each bin,\n</span>
<span class="sd">        error- the standard error on the mean in each bin\n</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get the values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkXaxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1">#remove nans</span>
    <span class="n">y</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="c1">#Bin the timeseries:</span>
    <span class="n">bins</span><span class="p">,</span> <span class="n">binned_values</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">binvalues</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span><span class="p">,</span>\
                                                   <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bins</span><span class="p">,</span> <span class="n">binned_values</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">error</span></div>

<div class="viewcode-block" id="interpTs"><a class="viewcode-back" href="../Main.html#pyleoclim.interpTs">[docs]</a><span class="k">def</span> <span class="nf">interpTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interp_step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
             <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple linear interpolation</span>

<span class="sd">    Simple linear interpolation of the data using the numpy.interp method</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries. Default is blank, will prompt for it</span>
<span class="sd">        x-axis (str): The representation against which to plot the paleo-data.</span>
<span class="sd">            Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;. Default is to let the</span>
<span class="sd">            system choose if only one available or prompt the user.</span>
<span class="sd">        interp_step (float): the step size. By default, will prompt the user.</span>
<span class="sd">        start (float): Start year/age/depth. Default is the minimum</span>
<span class="sd">        end (float): End year/age/depth. Default is the maximum</span>

<span class="sd">    Returns:</span>
<span class="sd">        interp_age - the interpolated age/year/depth according to the end/start</span>
<span class="sd">        and time step, \n</span>
<span class="sd">        interp_values - the interpolated values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get the values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkXaxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1">#remove nans</span>
    <span class="n">y</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>

    <span class="c1">#Interpolate the timeseries</span>
    <span class="n">interp_age</span><span class="p">,</span> <span class="n">interp_values</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">interp_step</span> <span class="o">=</span> <span class="n">interp_step</span><span class="p">,</span>\
                                                  <span class="n">start</span><span class="o">=</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">interp_age</span><span class="p">,</span> <span class="n">interp_values</span></div>

<div class="viewcode-block" id="standardizeTs"><a class="viewcode-back" href="../Main.html#pyleoclim.standardizeTs">[docs]</a><span class="k">def</span> <span class="nf">standardizeTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Centers and normalizes the paleoData values of a  given time series.</span>

<span class="sd">    Constant or nearly constant time series not rescaled.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries (array): A LiPD timeseries object </span>
<span class="sd">        scale (real): a scale factor used to scale a record to a match a given variance</span>
<span class="sd">        ddof (int): degress of freedom correction in the calculation of the standard deviation</span>
<span class="sd">        eps (real): a threshold to determine if the standard deviation is too close to zero</span>

<span class="sd">    Returns:</span>
<span class="sd">        z (array): the standardized time series (z-score), Z = (X - E[X])/std(X)*scale, NaNs allowed \n</span>
<span class="sd">        mu (real): the mean of the original time series, E[X] \n</span>
<span class="sd">        sig (real): the standard deviation of the original time series, std[X] \n</span>

<span class="sd">    References:</span>
<span class="sd">        1. Tapio Schneider&#39;s MATLAB code: http://www.clidyn.ethz.ch/imputation/standardize.m</span>
<span class="sd">        2. The zscore function in SciPy: https://github.com/scipy/scipy/blob/master/scipy/stats/stats.py</span>

<span class="sd">    @author: fzhu</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># get the values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># Remove NaNs</span>
    <span class="n">y_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_temp</span><span class="p">)]</span>

    <span class="c1">#Standardize</span>
    <span class="n">z</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sig</span></div>

<div class="viewcode-block" id="segmentTs"><a class="viewcode-back" href="../Main.html#pyleoclim.segmentTs">[docs]</a><span class="k">def</span> <span class="nf">segmentTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Divides a time series into several segments using a gap detection algorithm</span>

<span class="sd">    Gap detection rule: If the time interval between some two data points is</span>
<span class="sd">    larger than some factor times the mean resolution of the timeseries, then</span>
<span class="sd">    a brak point is applied and the timseries is divided.</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries: a LiPD timeseries object</span>
<span class="sd">        factor (float): factor to adjust the threshold. threshold = factor*dt_mean.</span>
<span class="sd">            Default is 2.</span>

<span class="sd">    Returns:</span>
<span class="sd">        seg_y (list) - a list of several segments with potentially different length</span>
<span class="sd">        seg_t (list) - A list of the time values for each y segment.</span>
<span class="sd">        n_segs (int) - the number of segments</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Get the values</span>
    <span class="c1"># Raise an error if age or year not in the keys</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No time information available&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Both age and year information are available.&quot;</span><span class="p">)</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Which one would you like to use? &quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">x_axis</span> <span class="o">!=</span> <span class="s2">&quot;year&quot;</span> <span class="ow">and</span> <span class="n">x_axis</span> <span class="o">!=</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Only enter year or age: &quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;age&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="s1">&#39;age&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="s1">&#39;year&#39;</span>

    <span class="c1"># Get the values</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">ts</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkXaxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1"># remove NaNs</span>
    <span class="n">ys</span><span class="p">,</span><span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>

    <span class="c1">#segment the timeseries</span>
    <span class="n">seg_y</span><span class="p">,</span> <span class="n">seg_t</span><span class="p">,</span> <span class="n">n_segs</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">ts2segments</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">seg_y</span><span class="p">,</span> <span class="n">seg_t</span><span class="p">,</span> <span class="n">n_segs</span></div>

<span class="c1">#&quot;&quot;&quot;</span>
<span class="c1"># Spectral and Wavelet Analysis</span>
<span class="c1">#&quot;&quot;&quot;</span>

<div class="viewcode-block" id="wwzTs"><a class="viewcode-back" href="../Main.html#pyleoclim.wwzTs">[docs]</a><span class="k">def</span> <span class="nf">wwzTs</span><span class="p">(</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wwz</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">wwz_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">psd_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">wwaplot_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">psdplot_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Weigthed wavelet Z-transform analysis</span>

<span class="sd">    Wavelet analysis for unevenly spaced data adapted from Foster et al. (1996)</span>

<span class="sd">    Args:</span>
<span class="sd">        timeseries (dict): A LiPD timeseries object (Optional, will prompt for one.)</span>
<span class="sd">        lim (list): Truncate the timeseries between min/max time (e.g., [0,10000])</span>
<span class="sd">        wwz (bool): If True, will perform wavelet analysis</span>
<span class="sd">        psd (bool): If True, will inform the power spectral density of the timeseries</span>
<span class="sd">        wwz_default: If True, will use the following default parameters:</span>

<span class="sd">            wwz_default = {&#39;tau&#39;:None,</span>
<span class="sd">                           &#39;freqs&#39;:None,</span>
<span class="sd">                           &#39;c&#39;:1/(8*np.pi**2),</span>
<span class="sd">                           &#39;Neff&#39;:3,</span>
<span class="sd">                           &#39;Neff_coi&#39;:3,</span>
<span class="sd">                           &#39;nMC&#39;:200,</span>
<span class="sd">                           &#39;nproc&#39;:8,</span>
<span class="sd">                           &#39;detrend&#39;:False,</span>
<span class="sd">                           &#39;params&#39; : [&quot;default&quot;,4,0,1],</span>
<span class="sd">                           &#39;gaussianize&#39;: False,</span>
<span class="sd">                           &#39;standardize&#39;:True,</span>
<span class="sd">                           &#39;method&#39;:&#39;Kirchner_f2py&#39;,</span>
<span class="sd">                           &#39;bc_mode&#39;:&#39;reflect&#39;,</span>
<span class="sd">                           &#39;reflect_type&#39;:&#39;odd&#39;,</span>
<span class="sd">                           &#39;len_bd&#39;:0}</span>

<span class="sd">            Modify the values for specific keys to change the default behavior.</span>
<span class="sd">            See Spectral.wwz for details</span>

<span class="sd">        psd_default: If True, will use the following default parameters:</span>

<span class="sd">            psd_default = {&#39;tau&#39;:None,</span>
<span class="sd">                       &#39;freqs&#39;: None,</span>
<span class="sd">                       &#39;c&#39;:1e-3,</span>
<span class="sd">                       &#39;nproc&#39;:8,</span>
<span class="sd">                       &#39;nMC&#39;:200,</span>
<span class="sd">                       &#39;detrend&#39;:False,</span>
<span class="sd">                       &#39;params&#39; : [&quot;default&quot;,4,0,1],</span>
<span class="sd">                       &#39;gaussianize&#39;: False,</span>
<span class="sd">                       &#39;standardize&#39;:True,</span>
<span class="sd">                       &#39;Neff&#39;:3,</span>
<span class="sd">                       &#39;anti_alias&#39;:False,</span>
<span class="sd">                       &#39;avgs&#39;:2,</span>
<span class="sd">                       &#39;method&#39;:&#39;Kirchner_f2py&#39;,</span>
<span class="sd">                       }</span>

<span class="sd">            Modify the values for specific keys to change the default behavior.</span>
<span class="sd">            See Spectral.wwz_psd for detail.s </span>
<span class="sd">        fig (bool): If True, plots the figure    </span>
<span class="sd">        wwaplot_default: If True, will use the following default parameters:</span>

<span class="sd">            wwaplot_default={&#39;AR1_q&#39;:AR1_q,</span>
<span class="sd">                                 &#39;coi&#39;:coi,</span>
<span class="sd">                                 &#39;levels&#39;:None,</span>
<span class="sd">                                 &#39;tick_range&#39;:None,</span>
<span class="sd">                                 &#39;yticks&#39;:None,</span>
<span class="sd">                                 &#39;yticks_label&#39;: None,</span>
<span class="sd">                                 &#39;ylim&#39;:None,</span>
<span class="sd">                                 &#39;xticks&#39;:None,</span>
<span class="sd">                                 &#39;xlabels&#39;:None,</span>
<span class="sd">                                 &#39;figsize&#39;:[20,8],</span>
<span class="sd">                                 &#39;clr_map&#39;:&#39;OrRd&#39;,</span>
<span class="sd">                                 &#39;cbar_drawedges&#39;:False,</span>
<span class="sd">                                 &#39;cone_alpha&#39;:0.5,</span>
<span class="sd">                                 &#39;plot_signif&#39;:True,</span>
<span class="sd">                                 &#39;signif_style&#39;:&#39;contour&#39;,</span>
<span class="sd">                                 &#39;plot_cone&#39;:True,</span>
<span class="sd">                                 &#39;title&#39;:None,</span>
<span class="sd">                                 &#39;ax&#39;:None,</span>
<span class="sd">                                 &#39;xlabel&#39;: the chondata label,</span>
<span class="sd">                                 &#39;ylabel&#39;: &#39;Period (units from ChronData)&#39;,</span>
<span class="sd">                                 &#39;plot_cbar&#39;:&#39;True&#39;,</span>
<span class="sd">                                 &#39;cbar_orientation&#39;:&#39;vertical&#39;,</span>
<span class="sd">                                 &#39;cbar_pad&#39;:0.05,</span>
<span class="sd">                                 &#39;cbar_frac&#39;:0.15,</span>
<span class="sd">                                 &#39;cbar_labelsize&#39;:None}</span>

<span class="sd">            Modify the values for specific keys to change the default behavior.</span>
<span class="sd">        psdplot_default: If True, will use the following default parameters:</span>

<span class="sd">            psdplot_default={&#39;lmstyle&#39;:&#39;-&#39;,</span>
<span class="sd">                                 &#39;linewidth&#39;:None,</span>
<span class="sd">                                 &#39;color&#39;: sns.xkcd_rgb[&quot;denim blue&quot;],</span>
<span class="sd">                                 &#39;ar1_lmstyle&#39;:&#39;-&#39;,</span>
<span class="sd">                                 &#39;ar1_linewidth&#39;:1,</span>
<span class="sd">                                 &#39;period_ticks&#39;:None,</span>
<span class="sd">                                 &#39;period_tickslabel&#39;:None,</span>
<span class="sd">                                 &#39;psd_lim&#39;:None,</span>
<span class="sd">                                 &#39;period_lim&#39;:None,</span>
<span class="sd">                                 &#39;alpha&#39;:1,</span>
<span class="sd">                                 &#39;figsize&#39;:[20,8],</span>
<span class="sd">                                 &#39;label&#39;:&#39;PSD&#39;,</span>
<span class="sd">                                 &#39;plot_ar1&#39;:True,</span>
<span class="sd">                                 &#39;psd_ar1_q95&#39;:95% quantile from psd,</span>
<span class="sd">                                 &#39;title&#39;: None,</span>
<span class="sd">                                 &#39;legend&#39;: &#39;True&#39;</span>
<span class="sd">                                 &#39;psd_ar1_color&#39;:sns.xkcd_rgb[&quot;pale red&quot;],</span>
<span class="sd">                                 &#39;ax&#39;:None,</span>
<span class="sd">                                 &#39;vertical&#39;:False,</span>
<span class="sd">                                 &#39;plot_gridlines&#39;:True,</span>
<span class="sd">                                 &#39;period_label&#39;:&#39;Period (units of age)&#39;,</span>
<span class="sd">                                 &#39;psd_label&#39;:&#39;Spectral Density&#39;,</span>
<span class="sd">                                 &#39;zorder&#39; : None}</span>

<span class="sd">            Modify the values for specific keys to change the default behavior.</span>

<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict_out (dict): A dictionary of outputs.</span>

<span class="sd">            For wwz:</span>

<span class="sd">            - wwa (array): The weights wavelet amplitude</span>

<span class="sd">            - AR1_q (array): AR1 simulations</span>

<span class="sd">            - coi (array): cone of influence</span>

<span class="sd">            - freqs (array): vector for frequencies</span>

<span class="sd">            - tau (array): the evenly-spaced time points, namely the time</span>
<span class="sd">            shift for wavelet analysis.</span>

<span class="sd">            - Neffs (array): The matrix of effective number of points in the</span>
<span class="sd">            time-scale coordinates.</span>

<span class="sd">            - coeff (array): The wavelet transform coefficients</span>

<span class="sd">            For psd:</span>

<span class="sd">            - psd (array): power spectral density</span>

<span class="sd">            - freqs (array): vector of frequency</span>

<span class="sd">            - psd_ar1_q95 (array): the 95% quantile of the psds of AR1 processes</span>

<span class="sd">        fig: The figure</span>

<span class="sd">        References:</span>
<span class="sd">            Foster, G. (1996). Wavelets for period analysis of unevenly</span>
<span class="sd">            sampled time series. The Astronomical Journal, 112(4), 1709-1729.</span>

<span class="sd">        Examples:</span>
<span class="sd">            To run both wwz and psd: \n</span>

<span class="sd">            &gt;&gt;&gt; dict_out, fig = pyleoclim.wwzTs(wwz=True)</span>

<span class="sd">            Note: This will return a single figure with wwa and psd \n</span>

<span class="sd">            To change a default behavior:\n</span>

<span class="sd">            &gt;&gt;&gt; dict_out, fig = pyleoclim.wwzTs(psd_default = {&#39;nMC&#39;:1000})</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure there is something to compute</span>
    <span class="k">if</span> <span class="n">wwz</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">psd</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Set &#39;wwz&#39; and/or &#39;psd&#39; to True&quot;</span><span class="p">)</span>

    <span class="c1"># Get a timeseries</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>

    <span class="c1"># Raise an error if age or year not in the keys</span>
    <span class="n">ts</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>

    <span class="c1"># Set the defaults</span>
    <span class="c1">#Make sure the default have the proper type</span>
    <span class="k">if</span> <span class="n">psd_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psd_default</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;The default for the psd calculation should either be provided&#39;</span><span class="o">+</span>
                 <span class="s1">&#39; as a dictionary or set to True&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">psdplot_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psdplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;The default for the psd figure should either be provided&#39;</span><span class="o">+</span>
                 <span class="s1">&#39; as a dictionary or  set to True&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wwz_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwz_default</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;The default for the wwz calculation should either be provided&#39;</span><span class="o">+</span>
                 <span class="s1">&#39; as a dictionary or  set to True&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wwaplot_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwaplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;The default for the wwa figure should either be provided&#39;</span><span class="o">+</span>
                 <span class="s1">&#39; as a dictionary or set to True&#39;</span><span class="p">)</span>

    <span class="c1"># Get the values</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># remove NaNs</span>
    <span class="n">ys</span><span class="p">,</span><span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>

    <span class="c1"># Truncate the timeseries if asked</span>
    <span class="k">if</span> <span class="n">lim</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">idx_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ts</span><span class="o">&gt;=</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idx_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ts</span><span class="o">&lt;=</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">]</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">idx_low</span><span class="p">:</span><span class="n">idx_high</span><span class="p">]</span>

    <span class="c1">#Get the time units</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">label</span><span class="o">+</span><span class="s2">&quot;Units&quot;</span><span class="p">]</span>
    <span class="n">ageunits</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>

    <span class="c1"># Perform the calculations</span>
    <span class="k">if</span> <span class="n">psd</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">wwz</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># PSD only</span>
        <span class="k">if</span> <span class="n">psd_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">psd_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">psd_default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for psd calculation must be passed as a dictionary&#39;</span><span class="p">)</span>
        <span class="c1"># Wrap up the output dictionary</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psd&#39;</span><span class="p">:</span><span class="n">psd</span><span class="p">,</span>
               <span class="s1">&#39;freqs&#39;</span><span class="p">:</span><span class="n">freqs</span><span class="p">,</span>
               <span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">:</span><span class="n">psd_ar1_q95</span><span class="p">,</span>
               <span class="s1">&#39;psd_ar1&#39;</span><span class="p">:</span><span class="n">psd_ar1</span><span class="p">}</span>

        <span class="c1"># Plot if asked</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">psdplot_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">psdplot_default</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ar1_linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="s1">&#39;plot_ar1&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">:</span><span class="n">psd_ar1_q95</span><span class="p">,</span>
                                 <span class="s1">&#39;period_label&#39;</span><span class="p">:</span><span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">}</span>
           
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">psdplot_default</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span> <span class="c1">#necessary since not same defaults</span>
                <span class="k">if</span> <span class="s1">&#39;ar1_linewidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;ar1_linewidth&#39;</span><span class="p">]</span> <span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="s1">&#39;plot_ar1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;plot_ar1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;psd_ar1_q95&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psd_ar1_q95</span>
                <span class="k">if</span> <span class="s1">&#39;period_label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;period_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for psd plot must be passed as a dictionary&#39;</span><span class="p">)</span>
            
            <span class="n">fig</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">plot_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span><span class="n">freqs</span><span class="p">,</span><span class="o">**</span><span class="n">psdplot_default</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">saveFig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_PSDplot&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">psd</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">wwz</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#WWZ only</span>
        <span class="c1"># Set default</span>
        <span class="k">if</span> <span class="n">wwz_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">#Perform the calculation</span>
            <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwz_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1">#Perform the calculation</span>
            <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">wwz_default</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for wwz calculation must be passed as a dictionary&#39;</span><span class="p">)</span>
        
        <span class="c1">#Wrap up the output dictionary</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wwa&#39;</span><span class="p">:</span><span class="n">wwa</span><span class="p">,</span>
                    <span class="s1">&#39;phase&#39;</span><span class="p">:</span><span class="n">phase</span><span class="p">,</span>
                    <span class="s1">&#39;AR1_q&#39;</span><span class="p">:</span><span class="n">AR1_q</span><span class="p">,</span>
                    <span class="s1">&#39;coi&#39;</span><span class="p">:</span><span class="n">coi</span><span class="p">,</span>
                    <span class="s1">&#39;freqs&#39;</span><span class="p">:</span><span class="n">freqs</span><span class="p">,</span>
                    <span class="s1">&#39;tau&#39;</span><span class="p">:</span><span class="n">tau</span><span class="p">,</span>
                    <span class="s1">&#39;Neffs&#39;</span><span class="p">:</span><span class="n">Neffs</span><span class="p">,</span>
                    <span class="s1">&#39;coeff&#39;</span><span class="p">:</span><span class="n">coeff</span><span class="p">}</span>

        <span class="c1">#Plot if asked</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Set the plot default</span>
            <span class="k">if</span> <span class="n">wwaplot_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wwaplot_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AR1_q&#39;</span><span class="p">:</span><span class="n">AR1_q</span><span class="p">,</span>
                                   <span class="s1">&#39;coi&#39;</span><span class="p">:</span><span class="n">coi</span><span class="p">,</span>
                                   <span class="s1">&#39;plot_signif&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="s1">&#39;plot_cone&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                                   <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">}</span>
            
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwaplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span> <span class="c1">#necessary since not same defaults</span>
                <span class="k">if</span> <span class="s1">&#39;AR1_q&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;AR1_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR1_q</span>
                <span class="k">if</span> <span class="s1">&#39;coi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;coi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">coi</span>
                <span class="k">if</span> <span class="s1">&#39;plot_signif&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;plot_signif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;xlabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">if</span> <span class="s1">&#39;ylabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;ylabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for wwz plot must be passed as a dictionary&#39;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">plot_wwa</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="o">**</span><span class="n">wwaplot_default</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">saveFig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_PSDplot&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">elif</span> <span class="n">psd</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">wwz</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># perform both</span>

        <span class="c1"># PSD calculations</span>
        <span class="k">if</span> <span class="n">psd_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">psd_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">psd</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">psd_ar1_q95</span><span class="p">,</span> <span class="n">psd_ar1</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz_psd</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">psd_default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for psd calculation must be passed as a dictionary&#39;</span><span class="p">)</span>
        
        <span class="c1">#WWZ calculations</span>
        <span class="k">if</span> <span class="n">wwz_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">#Perform the calculation</span>
            <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwz_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1">#Perform the calculation</span>
            <span class="n">wwa</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">AR1_q</span><span class="p">,</span> <span class="n">coi</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">Neffs</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">wwz</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">wwz_default</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for wwz calculation must be passed as a dictionary&#39;</span><span class="p">)</span>
        
        <span class="c1">#Wrap up the output dictionary</span>
        <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wwa&#39;</span><span class="p">:</span><span class="n">wwa</span><span class="p">,</span>
                    <span class="s1">&#39;phase&#39;</span><span class="p">:</span><span class="n">phase</span><span class="p">,</span>
                    <span class="s1">&#39;AR1_q&#39;</span><span class="p">:</span><span class="n">AR1_q</span><span class="p">,</span>
                    <span class="s1">&#39;coi&#39;</span><span class="p">:</span><span class="n">coi</span><span class="p">,</span>
                    <span class="s1">&#39;freqs&#39;</span><span class="p">:</span><span class="n">freqs</span><span class="p">,</span>
                    <span class="s1">&#39;tau&#39;</span><span class="p">:</span><span class="n">tau</span><span class="p">,</span>
                    <span class="s1">&#39;Neffs&#39;</span><span class="p">:</span><span class="n">Neffs</span><span class="p">,</span>
                    <span class="s1">&#39;coeff&#39;</span><span class="p">:</span><span class="n">coeff</span><span class="p">,</span>
                    <span class="s1">&#39;psd&#39;</span><span class="p">:</span><span class="n">psd</span><span class="p">,</span>
                    <span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">:</span><span class="n">psd_ar1_q95</span><span class="p">,</span>
                    <span class="s1">&#39;psd_ar1&#39;</span><span class="p">:</span><span class="n">psd_ar1</span><span class="p">}</span>

        <span class="c1"># Make the plot if asked</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">#Figure out the figure size</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwaplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psdplot_default</span><span class="p">)</span><span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwaplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">psdplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>


            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span> <span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wwaplot_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">wwaplot_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AR1_q&#39;</span><span class="p">:</span><span class="n">AR1_q</span><span class="p">,</span>
                                   <span class="s1">&#39;coi&#39;</span><span class="p">:</span><span class="n">coi</span><span class="p">,</span>
                                   <span class="s1">&#39;plot_signif&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="s1">&#39;plot_cone&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                                   <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;ax&#39;</span><span class="p">:</span><span class="n">ax1</span><span class="p">}</span>
            
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">wwaplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span> <span class="c1">#necessary since not same defaults</span>
                <span class="k">if</span> <span class="s1">&#39;AR1_q&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;AR1_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR1_q</span>
                <span class="k">if</span> <span class="s1">&#39;coi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;coi&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">coi</span>
                <span class="k">if</span> <span class="s1">&#39;plot_signif&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;plot_signif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;xlabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="k">if</span> <span class="s1">&#39;ylabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;ylabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;ax&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wwaplot_default</span><span class="p">:</span>
                    <span class="n">wwaplot_default</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for wwz plot must be passed as a dictionary&#39;</span><span class="p">)</span>


            <span class="n">Spectral</span><span class="o">.</span><span class="n">plot_wwa</span><span class="p">(</span><span class="n">wwa</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="o">**</span><span class="n">wwaplot_default</span><span class="p">)</span>

            <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">psdplot_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">psdplot_default</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ar1_linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="s1">&#39;plot_ar1&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">:</span><span class="n">psd_ar1_q95</span><span class="p">,</span>
                                 <span class="s1">&#39;period_label&#39;</span><span class="p">:</span><span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">ax2</span><span class="p">}</span>
           
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">psdplot_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span> <span class="c1">#necessary since not same defaults</span>
                <span class="k">if</span> <span class="s1">&#39;ar1_linewidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;ar1_linewidth&#39;</span><span class="p">]</span> <span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="s1">&#39;plot_ar1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;plot_ar1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;psd_ar1_q95&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;psd_ar1_q95&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psd_ar1_q95</span>
                <span class="k">if</span> <span class="s1">&#39;period_label&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;period_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Period (&#39;</span><span class="o">+</span><span class="n">ageunits</span><span class="o">+</span><span class="s1">&#39;)&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;ax&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psdplot_default</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">psdplot_default</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Options for psd plot must be passed as a dictionary&#39;</span><span class="p">)</span>
            
            <span class="n">Spectral</span><span class="o">.</span><span class="n">plot_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span><span class="n">freqs</span><span class="p">,</span><span class="o">**</span><span class="n">psdplot_default</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">saveFig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_PSDplot&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">dict_out</span><span class="p">,</span> <span class="n">fig</span></div>

<span class="c1">## Cross wavelet transform</span>
<span class="k">def</span> <span class="nf">xwcTs</span><span class="p">(</span><span class="n">timeseries1</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">timeseries2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
          <span class="n">autocorrect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">autocorrect_param</span> <span class="o">=</span><span class="mi">1950</span><span class="p">,</span> <span class="n">xwc_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">fig</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">xwcplot_default</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cross Wavelet transform of two timeseries</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        timeseries1, timseries2 (dict): a LiPD timeseries object (Optional, will prompt for one)</span>
<span class="sd">        lim (list): Truncate the timeseries between min/max time (e.g., [0,10000])</span>
<span class="sd">        x-axis (str): The representation against which to express the</span>
<span class="sd">                paleo-data. Options are &quot;age&quot;, &quot;year&quot;, and &quot;depth&quot;.</span>
<span class="sd">                Default is to let the system choose if only one available</span>
<span class="sd">                or prompt the user.</span>
<span class="sd">        autocorrect (bool): If applicable, convert age to year automatically.</span>
<span class="sd">                If set to False, timeseries objects should have converted time</span>
<span class="sd">                axis and updated units label in the dictionary</span>
<span class="sd">        autocorrect_param (float): Reference for age/year conversion.</span>
<span class="sd">        xwt_default: If True, will use the followinf default parameters</span>
<span class="sd">            </span>
<span class="sd">            xwt_default = {&#39;tau&#39;: None,</span>
<span class="sd">                           &#39;feqs&#39;: None,</span>
<span class="sd">                           &#39;c&#39;: 1/(8*np.pi**2),</span>
<span class="sd">                           &#39;Neff&#39;: 3,</span>
<span class="sd">                           &#39;Neff_coi&#39;: 6,</span>
<span class="sd">                           &#39;nproc&#39;: 8,</span>
<span class="sd">                           &#39;detrend&#39;: False,</span>
<span class="sd">                           &#39;params&#39;: [&#39;default&#39;, 4, 0, 1],</span>
<span class="sd">                           &#39;gaussianize&#39;: False,</span>
<span class="sd">                           &#39;standardize&#39;:True,</span>
<span class="sd">                           &#39;method&#39;:&#39;Kirchner_f2py&#39;}</span>
<span class="sd">            Modify the values for specific keys to change the default behavior.</span>
<span class="sd">            See Spectral.xwt for details</span>
<span class="sd">        fig (bool): If True, plots the figure </span>
<span class="sd">        xwcplot_default: If True, will use the following default parameters:</span>
<span class="sd">            </span>
<span class="sd">            wwaplot_default={&#39;pt&#39;:0.5,</span>
<span class="sd">                                 &#39;levels&#39;:None,</span>
<span class="sd">                                 &#39;tick_range&#39;:None,</span>
<span class="sd">                                 &#39;basey&#39;:2,</span>
<span class="sd">                                 &#39;yticks&#39;: None,</span>
<span class="sd">                                 &#39;ylime&#39;:None,</span>
<span class="sd">                                 &#39;xticks&#39;:None,</span>
<span class="sd">                                 &#39;xlabels&#39;:None,</span>
<span class="sd">                                 &#39;figsize&#39;:[20,8],</span>
<span class="sd">                                 &#39;clr_map&#39;:&#39;OrRd&#39;,</span>
<span class="sd">                                 &#39;skip_x&#39;:5,</span>
<span class="sd">                                 &#39;skip_y&#39;:5,</span>
<span class="sd">                                 &#39;scale&#39;:30,</span>
<span class="sd">                                 &#39;width&#39;:0.004,</span>
<span class="sd">                                 &#39;cbar_drawedges&#39;:False</span>
<span class="sd">                                 &#39;cone_alpha&#39;:0.5,</span>
<span class="sd">                                 &#39;plot_signif&#39;:True,</span>
<span class="sd">                                 &#39;signif_style&#39;:&#39;contour&#39;</span>
<span class="sd">                                 &#39;title&#39;:None,</span>
<span class="sd">                                 &#39;plot_cone&#39;:True,</span>
<span class="sd">                                 &#39;ax&#39;:None,</span>
<span class="sd">                                 &#39;xlabel&#39;:Age representation,</span>
<span class="sd">                                 &#39;ylabel&#39;: &quot;Period (year)&quot;,</span>
<span class="sd">                                 &#39;cbar_orientation&#39;:&#39;vertical&#39;,</span>
<span class="sd">                                 &#39;cbar_pad&#39;:0.05,</span>
<span class="sd">                                 &#39;cbar_frac&#39;:0.15,</span>
<span class="sd">                                 &#39;cbar_labelsize&#39;:None</span>
<span class="sd">                                 }</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            res (dict): contains the cross wavelet coherence, cross-wavelet phase,</span>
<span class="sd">            vector of frequency, evenly-spaced time points, AR1 sims, cone of influence</span>
<span class="sd">            </span>
<span class="sd">            fig</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Get timeseries</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries1</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timeseries2</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ts_list&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
            <span class="n">fetchTs</span><span class="p">()</span>
        <span class="n">timeseries2</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getTs</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>
    
    <span class="c1"># Get the first time and paleoData values</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries1</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="n">timeseries1</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="c1"># Get the second one</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">timeseries2</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">checkTimeAxis</span><span class="p">(</span><span class="n">timeseries2</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="n">x_axis</span><span class="p">)</span>
        
    <span class="c1">#Make sure that the label is the same</span>
    <span class="k">if</span> <span class="n">label1</span> <span class="o">!=</span> <span class="n">label2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">autocorrect</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting year to age...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">autocorrect_param</span><span class="o">-</span><span class="n">x1</span>
                <span class="n">units1</span> <span class="o">=</span> <span class="s1">&#39;yr BP&#39;</span>
                <span class="n">units2</span> <span class="o">=</span> <span class="n">timeseries2</span><span class="p">[</span><span class="n">label2</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
                <span class="n">label1</span> <span class="o">=</span> <span class="s1">&#39;year B.P.&#39;</span>
            <span class="k">elif</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">autocorrect_param</span><span class="o">-</span><span class="n">x2</span>
                <span class="n">units2</span> <span class="o">=</span> <span class="s1">&#39;yr BP&#39;</span>
                <span class="n">units1</span> <span class="o">=</span> <span class="n">timeseries1</span><span class="p">[</span><span class="n">label1</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;The two timeseries share a different time representation&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">units2</span> <span class="o">=</span> <span class="n">timeseries2</span><span class="p">[</span><span class="n">label2</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
        <span class="n">units1</span> <span class="o">=</span> <span class="n">timeseries1</span><span class="p">[</span><span class="n">label1</span><span class="o">+</span><span class="s1">&#39;Units&#39;</span><span class="p">]</span>
   
    <span class="c1"># Tranform the units if necessary</span>
    
    <span class="k">if</span> <span class="n">units1</span> <span class="o">!=</span> <span class="n">units2</span><span class="p">:</span>
        <span class="n">units1_group</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">timeUnitsCheck</span><span class="p">(</span><span class="n">units1</span><span class="p">)</span>
        <span class="n">units2_group</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">timeUnitsCheck</span><span class="p">(</span><span class="n">units2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">units1_group</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;Units unknown, manual conversion needed&#39;</span>
        <span class="k">assert</span> <span class="n">units2_group</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;Units unknown, manual conversion needed&#39;</span>
        <span class="k">if</span> <span class="n">units1_group</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">units1_group</span> <span class="o">=</span> <span class="s1">&#39;year_units&#39;</span>
            <span class="k">elif</span> <span class="n">label1</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;age_units&#39;</span>
        <span class="k">if</span> <span class="n">units2_group</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;year_units&#39;</span>
            <span class="k">elif</span> <span class="n">label2</span> <span class="o">==</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span>
                <span class="n">units2_group</span> <span class="o">=</span> <span class="s1">&#39;age_units&#39;</span>
        <span class="c1">#convert kyr to yr if needed</span>
        <span class="k">if</span> <span class="n">units1_group</span> <span class="o">!=</span> <span class="n">units2_group</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">units1_group</span> <span class="o">==</span> <span class="s1">&#39;kage_units&#39;</span><span class="p">:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">*</span><span class="mi">1000</span>
                <span class="n">label1</span> <span class="o">=</span> <span class="s1">&#39;age&#39;</span>
                <span class="n">units1</span> <span class="o">=</span> <span class="s1">&#39;yr  BP&#39;</span>
            <span class="k">if</span> <span class="n">units2_group</span> <span class="o">==</span> <span class="s1">&#39;kage_units&#39;</span><span class="p">:</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="o">*</span><span class="mi">1000</span>
                <span class="n">label2</span> <span class="o">=</span> <span class="s1">&#39;age&#39;</span>
                <span class="n">units2</span> <span class="o">=</span> <span class="s1">&#39;yr BP&#39;</span>
    
    <span class="c1"># Remove NaNs and ordered</span>
    <span class="n">y1</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">y2</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">clean_ts</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">x2</span><span class="p">)</span>
    
    <span class="c1">#Check that the timeseries are on a common axis</span>
    <span class="k">if</span> <span class="n">lim</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">interp_values1</span><span class="p">,</span> <span class="n">interp_values2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">onCommonAxis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span>
                                                                       <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The time series limits should be of type list&#39;</span><span class="p">)</span> 
        <span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">,</span> <span class="n">interp_values1</span><span class="p">,</span> <span class="n">interp_values2</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="o">.</span><span class="n">onCommonAxis</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span>
                                                                       <span class="n">start</span><span class="o">=</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                       <span class="n">end</span><span class="o">=</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#perform the cross-wavelet analysis</span>
    <span class="k">if</span> <span class="n">xwc_default</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">xwc</span><span class="p">(</span><span class="n">interp_values1</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">interp_values2</span><span class="p">,</span><span class="n">xi2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">xwc_default</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">xwc</span><span class="p">(</span><span class="n">interp_values1</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="n">interp_values2</span><span class="p">,</span><span class="n">xi2</span><span class="p">,</span> <span class="o">**</span><span class="n">xwc_default</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Options for the x-wavelet calculation must be passed as a dictionary&#39;</span><span class="p">)</span>
    
    
    <span class="c1"># Figure if asked</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">xwcplot_default</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;plot_signif&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;plot_cone&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="n">units1</span><span class="p">,</span>
                         <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span><span class="s1">&#39;Period (years)&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">xwcplot_default</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;plot_signif&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xwcplot_default</span><span class="p">:</span>
                <span class="n">xwcplot_default</span><span class="p">[</span><span class="s1">&#39;plot_signif&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;plot_cone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xwcplot_default</span><span class="p">:</span>
                <span class="n">xwcplot_default</span><span class="p">[</span><span class="s1">&#39;plot_cone&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;xlabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xwcplot_default</span><span class="p">:</span>
                <span class="n">xwcplot_default</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">units1</span>
            <span class="k">if</span> <span class="s1">&#39;ylabel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xwcplot_default</span><span class="p">:</span>
                <span class="n">xwcplot_default</span><span class="p">[</span><span class="s1">&#39;ylabel&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;Period (years)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Options for the x-wavelet plot must be passed as a dictionary&#39;</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">Spectral</span><span class="o">.</span><span class="n">plot_coherence</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="o">**</span><span class="n">xwcplot_default</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">saveFig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">timeseries1</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span>\
                                 <span class="n">timeseries2</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span>\
                                 <span class="s1">&#39;_coherenceplot&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>     
                                                                           
    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">fig</span>   

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Age model</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Bchron"><a class="viewcode-back" href="../Main.html#pyleoclim.Bchron">[docs]</a><span class="k">def</span> <span class="nf">Bchron</span><span class="p">(</span><span class="n">lipd</span><span class="p">,</span> <span class="n">modelNum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">objectName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rejectAges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
           <span class="n">calCurves</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">predictPositions</span> <span class="o">=</span> <span class="s2">&quot;paleo&quot;</span><span class="p">,</span>\
           <span class="n">positionsThickness</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outlierProbs</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span><span class="mi">1000</span><span class="p">,</span>\
           <span class="n">burn</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">thin</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">extractDate</span> <span class="o">=</span> <span class="mi">1950</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>\
           <span class="n">maxExtrap</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">thetaMhSd</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">muMhSd</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">psiMhSd</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>\
           <span class="n">ageScaleVal</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">positionScaleVal</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">saveLipd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>\
           <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">flipCoor</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">xlabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">xlim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">violinColor</span> <span class="o">=</span> <span class="s1">&#39;#8B008B&#39;</span><span class="p">,</span>\
           <span class="n">medianLineColor</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">medianLineWidth</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>\
           <span class="n">CIFillColor</span> <span class="o">=</span> <span class="s2">&quot;Silver&quot;</span><span class="p">,</span> <span class="n">samplePaths</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">samplePathNumber</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span>\
           <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">saveFig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;eps&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Runs Bchron and plot if asked</span>

<span class="sd">    Fits a non-parametric chronology model to age/position data according to</span>
<span class="sd">    the Compound Poisson-Gamma model defined by Haslett and Parnell (2008).</span>
<span class="sd">    This version used a slightly modified Markov chain Monte-Carlo fitting</span>
<span class="sd">    algorithm which aims to converge quicker and requires fewer iterations.</span>
<span class="sd">    It also a slightly modified procedure for identifying outliers.</span>

<span class="sd">    The Bchronology functions fits a compounf Poisson-Gamma distribution to the</span>
<span class="sd">    incrememnts between the dated levels. This involves a stochastic linear</span>
<span class="sd">    interpolation step where the age gaps are Gamma distributed, and the position</span>
<span class="sd">    gaps are Exponential. Radiocarbon and non-radiocarbon dates (including outliers)</span>
<span class="sd">    are updated within the fucntion also by MCMC.</span>

<span class="sd">    This function also allows to save the ensemble, distributions, and probability</span>
<span class="sd">    tables as well as the parameters with which the model was run into the LiPD file.</span>

<span class="sd">    Finally allows to make a plot.</span>

<span class="sd">    Args:</span>
<span class="sd">        lipd (dict): A dictionary containing the entry of a LiPD file. Can be</span>
<span class="sd">            obtained from lipd.readLipd() or pyleoclim.openLipd(). Please note</span>
<span class="sd">            that the Bchron function currently only allows for a single LiPD file</span>
<span class="sd">            (i.e., not the entire directory).</span>
<span class="sd">        modelNum (int): The model number in which to place the Bchron output.</span>
<span class="sd">            If unknown, the function will try to make a guess and/or prompt</span>
<span class="sd">            based on the number of already available models.</span>
<span class="sd">        objectName (str): The name of the chron object in which to store the new</span>
<span class="sd">            model (e.g. &quot;chron0&quot;)</span>
<span class="sd">        rejectAges (vector): A vector of 1/0 where 1 include the dates to be rejected.</span>
<span class="sd">            Default it None.</span>
<span class="sd">        calCurves (list): (Optional) A vector of values containing either &#39;intcal13&#39;,</span>
<span class="sd">            &#39;marine13&#39;, &#39;shcal13&#39;, or &#39;normal&#39;. If none is provided, will</span>
<span class="sd">            prompt the user. Should be either of length =1 if using the same</span>
<span class="sd">            calibration for each age or the same length as the vector of ages.</span>
<span class="sd">        reservoirAgeCorr (array): (Optional) A list (matrix) of two floats that correspond to the</span>
<span class="sd">            DeltaR and DeltaR uncertainty. If already added to the ages and</span>
<span class="sd">            ages standard deviation, then enter [0,0] to bypass the prompt.</span>
<span class="sd">            Will only be applied if CalCurves is set to &#39;marine13&#39;. Otherwise,</span>
<span class="sd">            leave to none.</span>
<span class="sd">        predictPositions (array): (Optional) a vector of positions</span>
<span class="sd">            (e.g. depths) at which predicted age values are required.</span>
<span class="sd">            Defaults to a sequence of length 100 from the top position to the</span>
<span class="sd">            bottom position.</span>
<span class="sd">        positionsThickness (array): (Optional) Thickness values for each of the positions.</span>
<span class="sd">            The thickness values should be the full thickness value of the</span>
<span class="sd">            slice. By default set to zero.</span>
<span class="sd">        outlierProbs (array): (Optional) A vector of prior outlier probabilities,</span>
<span class="sd">            one for each age. Defaults to 0.01</span>
<span class="sd">        iterations (int): (Optional) The number of iterations to start the procedure.</span>
<span class="sd">            Default and minimum should be 10000.</span>
<span class="sd">        burn (int): (Optional) The number of starting iterations to discard.</span>
<span class="sd">            Default is 200</span>
<span class="sd">        thin (int): (Optional) The step size for every iteration to keep beyond</span>
<span class="sd">            the burnin. Default is 8.</span>
<span class="sd">        extractDate (float): (Optional) The top age of the core. Used for</span>
<span class="sd">            extrapolation purposes so that no extrapolated ages go beyond the</span>
<span class="sd">            top age of the core. Defaults to the current year.</span>
<span class="sd">        maxExtrap (int): (Optional) The maximum number of extrapolations to</span>
<span class="sd">            perform before giving up and setting the predicted ages to NA.</span>
<span class="sd">            Useful for when large amounts of extrapolation are required, i.e.</span>
<span class="sd">            some of the predictPositions are a long way from the dated</span>
<span class="sd">            positions. Defaults to 500.</span>
<span class="sd">        thetaMhSd (float):  (Optional)  The Metropolis-Hastings standard</span>
<span class="sd">            deviation for the age parameters. Defaults to 0.5.</span>
<span class="sd">        muMhSd (float): (Optional)  The Metropolis-Hastings standard deviation</span>
<span class="sd">            for the compound Poisson-Gamma Scale. Defaults to 0.1</span>
<span class="sd">        psiMhSd (float): (Optional) The Metropolis-Hastings standard deviation</span>
<span class="sd">            for the Compound Poisson-Gamma Scale.</span>
<span class="sd">        ageScaleVal (int): (Optional) A scale value for the ages.</span>
<span class="sd">            Bchronology works best when the ages are scaled to be</span>
<span class="sd">            approximately between 0 and 100.</span>
<span class="sd">            The default value is thus 1000 for ages given in years.</span>
<span class="sd">        positionScaleVal (int):  (Optional) A scale value for the positions.</span>
<span class="sd">            Bchronology works best when the positions are scaled to be</span>
<span class="sd">            approximately between 0 and 100. The default value is thus</span>
<span class="sd">            100 for positions given in cm.</span>
<span class="sd">        saveLipd (bool): If True, saves the ensemble, distribution, and probability</span>
<span class="sd">            tables along with the parameters used to run the model in the LiPD</span>
<span class="sd">            file.</span>
<span class="sd">        plot (bool): If True, makes a plot for the chronology</span>
<span class="sd">        figsize (list): The figure size. Default is [4,8]</span>
<span class="sd">        flipCoor (bool): If True, plots depth on the y-axis.</span>
<span class="sd">        xlabel (str): The label for the x-axis</span>
<span class="sd">        ylabel (str): The label for the y-axis</span>
<span class="sd">        xlim (list): Limits for the x-axis. Default corresponds to the min/max</span>
<span class="sd">            of the depth vector.</span>
<span class="sd">        ylim (list): Limits for the y-axis. Default set by matplotlib</span>
<span class="sd">        violinColor (str): The color for the violins. Default is purple</span>
<span class="sd">        medianLineColor (str): The color for the median line. Default is black.</span>
<span class="sd">        medianLineWidth (float): The width for the median line</span>
<span class="sd">        CIFillColor (str): Fill color in between the 95% confidence interval.</span>
<span class="sd">            Default is silver.</span>
<span class="sd">        samplePaths (bool): If True, draws sample paths from the distribution.</span>
<span class="sd">            Use the same color as the violins.</span>
<span class="sd">        samplePathNumber (int): The number of sample paths to draw. Default is 10.</span>
<span class="sd">            Note: samplePaths need to be set to True.</span>
<span class="sd">        alpha (float): The violins&#39; transparency. Number between 0 and 1</span>
<span class="sd">        saveFig (bool): default is to not save the figure</span>
<span class="sd">        dir (str): the full path of the directory in which to save the figure.</span>
<span class="sd">            If not provided, creates a default folder called &#39;figures&#39; in the</span>
<span class="sd">            LiPD working directory (lipd.path).</span>
<span class="sd">        format (str): One of the file extensions supported by the active</span>
<span class="sd">            backend. Default is &quot;eps&quot;. Most backend support png, pdf, ps, eps,</span>
<span class="sd">            and svg.</span>

<span class="sd">    Returns:</span>
<span class="sd">        depth - the predicted positions (either same as the user or the default) \n</span>
<span class="sd">        chron -  a numpy array of possible chronologies in each column.</span>
<span class="sd">            The number of rows is the same as the length of depth</span>
<span class="sd">        ageDist - the distribution of ages around each dates.</span>
<span class="sd">        fig - the figure</span>
<span class="sd">        run - the full R object containing the outputs of the Bchron run</span>

<span class="sd">    Warnings:</span>
<span class="sd">        This function requires R and the Bchron package and all its</span>
<span class="sd">            dependencies to be installed on the same machine.</span>

<span class="sd">    Reference:</span>
<span class="sd">        - Haslett, J., and Parnell, A. C. (2008). A simple monotone</span>
<span class="sd">            process with application to radiocarbon-dated depth</span>
<span class="sd">            chronologies. Journal of the Royal Statistical Society,</span>
<span class="sd">            Series C, 57, 399-418. DOI:10.1111/j.1467-9876.2008.00623.x</span>
<span class="sd">        - Parnell, A. C., Haslett, J., Allen, J. R. M., Buck, C. E.,</span>
<span class="sd">            and Huntley, B. (2008). A flexible approach to assessing</span>
<span class="sd">            synchroneity of past events using Bayesian reconstructions</span>
<span class="sd">            of sedimentation history. Quaternary Science Reviews,</span>
<span class="sd">            27(19-20), 1872-1885. DOI:10.1016/j.quascirev.2008.07.009</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the csv_list</span>
    <span class="n">csv_dict</span> <span class="o">=</span> <span class="n">lpd</span><span class="o">.</span><span class="n">getCsv</span><span class="p">(</span><span class="n">lipd</span><span class="p">)</span>
    <span class="c1"># Get the list of possible measurement tables</span>
    <span class="n">chronMeasurementTables</span><span class="p">,</span> <span class="n">paleoMeasurementTables</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">isMeasurement</span><span class="p">(</span><span class="n">csv_dict</span><span class="p">)</span>
    <span class="c1">#Check that there is a measurement table or exit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">chronMeasurementTables</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No ChronMeasurementTables available to run BChron!&quot;</span><span class="p">)</span>
    <span class="c1"># Selct measurement table</span>
    <span class="n">csvName</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">whichMeasurement</span><span class="p">(</span><span class="n">chronMeasurementTables</span><span class="p">,</span> <span class="n">csv_dict</span><span class="p">)</span>
    <span class="c1"># Get the ts-like object from selected measurement table</span>
    <span class="n">ts_list</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getMeasurement</span><span class="p">(</span><span class="n">csvName</span><span class="p">,</span> <span class="n">lipd</span><span class="p">)</span>
    <span class="c1"># Make sure there is no model associated with the choice</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">modelNum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">objectName</span><span class="p">:</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">objectName</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">isModel</span><span class="p">(</span><span class="n">csvName</span><span class="p">,</span> <span class="n">lipd</span><span class="p">)</span>
        <span class="n">modelNum</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">modelNumber</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">modelNum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">objectName</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;You must provide a dataObject when specifying a model.&quot;</span><span class="p">)</span>
    <span class="c1">## look for the inputs for Bchron</span>
    <span class="c1"># Find an age column</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for age data...&quot;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;radiocarbon&quot;</span><span class="p">,</span><span class="s2">&quot;age14C&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No age data available&quot;</span><span class="p">)</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="c1"># Remove NaNs (can happen in mixed chronologies)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ages</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ages</span> <span class="o">=</span> <span class="n">ages</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">agesUnit</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">agesUnit</span> <span class="o">=</span><span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Age data found.&quot;</span><span class="p">)</span>

    <span class="c1"># Find a depth column</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for a depth/position column...&quot;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;depth&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No age data available&quot;</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">positionsUnits</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">positionsUnits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Depth information found.&quot;</span><span class="p">)</span>

    <span class="c1"># Find the uncertainty</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for age uncertainty...&quot;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">],</span><span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No uncertainty data available&quot;</span><span class="p">)</span>
    <span class="n">agesStd</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="n">agesStd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agesStd</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">agesStd</span> <span class="o">=</span> <span class="n">agesStd</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uncertainty data found.&quot;</span><span class="p">)</span>

    <span class="c1"># See if there is a column of reject ages</span>
    <span class="k">if</span> <span class="n">rejectAges</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for a column of rejected ages...&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;rejectAges&quot;</span><span class="p">],</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No column of rejected ages found.&quot;</span><span class="p">)</span>
            <span class="n">rejectAges</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No ages rejected.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rejectAges</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="n">rejectAges</span> <span class="o">=</span> <span class="n">rejectAges</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rejected ages found.&quot;</span><span class="p">)</span>

    <span class="c1"># Check if there are calibration curves</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">calCurves</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for calibration curves...&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;calCurves&quot;</span><span class="p">],</span> <span class="n">exact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">calCurves</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">chooseCalCurves</span><span class="p">()</span>
            <span class="n">calCurves</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">verifyCalCurves</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">calCurves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">calCurves</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calCurves</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="n">calCurves</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">verifyCalCurves</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">calCurves</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">verifyCalCurves</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span>
        <span class="n">calCurves</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">calCurves</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">calCurves</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">verifyCalCurves</span><span class="p">(</span><span class="n">calCurves</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calibration curves found.&quot;</span><span class="p">)</span>

    <span class="c1">#Check for a reservoir age</span>

    <span class="k">if</span> <span class="n">reservoirAgeCorr</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for a reservoir age correction.&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,</span>\
                                    <span class="p">[</span><span class="s2">&quot;reservoir&quot;</span><span class="p">,</span><span class="s2">&quot;reservoirAge&quot;</span><span class="p">,</span><span class="s2">&quot;correction&quot;</span><span class="p">],</span>\
                                    <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ageCorr</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="n">ageCorr</span> <span class="o">=</span> <span class="n">ageCorr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reservoir Age correction found.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for correction uncertainty...&quot;</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">ts_list</span><span class="p">,[</span><span class="s2">&quot;reservoirUncertainty&quot;</span><span class="p">],</span>\
                                                 <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No match found.&quot;</span><span class="p">)</span>
                <span class="n">corrU</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a value for the correction uncertainty: &quot;</span><span class="p">))</span>
                <span class="n">ageCorrStd</span> <span class="o">=</span> <span class="n">corrU</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ageCorr</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ageCorrStd</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
                <span class="n">ageCorrStd</span> <span class="o">=</span> <span class="n">ageCorrStd</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No match found.&quot;</span><span class="p">)</span>
            <span class="n">ageCorr</span><span class="p">,</span> <span class="n">ageCorrStd</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">reservoirAgeCorrection</span><span class="p">()</span>
        <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">ageCorr</span><span class="p">,</span><span class="n">ageCorrStd</span><span class="p">))</span>
        <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">reservoirAgeCorr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">reservoirAgeCorr</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ageCorr</span><span class="p">,</span> <span class="n">ageCorrStd</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">reservoirAgeCorrection</span><span class="p">()</span>
        <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">ageCorr</span><span class="p">,</span><span class="n">ageCorrStd</span><span class="p">))</span>
        <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">reservoirAgeCorr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">reservoirAgeCorr</span><span class="p">)</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">reservoirAgeCorr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reservoirAgeCorr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;The reservoir age correction should be either None, True or an array.&quot;</span><span class="p">)</span>

    <span class="c1">#Predict positions</span>
    <span class="k">if</span> <span class="n">predictPositions</span> <span class="o">==</span> <span class="s2">&quot;paleo&quot;</span><span class="p">:</span>
        <span class="c1"># Grab the paleomeasurementTables</span>
        <span class="n">paleoCsvName</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">whichMeasurement</span><span class="p">(</span><span class="n">paleoMeasurementTables</span><span class="p">,</span> <span class="n">csv_dict</span><span class="p">)</span>
        <span class="c1"># Get the various timeseries</span>
        <span class="n">paleots_list</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">getMeasurement</span><span class="p">(</span><span class="n">paleoCsvName</span><span class="p">,</span> <span class="n">lipd</span><span class="p">)</span>
        <span class="c1">#Look for a depth column</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">LipdUtils</span><span class="o">.</span><span class="n">searchVar</span><span class="p">(</span><span class="n">paleots_list</span><span class="p">,[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span> <span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No paleoDepth information available, using Bchron default&quot;</span><span class="p">)</span>
            <span class="n">predictPositions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictPositions</span> <span class="o">=</span> <span class="n">paleots_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;units&quot;</span> <span class="ow">in</span> <span class="n">paleots_list</span><span class="p">[</span><span class="n">match</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">predictPositionsUnits</span> <span class="o">=</span> <span class="n">paleots_list</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predictPositionsUnits</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Raise an error if the depth units don&#39;t correspond</span>
    <span class="k">if</span> <span class="n">predictPositionsUnits</span> <span class="ow">and</span> <span class="n">positionsUnits</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predictPositionsUnits</span> <span class="o">!=</span> <span class="n">positionsUnits</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Depth units in the paleoData table and the chronData table don&#39;t match!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PaleoDepth are expressed in &quot;</span><span class="o">+</span><span class="n">predictPositionsUnits</span><span class="o">+</span>\
                  <span class="s2">&quot; while ChronDepth is expressed in &quot;</span><span class="o">+</span><span class="n">positionsUnits</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter a correction value to bring Chron to Paleo scale&quot;</span><span class="o">+</span>\
                                 <span class="s2">&quot; or press Enter to exit.&quot;</span><span class="o">+</span>\
                                 <span class="s2">&quot; Enter 1 if the units are in fact the same but&quot;</span><span class="o">+</span>\
                                 <span class="s2">&quot; written differently (e.g., m vs meter): &quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">factor</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No correction factor entered.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">*</span><span class="n">factor</span>

    <span class="c1"># Run Bchron</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running Bchron. This could take a few minutes...&quot;</span><span class="p">)</span>
    <span class="n">depth</span><span class="p">,</span> <span class="n">chron</span><span class="p">,</span> <span class="n">ageDist</span><span class="p">,</span> <span class="n">run</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">runBchron</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">agesStd</span><span class="p">,</span><span class="n">positions</span><span class="p">,</span>\
                                                    <span class="n">rejectAges</span> <span class="o">=</span> <span class="n">rejectAges</span><span class="p">,</span>\
                                                    <span class="n">calCurves</span> <span class="o">=</span> <span class="n">calCurves</span><span class="p">,</span>\
                                                    <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">reservoirAgeCorr</span><span class="p">,</span>\
                                                    <span class="n">predictPositions</span> <span class="o">=</span> <span class="n">predictPositions</span><span class="p">,</span>
                                                    <span class="n">positionsThickness</span><span class="o">=</span> <span class="n">positionsThickness</span><span class="p">,</span>\
                                                    <span class="n">outlierProbs</span><span class="o">=</span><span class="n">outlierProbs</span><span class="p">,</span>\
                                                    <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span>\
                                                    <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="n">thin</span><span class="p">,</span>\
                                                    <span class="n">extractDate</span><span class="o">=</span><span class="n">extractDate</span><span class="p">,</span>\
                                                    <span class="n">maxExtrap</span><span class="o">=</span><span class="n">maxExtrap</span><span class="p">,</span>\
                                                    <span class="n">thetaMhSd</span> <span class="o">=</span> <span class="n">thetaMhSd</span><span class="p">,</span>\
                                                    <span class="n">muMhSd</span><span class="o">=</span><span class="n">muMhSd</span><span class="p">,</span><span class="n">psiMhSd</span> <span class="o">=</span> <span class="n">psiMhSd</span><span class="p">,</span>\
                                                    <span class="n">ageScaleVal</span><span class="o">=</span><span class="n">ageScaleVal</span><span class="p">,</span>\
                                                    <span class="n">positionScaleVal</span> <span class="o">=</span><span class="n">positionScaleVal</span><span class="p">)</span>

    <span class="c1">## Write into the LiPD file is asked</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Placing all the tables in the LiPD object...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">lipd</span><span class="p">[</span><span class="s2">&quot;chronData&quot;</span><span class="p">][</span><span class="n">objectName</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">lipd</span><span class="p">[</span><span class="s2">&quot;chronData&quot;</span><span class="p">][</span><span class="n">objectName</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">lipd</span><span class="p">[</span><span class="s2">&quot;chronData&quot;</span><span class="p">][</span><span class="n">objectName</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;model&quot;</span><span class="p">:{}})</span>
    <span class="c1">#Grab the part of the LiPD dictionary with the chronObject/model</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">lipd</span><span class="p">[</span><span class="s2">&quot;chronData&quot;</span><span class="p">][</span><span class="n">objectName</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

    <span class="c1">## methods</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;calCurves&quot;</span><span class="p">:</span><span class="n">calCurves</span><span class="p">,</span>
            <span class="s2">&quot;iterations&quot;</span><span class="p">:</span><span class="n">iterations</span><span class="p">,</span>
            <span class="s2">&quot;burn&quot;</span><span class="p">:</span><span class="n">burn</span><span class="p">,</span>
            <span class="s2">&quot;thin&quot;</span><span class="p">:</span><span class="n">thin</span><span class="p">,</span>
            <span class="s2">&quot;extractDate&quot;</span><span class="p">:</span><span class="n">extractDate</span><span class="p">,</span>
            <span class="s2">&quot;maxExtrap&quot;</span><span class="p">:</span> <span class="n">maxExtrap</span><span class="p">,</span>
            <span class="s2">&quot;thetaMhSd&quot;</span><span class="p">:</span> <span class="n">thetaMhSd</span><span class="p">,</span>
            <span class="s2">&quot;muMhSd&quot;</span><span class="p">:</span><span class="n">muMhSd</span><span class="p">,</span>
            <span class="s2">&quot;psiMhSd&quot;</span><span class="p">:</span><span class="n">psiMhSd</span><span class="p">,</span>
            <span class="s2">&quot;ageScaleVal&quot;</span><span class="p">:</span><span class="n">ageScaleVal</span><span class="p">,</span>
            <span class="s2">&quot;positionScaleVal&quot;</span><span class="p">:</span><span class="n">positionScaleVal</span><span class="p">}</span>

    <span class="c1"># Other None objects</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">reservoirAgeCorr</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">reservoirAgeCorr</span> <span class="o">=</span> <span class="n">reservoirAgeCorr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;reservoirAgeCorr&quot;</span><span class="p">:</span><span class="n">reservoirAgeCorr</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;reservoirAgeCorr&quot;</span><span class="p">:</span><span class="s2">&quot;Not provided&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rejectAges</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">rejectAges</span> <span class="o">=</span> <span class="n">rejectAges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rejectAges&quot;</span><span class="p">:</span><span class="n">rejectAges</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rejectAges&quot;</span><span class="p">:</span><span class="s2">&quot;Not provided&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">positionsThickness</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">positionsThickness</span> <span class="o">=</span> <span class="n">positionsThickness</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;positionsThickness&quot;</span><span class="p">:</span><span class="n">positionsThickness</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;positionsThickness&quot;</span><span class="p">:</span><span class="s2">&quot;Not provided&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">outlierProbs</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">outlierProbs</span> <span class="o">=</span> <span class="n">outlierProbs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;outlierProbs&quot;</span><span class="p">:</span><span class="n">outlierProbs</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;outlierProbs&quot;</span><span class="p">:</span><span class="s2">&quot;Not provided&quot;</span><span class="p">})</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;algorithm&quot;</span><span class="p">:</span><span class="s2">&quot;Bchron&quot;</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span><span class="n">inputs</span><span class="p">,</span><span class="s2">&quot;runEnv&quot;</span><span class="p">:</span><span class="s2">&quot;python&quot;</span><span class="p">}</span>

    <span class="c1">#create the key for the new model</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">objectName</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;model&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">modelNum</span><span class="p">)</span>
    <span class="c1"># Add the method to object</span>
    <span class="n">T</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:{}})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="n">methods</span><span class="p">})</span>

    <span class="c1">##EnsembleTable</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ensembleTable&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
    <span class="n">key_ens</span> <span class="o">=</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot;ensemble0&quot;</span> <span class="c1"># Key for the ensemble table</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ensembleTable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key_ens</span><span class="p">:{}})</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c1">#RESET VERY IMPORTANT</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ensembleTable&quot;</span><span class="p">][</span><span class="n">key_ens</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>

    <span class="c1">#store age and depth info</span>
    <span class="n">number_age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">chron</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">number_age</span> <span class="o">=</span> <span class="n">number_age</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">chron_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">chron</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">age_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="n">number_age</span><span class="p">,</span>
                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                <span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>
                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">chron_list</span><span class="p">}</span>
    <span class="n">depth_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">predictPositionsUnits</span><span class="p">,</span>
                  <span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">depth</span><span class="p">}</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ensembleTable&quot;</span><span class="p">][</span><span class="n">key_ens</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span><span class="n">depth_dict</span><span class="p">})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;ensembleTable&quot;</span><span class="p">][</span><span class="n">key_ens</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="n">age_dict</span><span class="p">})</span>

    <span class="c1">## Summary Table</span>
    <span class="c1"># First calculate some summary stats</span>
    <span class="n">quant</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">chron</span><span class="p">,[</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.975</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Save as list for JSON</span>
    <span class="n">lower95</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">medianAge</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">upper95</span> <span class="o">=</span> <span class="n">quant</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">meanVal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">chron</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">meanVal</span> <span class="o">=</span> <span class="n">meanVal</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># Put everything where it belongs</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
    <span class="n">key_sum</span> <span class="o">=</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot;summary0&quot;</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key_sum</span><span class="p">:{}})</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>
    <span class="c1"># Place each column as separate dictionary</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;depth&quot;</span><span class="p">:{</span><span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">predictPositionsUnits</span><span class="p">,</span>
                                                                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">depth</span><span class="p">,</span>
                                                                <span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;meanAge&quot;</span><span class="p">:{</span><span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;meanAge&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                                                                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">meanVal</span><span class="p">,</span>
                                                                <span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;medianAge&quot;</span><span class="p">:{</span><span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;medianAge&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                                                                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">medianAge</span><span class="p">,</span>
                                                                <span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">}})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;95Lower&quot;</span><span class="p">:{</span><span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;95Lower&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                                                                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">lower95</span><span class="p">,</span>
                                                                <span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">}})</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;summaryTable&quot;</span><span class="p">][</span><span class="n">key_sum</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;95Higher&quot;</span><span class="p">:{</span><span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;95Higher&quot;</span><span class="p">,</span>
                                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                                                                <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="n">upper95</span><span class="p">,</span>
                                                                <span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">}})</span>

    <span class="c1">## DistributionTables</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;distributionTable&quot;</span><span class="p">:</span> <span class="n">d</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ageDist</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1">#Get the output in list form</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">key_dist</span> <span class="o">=</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot;distribution&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;distributionTable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key_dist</span><span class="p">:{}})</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;distributionTable&quot;</span><span class="p">][</span><span class="n">key_dist</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;age14C&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="s2">&quot;calibrationCurve&quot;</span><span class="p">:</span><span class="n">calCurves</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                     <span class="s2">&quot;columns&quot;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span>
                                                     <span class="s2">&quot;depth&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="s2">&quot;depthUnits&quot;</span><span class="p">:</span><span class="n">predictPositionsUnits</span><span class="p">,</span>
                                                     <span class="s2">&quot;sd14C&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="n">age_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;age&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;units&quot;</span><span class="p">:</span><span class="n">agesUnit</span><span class="p">,</span>
                    <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">])}</span>
        <span class="n">density_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;variableName&quot;</span><span class="p">:</span><span class="s2">&quot;probabilityDensity&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;values&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">run</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">])}</span>

        <span class="n">T</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;distributionTable&quot;</span><span class="p">][</span><span class="n">key_dist</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="n">age_dict</span><span class="p">,</span>
                                                                 <span class="s2">&quot;probabilityDensity&quot;</span><span class="p">:</span><span class="n">density_dict</span><span class="p">})</span>
        <span class="c1">## Finally write it out</span>
    <span class="k">if</span> <span class="n">saveLipd</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing LiPD file...&quot;</span><span class="p">)</span>
        <span class="n">lpd</span><span class="o">.</span><span class="n">writeLipd</span><span class="p">(</span><span class="n">lipd</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="c1">#Plot if asked</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flipCoor</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictPositionsUnits</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Depth (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">predictPositionsUnits</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Depth&quot;</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agesUnit</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Age (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">agesUnit</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xlabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictPositionsUnits</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Depth (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">predictPositionsUnits</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Depth&quot;</span>
            <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agesUnit</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Age (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">agesUnit</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">RBchron</span><span class="o">.</span><span class="n">plotBchron</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span><span class="n">chron</span><span class="p">,</span><span class="n">positions</span><span class="p">,</span><span class="n">ageDist</span><span class="p">,</span> <span class="n">flipCoor</span><span class="o">=</span><span class="n">flipCoor</span><span class="p">,</span>\
                                 <span class="n">xlabel</span> <span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>\
                                 <span class="n">xlim</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">,</span>\
                                 <span class="n">violinColor</span> <span class="o">=</span> <span class="n">violinColor</span><span class="p">,</span>\
                                 <span class="n">medianLineColor</span> <span class="o">=</span> <span class="n">medianLineColor</span><span class="p">,</span>\
                                 <span class="n">medianLineWidth</span> <span class="o">=</span> <span class="n">medianLineWidth</span><span class="p">,</span>\
                                 <span class="n">CIFillColor</span> <span class="o">=</span> <span class="n">CIFillColor</span><span class="p">,</span>\
                                 <span class="n">samplePaths</span> <span class="o">=</span> <span class="n">samplePaths</span><span class="p">,</span>\
                                 <span class="n">samplePathNumber</span> <span class="o">=</span> <span class="n">samplePathNumber</span><span class="p">,</span>
                                 <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">saveFig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">LipdUtils</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span><span class="n">lipd</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_Bchron&#39;</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">,</span> <span class="n">chron</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">ageDist</span><span class="p">,</span> <span class="n">fig</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Deborah Khider, Feng Zhu, Julien Emile-Geay

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>